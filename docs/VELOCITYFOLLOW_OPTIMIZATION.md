# VelocityFollow 策略优化总结

## 问题分析

根据日志分析，发现了以下主要问题：

### 1. Duplicate In-Flight 错误（179次）
**问题根源**：
- 策略在价格变化时频繁触发（约50次触发）
- 虽然有 `CooldownMs` 和 `OncePerCycle` 保护，但策略在同一方向（up/down）上会连续触发
- ExecutionEngine 的去重 key 基于完整的订单参数，但策略在短时间内可能生成相同方向的订单
- 去重 TTL 为 10 秒，但策略可能在 10 秒内多次触发同一方向

### 2. 订单匹配失败警告
**问题根源**：
- 订单状态同步时，订单已经通过 WebSocket 更新为 filled，但系统仍在尝试匹配
- 匹配失败时记录为 WARN 级别，产生大量日志噪音

## 优化方案

### 1. 策略层优化：增加方向级别的去重检查

**文件**：`internal/strategies/velocityfollow/strategy.go`

**改动**：
- 新增 `lastTriggerSide` 和 `lastTriggerSideAt` 字段，记录上次触发的方向和时间
- 在确定 `winner` 后，检查同一方向是否在冷却期内
- 如果同一方向在冷却期内，直接跳过，避免重复下单

**效果**：
- 显著减少同一方向的重复触发
- 减少 duplicate in-flight 错误
- 保持策略对价格变化的敏感度（不同方向仍可快速切换）

### 2. ExecutionEngine 优化：改进去重 key 计算

**文件**：`internal/execution/engine.go`

**改动**：
- 优化 `computeInFlightKey` 函数
- 优先使用入场订单（FAK 订单）作为主要标识
- 价格取整到 1 cent，允许小幅价格波动（避免因价格微小变化导致的重复下单）
- 如果找不到入场订单，回退到原来的完整参数匹配逻辑

**效果**：
- 更精确的去重：相同方向、相似价格的订单会被去重
- 允许价格变化：价格有明显变化时仍可下单
- 减少误判：避免因价格微小差异导致的重复下单

### 3. 订单匹配逻辑优化：减少误报

**文件**：`internal/services/trading_sync.go`

**改动**：
- 在记录匹配失败警告前，检查订单状态
- 如果订单已经通过 WebSocket 更新为 filled 或 canceled，不记录匹配失败警告
- 将匹配失败的日志级别从 WARN 降级为 DEBUG，减少日志噪音

**效果**：
- 减少误报：已成交订单不再记录匹配失败
- 降低日志噪音：匹配失败日志降级为 DEBUG
- 保持准确性：真正需要关注的匹配失败仍会记录

## 预期效果

### 1. Duplicate In-Flight 错误
- **优化前**：179 次错误
- **优化后**：预计减少 80-90%，主要保留真正需要去重的情况

### 2. 订单匹配失败警告
- **优化前**：大量 WARN 级别日志
- **优化后**：已成交订单不再记录，真正需要关注的匹配失败降级为 DEBUG

### 3. 策略执行效率
- **优化前**：频繁触发导致大量重复下单被拒绝
- **优化后**：方向级别的去重确保每个方向在冷却期内只触发一次，提高执行效率

## 配置建议

### CooldownMs 配置
- 建议值：2000-3000ms（2-3秒）
- 过短：可能导致重复触发
- 过长：可能错过交易机会

### 方向级别冷却
- 默认使用 `CooldownMs` 的值
- 如果 `CooldownMs` 未设置，默认使用 2 秒
- 这确保了同一方向在短时间内不会重复触发

## 测试建议

1. **运行策略并观察日志**：
   - 检查 duplicate in-flight 错误是否显著减少
   - 检查订单匹配失败警告是否减少

2. **验证策略行为**：
   - 确认策略仍能正常触发
   - 确认不同方向可以快速切换
   - 确认价格变化时仍能及时响应

3. **监控指标**：
   - 策略触发次数
   - 成功下单次数
   - duplicate in-flight 错误次数
   - 订单匹配失败次数

## 代码变更总结

### 新增字段
- `Strategy.lastTriggerSide`：记录上次触发的方向
- `Strategy.lastTriggerSideAt`：记录上次触发的时间

### 修改的函数
1. `Strategy.OnCycle`：重置方向级别的去重状态
2. `Strategy.OnPriceChanged`：增加方向级别的去重检查
3. `computeInFlightKey`：优化去重 key 计算逻辑
4. `OrderSyncService.syncAllOrderStatusImpl`：优化订单匹配失败日志

### 向后兼容性
- 所有改动都是向后兼容的
- 新增字段有合理的默认值
- 如果配置未设置，使用合理的默认值

## 后续优化建议

1. **动态调整冷却时间**：
   - 根据市场波动性动态调整冷却时间
   - 高波动时缩短冷却时间，低波动时延长

2. **更智能的去重**：
   - 考虑订单大小和价格变化幅度
   - 价格变化超过阈值时允许重复下单

3. **监控和告警**：
   - 添加指标监控 duplicate in-flight 错误率
   - 设置告警阈值，及时发现异常

