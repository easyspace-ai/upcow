# Adaptive 策略总结（Bot v5.1 复刻）

## 策略概述

Adaptive 策略是一个**自适应定价做市策略**，通过数学模型和市场数据融合来动态定价，在 UP/DOWN 市场中同时提供流动性（Maker）和主动交易（Taker），并根据剩余时间和持仓情况动态调整交易行为。

## 核心思想

1. **模型定价**：基于 Delta（期货价格 - 行权价）和剩余时间，使用正态分布模型预测 UP 的概率
2. **市场融合**：70% 权重跟随市场价，30% 权重使用模型价，平衡模型预测和市场共识
3. **库存管理**：根据净持仓动态调整报价，避免单边敞口过大
4. **分级熔断**：随着周期临近结束，逐步收紧交易条件，最终强制平仓

## 关键组件

### 1. 定价模型

```
Delta = Binance期货价格 - Strike Price（行权价）
rawX = Delta / sqrt(剩余时间)
z = k * rawX + c
模型概率 = NormCdf(z)  // 正态分布累积分布函数
```

**参数说明**：
- `k = 0.08`：Delta 的敏感度系数
- `c = 0.10`：基础偏移量
- `NormCdf`：标准正态分布的累积分布函数

### 2. 市场融合

```
市场中枢 = (买一价 + 卖一价) / 2
最终概率 = 30% * 模型概率 + 70% * 市场中枢
```

### 3. 库存偏斜

```
净持仓 = UP持仓 - DOWN持仓
偏斜 = 净持仓 * 库存偏斜因子（0.00005）
最终报价 = 最终概率 - 偏斜
```

**逻辑**：
- 如果净持仓 > 0（持有多头），降低 UP 的买入价，避免继续加仓
- 如果净持仓 < 0（持有空头），降低 DOWN 的买入价

### 4. 动态 Maker Edge

随着周期临近结束，Maker 订单要求更高的利润：

```
如果 剩余时间 > 300秒：
    Maker Edge = 基础值（0.05%）
否则：
    Maker Edge = 基础值 + (最大边距 - 基础值) * 进度
    其中 进度 = (300 - 剩余时间) / 300
    最大边距 = 2%（结束时）
```

### 5. 分级熔断机制

| 阶段 | 剩余时间 | 行为 |
|------|---------|------|
| **正常期** | > 300秒 | 正常交易，可以加仓 |
| **减仓期** | < 300秒 | 只减不加，只能平仓 |
| **强制平仓期** | < 180秒 | 强制平仓，避免带仓进入结算 |

### 6. 交易决策逻辑

#### 优先级顺序：

1. **强制平仓**（最高优先级）
   - 条件：剩余时间 < 180秒 且 净持仓绝对值 >= 5
   - 行为：Taker 买入反向 token 平仓

2. **风控对冲**
   - 条件：净持仓绝对值 > 80（阈值）
   - 行为：Taker 买入反向 token，数量 = 正常交易量 * 1.5

3. **正常交易**
   - **Taker**：市场 ask < 保留价格 - Taker边距（0.3%）
   - **Maker**：挂单价 < 保留价格 - 动态Maker边距
   - 挂单价 = 市场买一价 + 0.001（压价一档）

#### 交易限制：

- **减仓期限制**：
  - UP 方向：只能买入 UP 当净持仓 < 0（平空头）
  - DOWN 方向：只能买入 DOWN 当净持仓 > 0（平多头）

- **库存限制**：
  - UP 方向：净持仓 < 60 时才报价
  - DOWN 方向：净持仓 > -60 时才报价

## 数据源

1. **Binance 期货价格**：通过 RTDS 订阅 `btcusdt`，用于计算 Delta
2. **Chainlink 价格**：通过 RTDS 订阅 `btc/usd`，作为 Strike Price 的兜底
3. **Strike Price**：通过 API 获取官方行权价，最多重试 20 次
4. **市场盘口**：通过 PriceChangedEvent 获取 UP/DOWN 的 bid/ask

## 订单管理

### Maker 订单
- **类型**：GTC（Good Till Cancel）
- **管理**：每个方向只保留一个 Maker 订单
- **成交检测**：市场 ask <= 挂单价时判定成交
- **撤单重挂**：每次新信号时，先撤掉旧订单再挂新订单

### Taker 订单
- **类型**：FAK（Fill And Kill）
- **行为**：立即成交，不挂单

## 参数配置

| 参数 | 默认值 | 说明 |
|------|--------|------|
| k | 0.08 | 定价模型敏感度 |
| c | 0.10 | 定价模型偏移量 |
| sizePerTrade | 12 | 每次交易数量（shares） |
| inventorySkewFactor | 0.00005 | 库存偏斜因子 |
| baseMinEdgeMaker | 0.0005 | Maker 基础边距（0.05%） |
| baseMinEdgeTaker | 0.003 | Taker 基础边距（0.30%） |
| marketWeight | 0.7 | 市场权重（70%） |
| decayStartTime | 300 | 开始衰减时间（秒） |
| reduceOnlyTime | 300 | 只减不加时间（秒） |
| forceCloseTime | 180 | 强制平仓时间（秒） |
| maxEdgeAtZero | 0.02 | 结束时最大边距（2%） |
| hedgeThreshold | 80 | 对冲阈值 |
| stopQuoteThreshold | 60 | 停止报价阈值 |
| hedgeSizeMultiplier | 1.5 | 对冲数量倍数 |

## 策略特点

### 优势
1. **自适应定价**：结合模型和市场，动态调整报价
2. **风险控制**：分级熔断机制，避免带仓进入结算
3. **库存管理**：根据持仓动态调整，避免单边敞口过大
4. **流动性提供**：Maker 订单提供流动性，赚取价差

### 适用场景
- **15分钟周期市场**：BTC UP/DOWN 市场
- **低手续费环境**：Maker 订单需要频繁撤单重挂
- **高流动性市场**：需要足够的买卖盘口

### 风险提示
1. **模型风险**：定价模型可能失效，需要持续监控
2. **滑点风险**：Taker 订单可能面临滑点
3. **流动性风险**：Maker 订单可能无法及时成交
4. **技术风险**：网络延迟、API 故障等

