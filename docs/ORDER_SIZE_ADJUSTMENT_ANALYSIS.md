# 订单数量调整机制分析

## 📋 问题背景

由于 Polymarket 交易所要求**每笔订单金额必须 ≥ $1.0 USDC**（配置中设置为 `minOrderSize: 1.1`），当价格较低时，系统会自动增加订单数量以满足最小金额要求。

## 🔍 实际案例分析

### UP 交易（15¢ 触发）

**配置参数**:
- `orderSize: 4` shares
- 触发价格: 15¢

**计算过程**:
```
原始金额 = 4 × 0.15 = $0.60
minOrderSize = $1.1
$0.60 < $1.1 ❌ 需要调整

调整后数量 = $1.1 / 0.15 = 7.33 shares
调整倍数 = 7.33 / 4 = 1.83x
实际成本 = 7.33 × 0.15 = $1.10 ✅
```

**结果**: 
- 数量: 7.33 shares（从 4 调整到 7.33）
- 成本: $1.10
- 调整倍数: 1.83x

### DOWN 交易（82¢ 触发）

**配置参数**:
- `orderSize: 4` shares
- 触发价格: 82¢

**计算过程**:
```
原始金额 = 4 × 0.82 = $3.28
minOrderSize = $1.1
$3.28 > $1.1 ✅ 无需调整

实际数量 = 4 shares（保持原配置）
实际成本 = 4 × 0.82 = $3.28 ✅
```

**结果**:
- 数量: 4 shares（保持原配置）
- 成本: $3.28
- 调整倍数: 1.0x（无调整）

## 📊 成本对比

| 交易方向 | 触发价格 | 配置数量 | 实际数量 | 调整倍数 | 实际成本 |
|---------|---------|---------|---------|---------|---------|
| **UP** | 15¢ | 4 shares | **7.33 shares** | 1.83x | **$1.10** |
| **DOWN** | 82¢ | 4 shares | **4 shares** | 1.0x | **$3.28** |

**成本差异**: DOWN 成本是 UP 成本的 **2.98 倍**

## ⚠️ 问题分析

### 1. 成本不平衡

由于价格差异和最小金额约束：
- **UP 交易**: 低价触发（15¢）→ 自动增加数量 → 成本 $1.10
- **DOWN 交易**: 高价触发（82¢）→ 保持原数量 → 成本 $3.28

这导致两边成本严重不平衡，DOWN 交易的风险和成本远高于 UP 交易。

### 2. 风险不对称

- **UP 交易**: 成本低（$1.10），收益高（+$2.38，+216.66%）✅
- **DOWN 交易**: 成本高（$3.28），收益低（-$1.18，-35.97%）❌

### 3. 数量差异

- **UP**: 7.33 shares（自动调整）
- **DOWN**: 4 shares（保持原配置）

数量差异进一步放大了成本不平衡。

## 💡 解决方案建议

### 方案 1: 基于成本的下单逻辑

调整策略，确保 UP 和 DOWN 的成本相近：

```yaml
velocityfollow:
  orderSize: 4
  # 新增：目标成本（USDC）
  targetOrderCost: 1.5  # 目标单边成本
  # 新增：是否基于成本计算数量
  sizeByCost: true
```

**逻辑**:
- 如果 `sizeByCost: true`，根据触发价格和目标成本计算实际数量
- `实际数量 = targetOrderCost / 触发价格`
- 确保两边成本相近

### 方案 2: 价格上限限制

避免在过高价格买入，降低 DOWN 交易成本：

```yaml
velocityfollow:
  orderSize: 4
  # 现有配置
  maxEntryPriceCents: 95
  # 新增：价格上限（避免在过高价格买入）
  maxPreferredPriceCents: 70  # 如果价格 > 70c，减少下单数量或跳过
```

### 方案 3: 动态数量调整

根据价格动态调整数量，确保成本平衡：

```go
// 伪代码
func calculateOrderSize(priceCents int, targetCost float64) float64 {
    // 计算目标数量
    targetSize := targetCost / (float64(priceCents) / 100.0)
    
    // 确保满足 minOrderSize
    minSize := minOrderSize / (float64(priceCents) / 100.0)
    
    // 取较大值
    return max(targetSize, minSize)
}
```

### 方案 4: 成本均衡策略

在策略层面，确保 UP 和 DOWN 的成本相近：

```yaml
velocityfollow:
  orderSize: 4
  # 新增：成本均衡模式
  balanceCost: true
  # 目标单边成本（USDC）
  targetCostPerSide: 1.5
```

**逻辑**:
1. 计算 UP 触发时的成本
2. 如果 DOWN 也触发，调整 DOWN 的数量，使成本与 UP 相近
3. 或者，如果价格差异过大，只选择成本较低的一边

## 📈 预期效果

### 当前情况
- UP 成本: $1.10 (7.33 shares @ 15¢)
- DOWN 成本: $3.28 (4 shares @ 82¢)
- 成本比: 1:2.98

### 优化后（假设目标成本 $1.5）
- UP 成本: $1.5 (10 shares @ 15¢)
- DOWN 成本: $1.5 (1.83 shares @ 82¢，但受 minShareSize 限制)
- 成本比: 1:1 ✅

## 🎯 推荐方案

**推荐使用方案 1 + 方案 2 组合**:

1. **添加价格上限**: 避免在过高价格（> 70c）买入
2. **基于成本计算数量**: 确保两边成本相近

这样可以：
- ✅ 降低 DOWN 交易成本
- ✅ 平衡 UP 和 DOWN 的风险
- ✅ 提高整体收益稳定性

---

**报告生成时间**: 2025-12-25  
**问题**: 最小下单金额导致 UP/DOWN 成本不平衡

