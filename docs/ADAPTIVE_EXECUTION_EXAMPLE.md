# Adaptive 策略执行过程示例

## 场景设定

- **市场**：BTC UP/DOWN 15分钟周期市场
- **周期开始时间**：2025-01-20 10:00:00（Unix: 1737352800）
- **周期长度**：900秒（15分钟）
- **Strike Price**：$95,000（已获取）
- **初始持仓**：UP: 0, DOWN: 0

## 执行时间线

### T+0秒：周期开始

**市场状态**：
- Binance 期货价格：$95,200
- Chainlink 价格：$95,100
- UP bid: 0.52, ask: 0.54
- DOWN bid: 0.46, ask: 0.48

**策略计算**：
```
剩余时间 = 900秒
Delta = 95,200 - 95,000 = 200
rawX = 200 / sqrt(900) = 200 / 30 = 6.67
z = 0.08 * 6.67 + 0.10 = 0.6336
模型概率 = NormCdf(0.6336) ≈ 0.737（73.7%）

市场中枢 = (0.52 + 0.54) / 2 = 0.53
最终概率 = 0.3 * 0.737 + 0.7 * 0.53 = 0.592（59.2%）

净持仓 = 0 - 0 = 0
偏斜 = 0 * 0.00005 = 0
最终报价 UP = 0.592 - 0 = 0.592
最终报价 DOWN = 0.408 + 0 = 0.408

动态Maker Edge = 0.0005（基础值）
```

**决策**：
- 模式：NORMAL（正常期）
- UP Taker：0.54 < 0.592 - 0.003 = 0.589？否
- UP Maker：0.52 + 0.001 = 0.521 < 0.592 - 0.0005 = 0.5915？是
- **动作**：挂 Maker 买单 UP @ 0.521，数量 12 shares

**执行**：
```
⚡ [adaptive] 挂单 [MAKER] Buy UP @ 0.521 (Size: 12.00) | Rem: 900.0s
```

---

### T+30秒：价格波动

**市场状态**：
- Binance 期货价格：$95,150（下跌）
- UP bid: 0.50, ask: 0.52
- DOWN bid: 0.48, ask: 0.50

**策略计算**：
```
剩余时间 = 870秒
Delta = 95,150 - 95,000 = 150
rawX = 150 / sqrt(870) ≈ 5.08
z = 0.08 * 5.08 + 0.10 = 0.5064
模型概率 = NormCdf(0.5064) ≈ 0.694（69.4%）

市场中枢 = (0.50 + 0.52) / 2 = 0.51
最终概率 = 0.3 * 0.694 + 0.7 * 0.51 = 0.565（56.5%）

净持仓 = 0（Maker订单未成交）
最终报价 UP = 0.565
最终报价 DOWN = 0.435

动态Maker Edge = 0.0005
```

**决策**：
- UP Maker 订单：市场 ask = 0.52 <= 挂单价 0.521？是
- **检测到成交**：✅ MAKER 成交: Buy UP @ 0.521
- 新挂单价：0.50 + 0.001 = 0.501 < 0.565 - 0.0005 = 0.5645？是
- **动作**：撤旧订单，挂新 Maker 买单 UP @ 0.501

**执行**：
```
✅ [adaptive] MAKER 成交检测: Buy UP @ 0.521 (OrderID: order_123)
❌ [adaptive] 撤单: UP @ @0.521 (OrderID: order_123)
⚡ [adaptive] 挂单 [MAKER] Buy UP @ 0.501 (Size: 12.00) | Rem: 870.0s
```

**持仓更新**：
- UP: 12 shares
- DOWN: 0 shares
- 净持仓: +12

---

### T+120秒：价格反弹

**市场状态**：
- Binance 期货价格：$95,300（上涨）
- UP bid: 0.55, ask: 0.57
- DOWN bid: 0.43, ask: 0.45

**策略计算**：
```
剩余时间 = 780秒
Delta = 95,300 - 95,000 = 300
rawX = 300 / sqrt(780) ≈ 10.73
z = 0.08 * 10.73 + 0.10 = 0.9584
模型概率 = NormCdf(0.9584) ≈ 0.831（83.1%）

市场中枢 = (0.55 + 0.57) / 2 = 0.56
最终概率 = 0.3 * 0.831 + 0.7 * 0.56 = 0.641（64.1%）

净持仓 = 12 - 0 = 12
偏斜 = 12 * 0.00005 = 0.0006
最终报价 UP = 0.641 - 0.0006 = 0.6404
最终报价 DOWN = 0.359 + 0.0006 = 0.3596

动态Maker Edge = 0.0005
```

**决策**：
- UP Maker 订单：市场 ask = 0.57 > 挂单价 0.501？是，未成交
- UP Taker：0.57 < 0.6404 - 0.003 = 0.6374？否
- UP Maker：0.55 + 0.001 = 0.551 < 0.6404 - 0.0005 = 0.6399？是
- **动作**：撤旧订单，挂新 Maker 买单 UP @ 0.551

**执行**：
```
❌ [adaptive] 撤单: UP @ @0.501 (OrderID: order_124)
⚡ [adaptive] 挂单 [MAKER] Buy UP @ 0.551 (Size: 12.00) | Rem: 780.0s
```

---

### T+300秒：进入减仓期

**市场状态**：
- Binance 期货价格：$95,100
- UP bid: 0.51, ask: 0.53
- DOWN bid: 0.47, ask: 0.49
- **当前持仓**：UP: 24 shares（Maker订单成交了两次），DOWN: 0 shares

**策略计算**：
```
剩余时间 = 600秒
Delta = 95,100 - 95,000 = 100
rawX = 100 / sqrt(600) ≈ 4.08
z = 0.08 * 4.08 + 0.10 = 0.4264
模型概率 = NormCdf(0.4264) ≈ 0.665（66.5%）

市场中枢 = (0.51 + 0.53) / 2 = 0.52
最终概率 = 0.3 * 0.665 + 0.7 * 0.52 = 0.564（56.4%）

净持仓 = 24 - 0 = 24
偏斜 = 24 * 0.00005 = 0.0012
最终报价 UP = 0.564 - 0.0012 = 0.5628
最终报价 DOWN = 0.436 + 0.0012 = 0.4372

动态Maker Edge = 0.0005（还未开始衰减）
模式：REDUCE（减仓期）
```

**决策**：
- 模式：REDUCE（剩余时间 < 300秒？否，还是 600秒）
- 等等，600秒 > 300秒，所以还是 NORMAL 模式
- 实际上，剩余时间 = 600秒 > 300秒，所以还是正常期

**修正**：剩余时间 = 600秒，所以还是正常期，不是减仓期。

---

### T+600秒：进入减仓期

**市场状态**：
- Binance 期货价格：$95,050
- UP bid: 0.49, ask: 0.51
- DOWN bid: 0.49, ask: 0.51
- **当前持仓**：UP: 36 shares，DOWN: 0 shares

**策略计算**：
```
剩余时间 = 300秒（正好进入减仓期）
Delta = 95,050 - 95,000 = 50
rawX = 50 / sqrt(300) ≈ 2.89
z = 0.08 * 2.89 + 0.10 = 0.3312
模型概率 = NormCdf(0.3312) ≈ 0.630（63.0%）

市场中枢 = (0.49 + 0.51) / 2 = 0.50
最终概率 = 0.3 * 0.630 + 0.7 * 0.50 = 0.539（53.9%）

净持仓 = 36 - 0 = 36
偏斜 = 36 * 0.00005 = 0.0018
最终报价 UP = 0.539 - 0.0018 = 0.5372
最终报价 DOWN = 0.461 + 0.0018 = 0.4628

动态Maker Edge = 0.0005（刚开始衰减）
模式：REDUCE（减仓期）
```

**决策**：
- 模式：REDUCE（剩余时间 = 300秒）
- allowTradeUp = false（减仓期且净持仓 > 0，不能加 UP）
- allowTradeDown = true（减仓期且净持仓 > 0，可以买入 DOWN 平仓）
- DOWN Taker：0.51 < 0.4628 - 0.003 = 0.4598？否
- DOWN Maker：0.49 + 0.001 = 0.491 < 0.4628 - 0.0005 = 0.4623？否
- **动作**：无（等待更好的价格）

**执行**：
```
[adaptive] [Rem:300s] Mode: REDUCE
[adaptive] AllowUp:false AllowDown:true | MakerUp:false MakerDown:false | TakerUp:false TakerDown:false
```

---

### T+720秒：强制平仓期前

**市场状态**：
- Binance 期货价格：$95,000
- UP bid: 0.48, ask: 0.50
- DOWN bid: 0.50, ask: 0.52
- **当前持仓**：UP: 36 shares，DOWN: 0 shares

**策略计算**：
```
剩余时间 = 180秒（正好进入强制平仓期）
Delta = 95,000 - 95,000 = 0
rawX = 0 / sqrt(180) = 0
z = 0.08 * 0 + 0.10 = 0.10
模型概率 = NormCdf(0.10) ≈ 0.540（54.0%）

市场中枢 = (0.48 + 0.50) / 2 = 0.49
最终概率 = 0.3 * 0.540 + 0.7 * 0.49 = 0.511（51.1%）

净持仓 = 36 - 0 = 36
偏斜 = 36 * 0.00005 = 0.0018
最终报价 UP = 0.511 - 0.0018 = 0.5092
最终报价 DOWN = 0.489 + 0.0018 = 0.4908

动态Maker Edge = 0.0005 + (0.02 - 0.0005) * (300-180)/300 ≈ 0.0083
模式：FORCE（强制平仓期）
```

**决策**：
- 模式：FORCE（剩余时间 < 180秒）
- 净持仓绝对值 = 36 >= 5？是
- 净持仓 > 0？是，需要买入 DOWN 平仓
- DOWN ask = 0.52 < 0.99？是
- **动作**：Taker 买入 DOWN @ 0.52，数量 12 shares

**执行**：
```
⚡ [adaptive] 强制纠偏 [FORCE_CLOSE] Buy DOWN @ 0.5200 (Size: 12.00) | Rem: 180.0s
```

**持仓更新**：
- UP: 36 shares
- DOWN: 12 shares
- 净持仓: +24

---

### T+780秒：继续强制平仓

**市场状态**：
- Binance 期货价格：$94,950
- UP bid: 0.47, ask: 0.49
- DOWN bid: 0.51, ask: 0.53
- **当前持仓**：UP: 36 shares，DOWN: 12 shares

**决策**：
- 模式：FORCE
- 净持仓 = 24 >= 5？是
- **动作**：Taker 买入 DOWN @ 0.53，数量 12 shares

**执行**：
```
⚡ [adaptive] 强制纠偏 [FORCE_CLOSE] Buy DOWN @ 0.5300 (Size: 12.00) | Rem: 120.0s
```

**持仓更新**：
- UP: 36 shares
- DOWN: 24 shares
- 净持仓: +12

---

### T+840秒：接近结束

**市场状态**：
- Binance 期货价格：$94,900
- UP bid: 0.46, ask: 0.48
- DOWN bid: 0.52, ask: 0.54
- **当前持仓**：UP: 36 shares，DOWN: 24 shares

**决策**：
- 模式：FORCE
- 净持仓 = 12 >= 5？是
- **动作**：Taker 买入 DOWN @ 0.54，数量 12 shares

**执行**：
```
⚡ [adaptive] 强制纠偏 [FORCE_CLOSE] Buy DOWN @ 0.5400 (Size: 12.00) | Rem: 60.0s
```

**持仓更新**：
- UP: 36 shares
- DOWN: 36 shares
- 净持仓: 0（已平仓）

---

### T+900秒：周期结束

**最终状态**：
- UP: 36 shares
- DOWN: 36 shares
- 净持仓: 0
- **结果**：已完全对冲，无敞口进入结算

---

## 关键观察点

1. **正常期（0-600秒）**：
   - 策略正常交易，可以加仓
   - Maker 订单提供流动性
   - 根据价格波动动态调整挂单价

2. **减仓期（600-720秒）**：
   - 只减不加，只能平仓
   - 等待更好的价格平仓

3. **强制平仓期（720-900秒）**：
   - 强制平仓，避免带仓进入结算
   - 即使价格不利也要平仓

4. **库存管理**：
   - 净持仓增加时，偏斜增加，降低买入价
   - 避免单边敞口过大

5. **动态 Maker Edge**：
   - 随着剩余时间减少，Maker Edge 增加
   - 要求更高的利润才挂单

