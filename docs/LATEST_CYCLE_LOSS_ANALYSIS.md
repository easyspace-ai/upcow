# 最新周期亏损分析报告

## 📋 交易概览

### UI 显示的交易记录

| 交易 | 数量 | 价格 | 成本 | 时间 |
|------|------|------|------|------|
| **Bought 11 Up** | 11 shares | 66¢ | $7.26 | 3m ago |
| **Bought 11 Down** | 11 shares | 37¢ | $4.07 | 3m ago |

**总成本**: $7.26 + $4.07 = **$11.33**

## 🔍 问题分析

### 1. 策略触发时的价格

从日志中可以看到：
- **策略触发**: `side=up ask=66c hedge=31c`
- **实际成交**: UP @ 66¢, DOWN @ 37¢

### 2. 价格差异分析

**预期价格**:
- UP: 66¢ ✅ (与实际一致)
- DOWN (Hedge): 31¢ ❌ (与实际37¢不一致)

**实际成交价格**:
- UP: 66¢ ✅
- DOWN: 37¢ ❌ (比预期高6¢)

**价格差异**: 37¢ - 31¢ = **6¢**

### 3. 亏损原因

#### 主要原因：价格滑点和策略计算逻辑问题

1. **策略计算逻辑**:
   - 策略使用互补价公式计算 Hedge 价格：`hedgeCents = 100 - askCents - hedgeOffset`
   - 当 UP @ 66¢ 时，计算出的 Hedge 价格 = 100 - 66 - 3 = 31¢
   - **但实际市场中的 DOWN 价格可能不是 31¢**

2. **实际市场价格**:
   - 从日志中看到，策略触发时 DOWN 的实际价格已经是 **35¢**
   - 但策略仍然使用计算出的 31¢ 下单
   - 下单时，DOWN 价格已经涨到 **37¢**

3. **价格滑点**:
   - 策略触发时：DOWN @ 35¢（实际市场价格）
   - 策略计算：DOWN @ 31¢（互补价计算）
   - 实际成交：DOWN @ 37¢（价格继续上涨）

4. **成本增加**:
   - 预期成本：11 shares × 31¢ = $3.41
   - 实际成本：11 shares × 37¢ = $4.07
   - **额外成本**：$4.07 - $3.41 = **$0.66**

### 4. 订单执行时间线

```
06:15:26 - 订单1下单成功 (UP @ 66¢)
06:15:27 - 订单1成交 (11 shares)
06:15:30 - 订单3下单成功 (DOWN @ 31¢，但实际市场价更高)
06:15:31 - 策略触发日志 (hedge=31c)
06:15:31 - 订单2下单成功 (DOWN @ 37¢)
06:15:31 - 订单2成交 (11 shares)
06:15:52 - 订单3被取消 (价格不匹配)
```

### 5. 重复下单问题

从日志中可以看到：
- **5个订单成功下单**
- **3个订单失败**（FAK订单匹配失败）
- **2个订单成交**
- **1个订单被取消**

这说明存在重复下单的问题，可能是因为：
1. 策略触发了多次（虽然日志只显示1次）
2. 或者下单逻辑有并发问题

## 💡 解决方案

### 1. 使用实际市场价格

**问题**: 策略使用互补价公式计算 Hedge 价格，而不是使用实际市场价格。

**解决方案**: 
- 在下单前，查询实际的市场价格（bestBid/bestAsk）
- 使用实际市场价格下单，而不是通过公式计算

```go
// 当前代码（问题）
hedgeCents := 100 - askCents - hedgeOffset

// 应该改为
hedgeBestBid, hedgeBestAsk, err := s.TradingService.GetBestPrice(orderCtx, hedgeAsset)
if err != nil {
    return nil
}
hedgeCents := int(hedgeBestAsk*100 + 0.5) // 使用实际市场价格
```

### 2. 价格滑点保护

**问题**: 下单时价格可能已经变化，导致实际成交价格与预期不符。

**解决方案**:
- 在下单前再次检查价格
- 如果价格变化超过阈值（例如 2¢），取消下单
- 或者使用限价单，设置最大可接受价格

### 3. 防止重复下单

**问题**: 存在多个订单同时下单的情况。

**解决方案**:
- 在下单前检查本地订单状态（已实现）
- 确保同一方向只有一个订单在执行
- 添加订单去重逻辑

### 4. 订单匹配检查

**问题**: FAK订单可能因为价格不匹配而失败。

**解决方案**:
- 在下单前检查订单簿深度
- 确保有足够的流动性
- 如果流动性不足，使用 GTC 限价单而不是 FAK

## 📊 亏损计算

### 预期成本
- UP: 11 shares × 66¢ = $7.26
- DOWN: 11 shares × 31¢ = $3.41
- **总成本**: $10.67

### 实际成本
- UP: 11 shares × 66¢ = $7.26
- DOWN: 11 shares × 37¢ = $4.07
- **总成本**: $11.33

### 额外成本
- **$11.33 - $10.67 = $0.66** (约 6.2% 的成本增加)

## 🎯 建议

1. **立即修复**: 使用实际市场价格而不是互补价公式
2. **添加价格滑点保护**: 在下单前检查价格变化
3. **优化订单执行**: 确保订单按预期价格成交
4. **监控价格变化**: 记录价格变化时间线，便于分析

---

**报告生成时间**: 2025-12-25  
**状态**: 已识别问题，需要修复策略计算逻辑

