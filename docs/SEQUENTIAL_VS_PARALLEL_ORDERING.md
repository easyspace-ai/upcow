# 顺序下单 vs 并发下单分析

## 📊 两种下单方式对比

### 1. 并发下单（Parallel）

**实现方式**：
- 使用 `ExecuteMultiLeg`，同时提交 Entry 和 Hedge 订单
- 两个订单几乎同时提交（间隔 < 100ms）

**优点**：
- ✅ **速度快**：两个订单几乎同时提交，总耗时短
- ✅ **减少价格滑点风险**：在价格变化前完成两个订单
- ✅ **原子性更好**：两个订单在同一时间点提交，价格更一致

**缺点**：
- ❌ **风险高**：如果 Entry 订单失败，Hedge 订单可能已经提交
- ❌ **资金占用**：两个订单同时占用资金
- ❌ **订单管理复杂**：需要处理部分成交的情况

### 2. 顺序下单（Sequential）

**实现方式**：
- 先提交 Entry 订单（FAK）
- 等待 Entry 订单成交（轮询检查，最多 3 秒）
- Entry 成交后，再提交 Hedge 订单（GTC）

**当前实现的时间间隔**：
```go
maxWaitTime := 3 * time.Second        // 最多等待 3 秒
checkInterval := 100 * time.Millisecond  // 每 100ms 检查一次
```

**实际间隔时间**：
- **FAK 订单特性**：FAK 订单要么立即成交，要么立即取消
- **最快情况**：Entry 订单立即成交 → 立即下 Hedge 订单（间隔 < 200ms）
- **最慢情况**：Entry 订单在 3 秒内成交 → 下 Hedge 订单（间隔 < 3.2 秒）
- **失败情况**：Entry 订单失败/取消 → 不下 Hedge 订单

**优点**：
- ✅ **风险低**：只有 Entry 订单成交后才下 Hedge 订单
- ✅ **资金效率高**：先确认 Entry 成交，再下 Hedge
- ✅ **订单管理简单**：避免部分成交的复杂情况
- ✅ **符合策略逻辑**：优先执行价格高的主单

**缺点**：
- ❌ **速度慢**：需要等待 Entry 订单成交（最多 3 秒）
- ❌ **价格滑点风险**：在等待期间，Hedge 价格可能变化
- ❌ **可能错过机会**：如果 Entry 成交时间过长，Hedge 价格可能已经变化

## 🎯 针对我们的策略分析

### 策略特点

1. **Entry 订单**：FAK 类型，价格 >= `minPreferredPriceCents`（60c）
2. **Hedge 订单**：GTC 类型，限价单，等待成交
3. **目标**：确保 Entry 订单成交后再下 Hedge 订单

### 时间间隔分析

**当前实现**：
- Entry 订单提交后，轮询检查订单状态
- 检查间隔：100ms
- 最大等待时间：3 秒

**实际时间线**：
```
T+0ms:   提交 Entry 订单（FAK）
T+50ms:  Entry 订单成交（FAK 通常立即成交）
T+150ms: 检测到 Entry 订单成交
T+200ms: 提交 Hedge 订单（GTC）
```

**典型间隔**：**150-300ms**（Entry 成交后立即下 Hedge）

**最坏情况**：
```
T+0ms:    提交 Entry 订单（FAK）
T+3000ms: Entry 订单仍未成交（可能部分成交或延迟）
T+3100ms: 超时，继续下 Hedge 订单（但可能不安全）
```

## 💡 建议

### 对于我们的策略：**顺序下单更合适**

**原因**：

1. **风险控制优先**：
   - Entry 订单是主单（价格高，优先级高）
   - 只有 Entry 成交后才需要 Hedge
   - 避免 Entry 失败但 Hedge 已下单的风险

2. **FAK 订单特性**：
   - FAK 订单通常立即成交或立即取消
   - 等待时间很短（通常 < 200ms）
   - 不会显著增加总耗时

3. **价格稳定性**：
   - Entry 和 Hedge 价格通过有效价格计算，已经考虑了镜像订单簿
   - 在短时间内（< 500ms），价格变化通常不大
   - Hedge 订单是 GTC 限价单，即使价格略有变化，也能成交

### 优化建议

1. **缩短检查间隔**：
   ```go
   checkInterval := 50 * time.Millisecond  // 从 100ms 改为 50ms
   ```
   - 可以更快检测到 Entry 订单成交
   - 减少总等待时间

2. **优化等待逻辑**：
   ```go
   // 如果 Entry 订单是 FAK，通常立即成交或取消
   // 可以缩短最大等待时间
   maxWaitTime := 1 * time.Second  // 从 3 秒改为 1 秒
   ```

3. **添加价格检查**：
   ```go
   // 在下 Hedge 订单前，再次检查价格
   // 如果价格变化超过阈值（例如 2c），可以调整 Hedge 价格或取消
   ```

## 📈 性能对比

| 指标 | 并发下单 | 顺序下单 |
|------|---------|---------|
| **总耗时** | ~100-200ms | ~200-500ms |
| **价格一致性** | 高（同时提交） | 中（间隔短） |
| **风险控制** | 低（可能部分成交） | 高（先确认 Entry） |
| **资金效率** | 低（同时占用） | 高（按需占用） |
| **订单管理** | 复杂（需要处理部分成交） | 简单（顺序执行） |

## 🎯 结论

**对于我们的策略，顺序下单更合适**：

1. ✅ **风险控制**：确保 Entry 订单成交后再下 Hedge
2. ✅ **时间成本低**：FAK 订单通常立即成交，等待时间短（< 300ms）
3. ✅ **符合策略逻辑**：优先执行价格高的主单
4. ✅ **订单管理简单**：避免部分成交的复杂情况

**建议优化**：
- 缩短检查间隔到 50ms
- 缩短最大等待时间到 1 秒（FAK 订单特性）
- 添加价格变化检查（可选）

---

**分析时间**: 2025-12-25  
**当前实现**: 顺序下单，检查间隔 100ms，最大等待 3 秒  
**建议优化**: 检查间隔 50ms，最大等待 1 秒

