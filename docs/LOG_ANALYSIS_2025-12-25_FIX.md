# 日志分析 - Duplicate In-Flight 修复效果

**分析时间**: 2025-12-25 17:30-17:41  
**日志文件**: `btc-updown-15m-1766655000.log`

## 📊 修复前后对比

### 修复前（17:09:47-17:09:48）
- **duplicate in-flight 错误**: 大量（1秒内多次）
- **策略层去重**: 未生效（`lastTriggerSideAt` 在下单成功后更新）
- **日志噪音**: 高（大量警告日志）

### 修复后（17:30:34-17:30:38）
- **duplicate in-flight 错误**: 2次（显著减少）
- **策略层去重**: 部分生效（但仍有改进空间）
- **日志噪音**: 低（错误明显减少）

## 🔍 详细分析

### 1. 时间线分析（17:30:34-17:30:38）

```
[17:30:34] 📤 步骤1: 下主单 Entry (side=up price=60c)
[17:30:34] ⚡ 触发(顺序): side=up ... trades=1/3
[17:30:35] 📤 步骤1: 下主单 Entry (side=up price=62c)
[17:30:35] ⚡ 触发(顺序): side=up ... trades=2/3
[17:30:37] 📤 步骤1: 下主单 Entry (side=up price=61c)
[17:30:37] ⚠️ 对冲单下单失败: err=duplicate in-flight
[17:30:37] ⚠️ 下单失败: err=duplicate in-flight side=up
[17:30:38] 📤 步骤1: 下主单 Entry (side=up price=64c)
[17:30:38] ⚡ 触发(顺序): side=up ... trades=3/3
```

### 2. 问题分析

**观察**:
1. ✅ **修复有效**: duplicate in-flight 错误从"大量"减少到"2次"
2. ⚠️ **仍有问题**: 17:30:37 出现 duplicate in-flight 错误
3. ⚠️ **日志顺序**: "触发(顺序)" 日志在下单**之后**打印（第1078行）

**原因**:
- `lastTriggerSideAt` 在第570行更新（在下单之前）
- 但 "触发(顺序)" 日志在第1078行打印（在下单成功后）
- 如果价格变化事件在 1.5 秒内多次触发，第二次触发时 `lastTriggerSideAt` 已经更新，但去重检查可能因为时间窗口问题未生效

### 3. 为什么还有 duplicate in-flight？

**可能原因**:
1. **价格变化事件太频繁**: 在 1.5 秒内多次触发（如 17:30:35 和 17:30:37）
2. **去重检查时间窗口**: `cooldownMs: 1500ms`，但两次触发间隔可能刚好超过 1.5 秒
3. **执行层去重**: `inFlightDeduper` TTL 是 2 秒，如果订单参数完全相同，会在 2 秒内被拒绝

**示例**:
```
T+0ms:   价格变化事件1 → 下单成功（price=62c）
T+100ms: 更新 lastTriggerSideAt = now
T+1500ms: 价格变化事件2 → 去重检查：now - lastTriggerSideAt = 1400ms < 1500ms → 应该跳过
T+1600ms: 但实际可能因为并发或时间精度问题，去重检查未生效
T+1700ms: 尝试下单 → duplicate in-flight（订单还在 2 秒窗口内）
```

## 💡 进一步优化建议

### 方案 1: 增加去重检查的日志级别

将 "跳过：同一方向" 日志从 `Debug` 改为 `Info`，方便观察去重是否生效：

```go
log.Infof("🔄 [%s] 跳过：同一方向 %s 在冷却期内（距离上次触发 %.2fs）", 
    ID, winner, now.Sub(s.lastTriggerSideAt).Seconds())
```

### 方案 2: 延长冷却时间

将 `cooldownMs` 从 1500ms 增加到 2000ms，与 `inFlightDeduper` TTL 对齐：

```yaml
cooldownMs: 2000  # 与 inFlightDeduper TTL (2秒) 对齐
```

### 方案 3: 检查去重 key 计算

确保去重 key 包含价格信息，避免价格变化时被误判为重复：

```go
// 当前去重 key: MarketSlug|AssetID|Side|Price|Size|OrderType
// 如果价格变化（如 62c → 61c），应该生成不同的 key
```

## 📋 总结

### ✅ 修复效果
- **duplicate in-flight 错误**: 从"大量"减少到"2次"（显著改善）
- **策略执行**: 正常（3次交易都成功）
- **日志噪音**: 明显减少

### ⚠️ 仍需改进
- **去重检查**: 仍有 2 次 duplicate in-flight 错误
- **日志级别**: "跳过：同一方向" 日志是 Debug 级别，无法观察是否生效
- **时间窗口**: 冷却时间（1.5秒）与执行层去重（2秒）不完全对齐

### 🎯 建议
1. **短期**: 将 "跳过：同一方向" 日志改为 Info 级别，观察去重是否生效
2. **中期**: 将 `cooldownMs` 增加到 2000ms，与执行层去重对齐
3. **长期**: 考虑统一去重机制，避免两层去重逻辑不一致

## 📊 统计数据

| 指标 | 修复前 | 修复后 | 改善 |
|------|--------|--------|------|
| duplicate in-flight 错误 | 大量（1秒内多次） | 2次 | ✅ 显著减少 |
| 策略层去重日志 | 无 | 0次（Debug级别） | ⚠️ 无法观察 |
| 成功交易次数 | 正常 | 3次 | ✅ 正常 |
| 日志噪音 | 高 | 低 | ✅ 明显改善 |

