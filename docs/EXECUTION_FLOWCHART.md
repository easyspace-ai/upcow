# 成对交易策略 - 执行流程图

## 📋 简化版执行流程

### 整体流程

```
┌─────────────────────────────────────────────────────────────┐
│                    15分钟周期开始                            │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  阶段1: Build (0-5分钟) - 快速建仓                          │
│  ┌────────────────────────────────────────────────────┐    │
│  │ 价格 < 0.60? → 买入 (保持 UP/DOWN 平衡)             │    │
│  │ QUp < 30? → 买入 UP                                 │    │
│  │ QDown < 30? → 买入 DOWN                             │    │
│  │ 持仓比例失衡? → 补充少的那一边                        │    │
│  └────────────────────────────────────────────────────┘    │
│  输出: QUp ≈ 12-20, QDown ≈ 12-20                          │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  阶段2: Lock (5-10分钟) - 成对锁定                          │
│  ┌────────────────────────────────────────────────────┐    │
│  │ P_up < 0? → 补充 UP (风险对冲)                       │    │
│  │ P_down < 0? → 补充 DOWN (风险对冲)                   │    │
│  │ 价格极端? → 买入反向保险                              │    │
│  │ 一正一负? → 补充负的那一边                            │    │
│  │ 都为正但小? → 提升利润                               │    │
│  └────────────────────────────────────────────────────┘    │
│  目标: P_up > 0 AND P_down > 0 ✓                           │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  阶段3: Amplify (10-15分钟) - 利润放大                      │
│  ┌────────────────────────────────────────────────────┐    │
│  │ 已锁定? ✗ → 继续执行阶段2                            │    │
│  │ 已锁定? ✓ → 进入放大                                 │    │
│  │   识别主方向 (UP/DOWN/NEUTRAL)                      │    │
│  │   主方向加仓 (提升利润到 5 USDC)                     │    │
│  │   反向保险 (避免反转)                                │    │
│  │   实时检查锁定 (失衡则重新锁定)                       │    │
│  └────────────────────────────────────────────────────┘    │
│  目标: P_up ≈ 3-8, P_down ≈ 1-5 (保持都为正)              │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                    周期结束 - 结算                           │
│  UP胜 → 收益 = QUp × 1.0 - 总成本                          │
│  DOWN胜 → 收益 = QDown × 1.0 - 总成本                       │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔄 核心决策循环

### 每次价格变化时的处理流程

```
价格变化事件
    ↓
┌───────────────────────┐
│ 1. 更新价格状态        │
│    priceUp, priceDown │
└───────────────────────┘
    ↓
┌───────────────────────┐
│ 2. 判断当前阶段        │
│    Build/Lock/Amplify │
│    (基于时间+价格)     │
└───────────────────────┘
    ↓
┌───────────────────────┐
│ 3. 计算利润状态        │
│    P_up = QUp - 总成本 │
│    P_down = QDown - 总成本│
└───────────────────────┘
    ↓
┌───────────────────────┐
│ 4. 检查锁定状态        │
│    P_up > 0 AND P_down > 0?│
└───────────────────────┘
    ↓
┌───────────────────────┐
│ 5. 执行阶段策略        │
│    (见下方详细逻辑)    │
└───────────────────────┘
    ↓
┌───────────────────────┐
│ 6. 提交订单           │
│    (异步执行)          │
└───────────────────────┘
    ↓
┌───────────────────────┐
│ 7. 等待成交           │
│    更新持仓和成本      │
└───────────────────────┘
    ↓
重新进入循环 ←─────────┘
```

---

## 🎯 阶段策略详细逻辑

### 阶段1: Build (建仓)

```
输入: 价格变化
    ↓
┌─────────────────────┐
│ 检查1: 持仓是否充足? │
│ QUp < base_target?  │
│ QDown < base_target?│
└─────────────────────┘
    ↓ YES
┌─────────────────────┐
│ 检查2: 价格是否合适? │
│ price < 0.60?       │
└─────────────────────┘
    ↓ YES
┌─────────────────────┐
│ 执行: 买入           │
│ 数量: build_lot_size│
│ (默认 3.0 shares)   │
└─────────────────────┘
    ↓
┌─────────────────────┐
│ 检查3: 持仓比例      │
│ UP/(UP+DOWN)        │
│ 40%-60%?            │
└─────────────────────┘
    ↓ NO
┌─────────────────────┐
│ 执行: 平衡买入       │
│ 补充少的那一边       │
└─────────────────────┘
```

### 阶段2: Lock (锁定)

```
输入: 价格变化
    ↓
┌──────────────────────────┐
│ 优先级1: 风险对冲         │
│ P_up < 0? → 买入 UP      │
│ P_down < 0? → 买入 DOWN  │
│ (使利润 >= 0)            │
└──────────────────────────┘
    ↓ (如果都>=0)
┌──────────────────────────┐
│ 优先级2: 利用极端价格     │
│ UP>0.80 & DOWN<0.20?     │
│ → 买入 DOWN (保险)       │
│ DOWN>0.80 & UP<0.20?     │
│ → 买入 UP (保险)         │
└──────────────────────────┘
    ↓ (如果不极端)
┌──────────────────────────┐
│ 优先级3: 双边均衡         │
│ P_up>0 & P_down<0?       │
│ → 补充 DOWN              │
│ P_down>0 & P_up<0?       │
│ → 补充 UP                │
└──────────────────────────┘
    ↓ (如果都>0)
┌──────────────────────────┐
│ 优先级4: 提升到目标       │
│ P_up < 2.0? → 加仓 UP    │
│ P_down < 2.0? → 加仓 DOWN│
└──────────────────────────┘
    ↓
┌──────────────────────────┐
│ 检查锁定状态              │
│ P_up>0 & P_down>0? → ✓   │
└──────────────────────────┘
```

### 阶段3: Amplify (放大)

```
输入: 价格变化
    ↓
┌──────────────────────────┐
│ 前提检查: 是否已锁定?     │
│ P_up>0 & P_down>0?       │
└──────────────────────────┘
    ↓ NO
┌──────────────────────────┐
│ → 继续执行阶段2锁定逻辑   │
└──────────────────────────┘
    ↓ YES
┌──────────────────────────┐
│ 识别主方向                │
│ UP>0.70 & DOWN<0.30? → UP│
│ DOWN>0.70 & UP<0.30? → DOWN│
│ 其他 → NEUTRAL (不放大)  │
└──────────────────────────┘
    ↓ (有主方向)
┌──────────────────────────┐
│ 主方向加仓                │
│ P_主 < 5.0? → 买入主方向  │
│ (提升利润到 amplify_target)│
└──────────────────────────┘
    ↓
┌──────────────────────────┐
│ 反向保险                  │
│ 反向价格 < 0.20?          │
│ → 买入少量反向 (保险)     │
└──────────────────────────┘
    ↓
┌──────────────────────────┐
│ 实时检查锁定              │
│ 失衡? → 重新平衡          │
└──────────────────────────┘
```

---

## 📊 关键公式速查

### 利润计算

```
P_up_win = Q_up × 1.0 - (C_up + C_down)
P_down_win = Q_down × 1.0 - (C_up + C_down)

锁定状态: P_up_win > 0 AND P_down_win > 0
```

### 补充数量计算

```
# 使某个方向利润 = 0 所需的持仓量
target_Q = C_up + C_down
need = target_Q - current_Q

# 实际下单量（考虑限制）
actual = min(need, build_lot_size)
actual = max(actual, min_order_size)
```

### 阶段判断

```
elapsed = 当前时间 - 周期开始时间

if elapsed < 300s:
    phase = Build
elif elapsed < 600s:
    phase = Lock
else:
    phase = Amplify

# 提前切换
if price_up > 0.85 or price_down > 0.85:
    phase = Lock
    
if (price_up > 0.90 or price_down > 0.90) and locked:
    phase = Amplify
```

---

## 🎬 典型场景示例

### 场景1: 早期快速锁定（理想情况）

```
T=0s:   QUp=0, QDown=0, P_up=0, P_down=0
        ↓ 价格: UP=0.55, DOWN=0.45
T=30s:  买入 UP 3.0 @ 0.55
        QUp=3.0, P_up=+1.35, P_down=-1.65 ✗
        ↓
T=45s:  买入 DOWN 3.0 @ 0.45
        QDown=3.0, P_up=+0.09, P_down=+0.09 ✓
        
✓ 45秒内完成锁定！
```

### 场景2: 价格分化需要对冲（常见情况）

```
T=300s: QUp=15.0, QDown=15.0
        P_up=+0.50, P_down=+0.50 ✓
        ↓ 价格: UP=0.70, DOWN=0.30
T=350s: 买入 UP 5.0 @ 0.70
        P_up=+0.20, P_down=-3.30 ✗ (失衡！)
        ↓
T=360s: 检测到 DOWN 风险敞口
        买入 DOWN 4.0 @ 0.30
        P_up=+0.00, P_down=+0.80 ✓
        
✓ 重新锁定成功
```

### 场景3: 极端价格锁定机会

```
T=400s: QUp=18.0, QDown=20.0
        P_up=+1.20, P_down=+2.20 ✓
        ↓ 价格: UP=0.85, DOWN=0.15 (极端！)
T=410s: 利用极低 DOWN 价格
        买入 DOWN 5.0 @ 0.15 = 0.75 USDC
        
        虽然总成本增加 0.75，但：
        - QDown 增加 5.0
        - P_down_win 提升 4.25
        - 成本相对收益很小
        
✓ 利用极端价格强化锁定
```

---

## 💡 策略精髓

### 核心思想

```
传统网格策略:
   价格到达 62 → 买入
   价格到达 65 → 买入
   (被动等待)

成对交易策略:
   P_up < 0 → 买入 UP
   P_down < 0 → 买入 DOWN
   (主动对冲)
```

### 决策驱动

```
网格: 价格位置驱动
成对: 风险敞口驱动

网格: "价格到了某个层级"
成对: "风险敞口需要对冲"
```

### 执行特点

```
✓ 实时监控利润状态
✓ 主动识别锁定机会
✓ 分阶段清晰目标
✓ 灵活应对价格变化
✓ 保持锁定优先
```

---

## 🎯 成功关键指标

### 阶段1成功标志
```
✓ 5分钟内建立基础仓位（10-20 shares/边）
✓ 持仓比例平衡（40%-60%）
✓ 平均成本 < 0.60
✓ 早期完成锁定（可选但最好）
```

### 阶段2成功标志
```
✓ 完成锁定（P_up > 0 AND P_down > 0）
✓ 利润达到目标（≥ 2.0 USDC/边）
✓ 持仓量充足（20-30 shares/边）
✓ 锁定稳定（不频繁失衡）
```

### 阶段3成功标志
```
✓ 保持锁定状态
✓ 利润提升（3-8 USDC）
✓ 风险控制（不过度加仓）
✓ 最终结算盈利
```

这就是完整的执行逻辑和流程！🎉
