# 实际配置分析（基于 config.yaml）

**分析时间**: 2025-12-26  
**实际配置文件**: `config.yaml`（根目录）

---

## 📋 关键配置参数

### 交易频率限制

```yaml:32:32:config.yaml
maxTradesPerCycle: 3
```

**重要发现**：
- ✅ **没有设置 `oncePerCycle`**，所以默认值为 `false`
- ✅ **设置了 `maxTradesPerCycle: 3`**，表示每个周期最多可以交易 **3次**
- ❌ **不是每个周期只交易1次**，而是最多3次

### 速度阈值（已优化）

```yaml:28:30:config.yaml
windowSeconds: 8              # 从4秒增加到8秒，给价格更多时间积累变化
minMoveCents: 1                # 从2c降低到1c，更容易触发
minVelocityCentsPerSec: 0.15   # 从0.45降低到0.15，适应缓慢上涨
```

**分析**：
- 阈值已经**大幅降低**，更容易触发
- `minVelocityCentsPerSec: 0.15` 比之前的 `0.3` 低了一半
- `minMoveCents: 1` 比之前的 `3` 低了3倍

### 市场质量门控（已放宽）

```yaml:42:45:config.yaml
enableMarketQualityGate: true
marketQualityMinScore: 30  # 降低到30，允许35分的市场条件通过
marketQualityMaxSpreadCents: 6  # 放宽价差限制（从4c调整到6c）
marketQualityMaxBookAgeMs: 3000  # 放宽WebSocket数据年龄限制（从1.8秒调整到3秒）
```

**分析**：
- 质量分数要求从 `70` 降低到 `30`（降低了57%）
- 价差限制从 `4c` 放宽到 `6c`
- WebSocket数据年龄限制从 `1.8秒` 放宽到 `3秒`

### 周期结束前保护

```yaml:57:57:config.yaml
cycleEndProtectionMinutes: 3
```

**分析**：
- 周期结束前3分钟不开新单
- 这是当前**最主要的限制因素**（占95.8%的跳过）

---

## 🔍 为什么没有实际开单？

基于实际配置 `config.yaml`，重新分析：

### 1. 周期结束前保护（主要原因）✅

- **跳过次数**: 5,748 次（95.8%）
- **配置**: `cycleEndProtectionMinutes: 3`
- **影响**: 每个15分钟周期的最后3分钟不会交易
- **实际交易窗口**: 只有前12分钟（80%的时间）

**时间线示例**：
```
14:12:00 - 周期开始 (btc-updown-15m-1766728800)
14:12:00 ~ 14:12:00 - 可以交易 ✅
...
14:12:00 ~ 14:12:00 - 可以交易 ✅
14:12:00 ~ 14:15:00 - 周期结束前保护，不交易 ⏸️
14:15:00 - 周期切换
```

### 2. 速度阈值可能仍然过高 ⚠️

虽然阈值已经降低：
- `minVelocityCentsPerSec: 0.15`（分/秒）
- `minMoveCents: 1`（分）
- `windowSeconds: 8`（秒）

但可能仍然不够：
- 如果价格变化非常缓慢，可能无法达到 `0.15 分/秒` 的速度
- 需要检查实际的价格变化速度

### 3. 市场质量门控 ✅

虽然已经放宽，但：
- `marketQualityMinScore: 30` 仍然可能过滤掉一些交易机会
- 需要查看日志中是否有市场质量相关的跳过记录

### 4. 每个周期最多3次交易 ✅

- 配置允许每个周期交易3次
- 但日志显示**一次都没有交易**
- 说明问题不在交易次数限制，而在**触发条件未满足**

---

## 📊 配置对比

| 参数 | yml/velocityfollow.yaml | config.yaml（实际使用） | 变化 |
|------|------------------------|------------------------|------|
| `oncePerCycle` | `true` | 未设置（默认 `false`） | ✅ 更宽松 |
| `maxTradesPerCycle` | 未设置 | `3` | ✅ 允许3次 |
| `minMoveCents` | `3` | `1` | ✅ 降低67% |
| `minVelocityCentsPerSec` | `0.3` | `0.15` | ✅ 降低50% |
| `windowSeconds` | `10` | `8` | ✅ 缩短20% |
| `marketQualityMinScore` | `70` | `30` | ✅ 降低57% |
| `cycleEndProtectionMinutes` | 未设置 | `3` | ⚠️ 新增限制 |

---

## 💡 建议

### 1. 检查实际价格变化速度

建议在日志中搜索速度计算结果，看看是否真的达到了 `0.15 分/秒`：

```bash
grep -E "速度|velocity|vel=" logs/*.log | head -20
```

### 2. 临时禁用周期结束前保护（测试）

如果想测试是否是因为周期结束前保护导致没有交易：

```yaml
cycleEndProtectionMinutes: 0  # 临时禁用
```

**注意**：测试后记得改回来，因为这是重要的风险控制机制。

### 3. 进一步降低速度阈值（谨慎）

如果确认价格变化速度确实很慢：

```yaml
minVelocityCentsPerSec: 0.1  # 从0.15降低到0.1
minMoveCents: 0.5            # 从1降低到0.5（需要检查精度）
```

### 4. 检查市场质量分数

查看日志中是否有市场质量相关的信息：

```bash
grep -E "MarketQuality|marketQuality|质量分数|质量分" logs/*.log | head -20
```

### 5. 启用更详细的日志

当前配置已经是 `log_level: "debug"`，应该能看到详细的策略决策过程。

查看是否有以下日志：
- 速度计算结果
- 市场质量分数
- 订单簿流动性检查
- 各种跳过原因

---

## 🎯 核心结论

### 实际配置分析

1. **不是每个周期只交易1次**
   - `oncePerCycle` 未设置（默认 `false`）
   - `maxTradesPerCycle: 3` 允许每个周期交易3次

2. **阈值已经大幅降低**
   - 速度阈值从 `0.3` 降低到 `0.15`（降低50%）
   - 价格变化阈值从 `3c` 降低到 `1c`（降低67%）
   - 市场质量分数从 `70` 降低到 `30`（降低57%）

3. **主要限制因素**
   - **周期结束前保护**：占95.8%的跳过（5,748次）
   - 每个周期只有前12分钟可以交易（80%的时间窗口）

4. **为什么没有交易**
   - 可能在前12分钟的交易窗口内，价格变化速度仍然无法达到 `0.15 分/秒`
   - 或者市场质量分数仍然不满足要求
   - 需要查看 `debug` 级别的日志来确认具体原因

---

## 📝 下一步行动

1. ✅ **查看 debug 日志**，确认：
   - 实际的速度计算结果
   - 市场质量分数
   - 各种跳过原因

2. ⚠️ **临时测试**（谨慎）：
   - 设置 `cycleEndProtectionMinutes: 0` 看看是否有交易
   - 或者进一步降低速度阈值

3. 📊 **分析价格数据**：
   - 检查实际的价格变化速度
   - 确认是否真的无法达到 `0.15 分/秒`

---

**文档生成时间**: 2025-12-26  
**基于配置文件**: `config.yaml`

