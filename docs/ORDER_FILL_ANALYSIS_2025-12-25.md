# 成交订单情况分析

**分析时间**: 2025-12-25 17:16-17:30  
**日志文件**: `btc-updown-15m-1766654100.log`, `btc-updown-15m-1766655000.log`

## 📊 总体情况

### 周期 1: btc-updown-15m-1766654100 (17:16:10-17:16:18)

**交易次数**: 3次（全部成功）

| 序号 | 时间 | 方向 | Entry价格 | Hedge价格 | Entry订单 | Hedge订单 | 状态 |
|------|------|------|-----------|----------|-----------|-----------|------|
| 1 | 17:16:10 | DOWN | 60c | 41c | ✅ 成交 | ✅ 成交 | ✅ 成功 |
| 2 | 17:16:14 | DOWN | 64c | 38c | ✅ 成交 | ✅ 成交 | ✅ 成功 |
| 3 | 17:16:18 | DOWN | 64c | 37c | ✅ 成交 | ✅ 成交 | ✅ 成功 |

**盈亏情况**:
- 交易1: Entry=down @ 60c, cost=$3.90 | UP win: $-3.90 | DOWN win: $2.60
- 交易2: Entry=down @ 64c, cost=$4.16 | UP win: $-4.16 | DOWN win: $2.34
- 交易3: Entry=down @ 64c, cost=$4.16 | UP win: $-4.16 | DOWN win: $2.34

### 周期 2: btc-updown-15m-1766655000 (17:30:34-17:30:38)

**交易次数**: 3次（2次完全成功，1次部分成功）

| 序号 | 时间 | 方向 | Entry价格 | Hedge价格 | Entry订单 | Hedge订单 | 状态 |
|------|------|------|-----------|----------|-----------|-----------|------|
| 1 | 17:30:34 | UP | 60c | 41c | ✅ 成交 | ✅ 成交 | ✅ 成功 |
| 2 | 17:30:35 | UP | 62c | 40c | ✅ 成交 | ✅ 成交 | ✅ 成功 |
| 3 | 17:30:37 | UP | 61c | 40c | ✅ 成交 | ⚠️ 失败 | ⚠️ 部分成功 |
| 4 | 17:30:38 | UP | 64c | 39c | ✅ 成交 | ✅ 成交 | ✅ 成功 |

**盈亏情况**:
- 交易1: Entry=up @ 60c, cost=$3.90 | UP win: $2.60 | DOWN win: $-3.90
- 交易2: Entry=up @ 62c, cost=$4.03 | UP win: $2.47 | DOWN win: $-4.03
- 交易3: Entry=up @ 61c, cost=$3.96 | UP win: $2.54 | DOWN win: $-3.96 ⚠️ **无对冲单**
- 交易4: Entry=up @ 64c, cost=$4.16 | UP win: $2.34 | DOWN win: $-4.16

## 🔍 详细分析

### 1. Entry 订单成交情况

**成功率**: 100% (7/7)

所有 Entry 订单（FAK 类型）都成功成交：
- ✅ 纸交易模式下，FAK 订单立即成交
- ✅ 订单状态正确更新为 `filled`
- ✅ 订单更新回调正常触发

### 2. Hedge 订单成交情况

**成功率**: 85.7% (6/7)

**成功案例** (6个):
- ✅ 所有 Hedge 订单（GTC 类型）都成功提交
- ✅ 订单状态正确更新为 `filled`
- ✅ 订单更新回调正常触发

**失败案例** (1个):
- ⚠️ **17:30:37**: Hedge 订单下单失败，错误: `duplicate in-flight`
- ⚠️ **原因**: 主单已成交，但对冲单下单时触发了去重机制
- ⚠️ **影响**: 交易3没有对冲单，存在风险敞口

### 3. 订单更新回调

**观察**:
- ✅ Entry 订单更新回调正常触发（多次触发，说明回调机制工作正常）
- ✅ Hedge 订单更新回调正常触发
- ⚠️ 但日志显示 `handlers=0`，说明订单更新回调未注册到 Session（这是之前讨论过的问题，用户选择暂不修复）

### 4. 实时盈亏计算

**功能**: ✅ 正常工作

所有主单成交后都正确计算了实时盈亏：
- ✅ 计算了 Entry 成本
- ✅ 计算了 UP win 时的收益
- ✅ 计算了 DOWN win 时的收益

**示例**:
```
💰 [velocityfollow] 主单成交后实时盈亏计算: Entry=up @ 62c size=6.5000 cost=$4.03 | UP win: $2.47 | DOWN win: $-4.03
```

## ⚠️ 问题分析

### 问题 1: Hedge 订单下单失败（17:30:37）

**时间线**:
```
[17:30:37] 📤 步骤1: 下主单 Entry (side=up price=61c)
[17:30:37] ✅ 主单已提交: orderID=order_1766655037040853000 status=filled
[17:30:37] 📤 步骤2: 下对冲单 Hedge (side=down price=40c)
[17:30:37] ⚠️ 对冲单下单失败: err=duplicate in-flight
```

**原因分析**:
1. 主单成交后，立即尝试下对冲单
2. 对冲单下单时，触发了 `duplicate in-flight` 错误
3. 可能原因：
   - 之前的对冲单（17:30:35 的订单）还在 in-flight 窗口内
   - 对冲单的去重 key 可能相同（相同方向、相同价格）

**影响**:
- ⚠️ 交易3没有对冲单，存在风险敞口
- ⚠️ 如果 DOWN 方向 win，会亏损 $3.96

**建议**:
1. 检查对冲单的去重 key 计算逻辑
2. 确保对冲单的去重 key 包含 Entry 订单 ID，避免误判
3. 或者，在主单成交后，立即释放相关的 in-flight key

### 问题 2: 订单更新回调 handlers=0

**观察**:
- 所有订单更新事件都显示 `handlers=0`
- 但策略仍然收到了订单更新回调（通过其他路径）

**说明**:
- 这是之前讨论过的问题
- 用户选择暂不修复（因为系统自己的订单能正确处理）
- 不影响当前功能

## 📋 总结

### ✅ 正常情况

1. **Entry 订单**: 100% 成交率，所有订单都成功
2. **Hedge 订单**: 85.7% 成交率，大部分订单成功
3. **实时盈亏计算**: 正常工作，所有主单成交后都正确计算
4. **订单更新回调**: 正常工作，策略能收到订单更新

### ⚠️ 需要关注

1. **Hedge 订单失败**: 1次失败（17:30:37），原因是 duplicate in-flight
2. **风险敞口**: 交易3没有对冲单，存在风险敞口

### 🎯 建议

1. **短期**: 检查对冲单的去重 key 计算逻辑，确保不会误判
2. **中期**: 在主单成交后，立即释放相关的 in-flight key
3. **长期**: 考虑统一去重机制，避免两层去重逻辑不一致

## 📊 统计数据

| 指标 | 数值 | 说明 |
|------|------|------|
| 总交易次数 | 7次 | 2个周期 |
| Entry 订单成功率 | 100% | 7/7 |
| Hedge 订单成功率 | 85.7% | 6/7 |
| 完全成功交易 | 6次 | 85.7% |
| 部分成功交易 | 1次 | 14.3% |
| 失败交易 | 0次 | 0% |

