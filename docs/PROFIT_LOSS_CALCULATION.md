# 盈亏计算分析

## 📊 订单明细

### 周期 1: btc-updown-15m-1766654100 (DOWN方向)

| 交易 | Entry价格 | Hedge价格 | Entry成本 | Hedge成本 | 总成本 | Entry size | Hedge size |
|------|-----------|-----------|-----------|-----------|--------|------------|------------|
| 1 | 60c | 41c | $3.90 | $2.67 | $6.57 | 6.5 | 6.5 |
| 2 | 62c | 41c | $4.03 | $2.67 | $6.70 | 6.5 | 6.5 |
| 3 | 64c | 38c | $4.16 | $2.47 | $6.63 | 6.5 | 6.5 |
| 4 | 64c | 37c | $4.16 | $2.41 | $6.57 | 6.5 | 6.5 |

**周期1总成本**: $6.57 + $6.70 + $6.63 + $6.57 = **$26.47**

### 周期 2: btc-updown-15m-1766655000 (UP方向)

| 交易 | Entry价格 | Hedge价格 | Entry成本 | Hedge成本 | 总成本 | Entry size | Hedge size |
|------|-----------|-----------|-----------|-----------|--------|------------|------------|
| 1 | 60c | 41c | $3.90 | $2.67 | $6.57 | 6.5 | 6.5 |
| 2 | 62c | 40c | $4.03 | $2.60 | $6.63 | 6.5 | 6.5 |
| 3 | 61c | 40c | $3.96 | ❌ 失败 | $3.96 | 6.5 | 0 |
| 4 | 64c | 39c | $4.16 | $2.54 | $6.70 | 6.5 | 6.5 |

**周期2总成本**: $6.57 + $6.63 + $3.96 + $6.70 = **$23.86**

**所有交易总成本**: $26.47 + $23.86 = **$50.33**

## 💰 盈亏计算

### 假设：UP 方向 win

**周期1（DOWN方向）**:
- 交易1: Hedge(UP) win = $6.50 - $6.57 = **-$0.07**
- 交易2: Hedge(UP) win = $6.50 - $6.70 = **-$0.20**
- 交易3: Hedge(UP) win = $6.50 - $6.63 = **-$0.13**
- 交易4: Hedge(UP) win = $6.50 - $6.57 = **-$0.07**
- **周期1总盈亏**: -$0.47

**周期2（UP方向）**:
- 交易1: Entry(UP) win = $6.50 - $6.57 = **-$0.07**
- 交易2: Entry(UP) win = $6.50 - $6.63 = **-$0.13**
- 交易3: Entry(UP) win = $6.50 - $3.96 = **$2.54**（无对冲单）
- 交易4: Entry(UP) win = $6.50 - $6.70 = **-$0.20**
- **周期2总盈亏**: $2.14

**总盈亏（UP win）**: -$0.47 + $2.14 = **+$1.67**

### 假设：DOWN 方向 win

**周期1（DOWN方向）**:
- 交易1: Entry(DOWN) win = $6.50 - $6.57 = **-$0.07**
- 交易2: Entry(DOWN) win = $6.50 - $6.70 = **-$0.20**
- 交易3: Entry(DOWN) win = $6.50 - $6.63 = **-$0.13**
- 交易4: Entry(DOWN) win = $6.50 - $6.57 = **-$0.07**
- **周期1总盈亏**: -$0.47

**周期2（UP方向）**:
- 交易1: Hedge(DOWN) win = $6.50 - $6.57 = **-$0.07**
- 交易2: Hedge(DOWN) win = $6.50 - $6.63 = **-$0.13**
- 交易3: Hedge(DOWN) win = $0 - $3.96 = **-$3.96**（无对冲单）
- 交易4: Hedge(DOWN) win = $6.50 - $6.70 = **-$0.20**
- **周期2总盈亏**: -$4.36

**总盈亏（DOWN win）**: -$0.47 + (-$4.36) = **-$4.83**

## ⚠️ 问题分析

### 问题 1: 总成本 > $1.00 per share

**观察**:
- 所有交易的总成本（Entry + Hedge）都 > $6.50（即 > $1.00 per share）
- 例如：交易1的总成本 = $6.57，而如果 win 只能得到 $6.50
- **这意味着无论哪边 win，都会亏损！**

**原因**:
- Entry + Hedge 的价格总和 > 100c
- 例如：60c + 41c = 101c > 100c
- 62c + 41c = 103c > 100c
- 64c + 38c = 102c > 100c

### 问题 2: 盈亏计算逻辑错误

**当前计算逻辑**（代码第1000-1040行）:
```go
// 如果对冲单已成交
if hedgeOrderID != "" && order.Status == domain.OrderStatusFilled {
    hedgeCost := float64(hedgeAskCents) / 100.0 * hedgeFilledSize
    totalCost := entryCost + hedgeCost
    
    // UP win: 收益 = entryFilledSize * $1 - totalCost
    upWinProfit = entryFilledSize*1.0 - totalCost
    // DOWN win: 收益 = hedgeFilledSize * $1 - totalCost
    downWinProfit = hedgeFilledSize*1.0 - totalCost
}
```

**问题**:
- 这个计算是正确的，但日志显示的是**主单成交后立即计算**的盈亏
- 此时对冲单可能还没成交，所以计算的是**没有对冲单的盈亏**
- 如果对冲单成交，应该重新计算，但日志中没有显示重新计算的结果

### 问题 3: 日志中的盈亏计算不准确

**日志显示**:
```
Entry=down @ 60c size=6.5000 cost=$3.90 | UP win: $-3.90 | DOWN win: $2.60
```

**实际应该是**（如果对冲单成交）:
```
Entry=down @ 60c Hedge=up @ 41c totalCost=$6.57 | UP win: $-0.07 | DOWN win: $-0.07
```

## 🔍 根本原因

**订单簿价差导致总成本 > $1.00**:
- Entry 是 FAK（吃单），价格是 ask 价格
- Hedge 是 GTC（挂单），价格也是 ask 价格（但实际成交价格可能更好）
- 由于订单簿价差，Entry + Hedge 的 ask 价格总和通常 > 100c

**策略逻辑**:
- 策略是赚波动的钱的，不是做套利的
- Hedge 是限价单，如果市场价格下跌，可能以更好价格成交
- 但如果 Hedge 以 ask 价格成交，总成本就会 > $1.00

## 💡 解决方案

### 方案 1: 使用实际成交价格计算盈亏

**问题**: 当前盈亏计算使用的是下单时的价格，而不是实际成交价格

**解决**: 
- 在对冲单成交后，使用实际成交价格重新计算盈亏
- 如果对冲单以更好价格成交，总成本可能 < $1.00

### 方案 2: 检查实际成交价格

**问题**: 需要确认对冲单的实际成交价格

**解决**: 
- 检查订单更新回调中的实际成交价格
- 如果实际成交价格 < ask 价格，总成本可能 < $1.00

### 方案 3: 改进盈亏计算日志

**问题**: 日志中的盈亏计算不准确（没有考虑对冲单）

**解决**: 
- 在对冲单成交后，重新计算并记录盈亏
- 显示实际总成本和实际盈亏

## 📋 建议

1. **立即检查**: 查看对冲单的实际成交价格，确认是否以更好价格成交
2. **修复盈亏计算**: 在对冲单成交后，使用实际成交价格重新计算盈亏
3. **改进日志**: 显示实际总成本和实际盈亏，而不是下单时的估算

