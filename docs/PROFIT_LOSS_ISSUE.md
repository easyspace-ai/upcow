# 盈亏问题分析

## ⚠️ 核心问题

**所有交易的总成本（Entry + Hedge）都 > $1.00 per share，导致无论哪边 win 都会亏损！**

## 📊 实际计算

### 总成本计算

| 交易 | Entry价格 | Hedge价格 | Entry成本 | Hedge成本 | 总成本 | Win收益 | 盈亏 |
|------|-----------|-----------|-----------|-----------|--------|---------|------|
| 1 | 60c | 41c | $3.90 | $2.67 | $6.56 | $6.50 | **-$0.06** |
| 2 | 62c | 41c | $4.03 | $2.67 | $6.70 | $6.50 | **-$0.20** |
| 3 | 64c | 38c | $4.16 | $2.47 | $6.63 | $6.50 | **-$0.13** |
| 4 | 64c | 37c | $4.16 | $2.40 | $6.56 | $6.50 | **-$0.06** |
| 5 | 60c | 41c | $3.90 | $2.67 | $6.56 | $6.50 | **-$0.06** |
| 6 | 62c | 40c | $4.03 | $2.60 | $6.63 | $6.50 | **-$0.13** |
| 7 | 61c | ❌失败 | $3.96 | $0 | $3.96 | $6.50 | **+$2.54**（但无对冲单，风险高） |
| 8 | 64c | 39c | $4.16 | $2.54 | $6.70 | $6.50 | **-$0.20** |

**总成本**: $46.34  
**如果所有交易都 win，总收益**: $45.50  
**净盈亏**: **-$0.84**

## 🔍 根本原因

### 1. 订单簿价差导致总成本 > $1.00

**问题**:
- Entry 是 FAK（吃单），价格是 ask 价格
- Hedge 是 GTC（挂单），价格也是 ask 价格
- Entry + Hedge 的 ask 价格总和通常 > 100c（例如：60c + 41c = 101c）

**影响**:
- 如果对冲单以 ask 价格成交，总成本就会 > $1.00
- 无论哪边 win，都会亏损

### 2. 盈亏计算使用下单价格，而非实际成交价格

**代码问题**（`strategy.go` 第1026行）:
```go
hedgeCost := float64(hedgeAskCents) / 100.0 * hedgeFilledSize
```

**问题**:
- 使用 `hedgeAskCents`（下单时的 ask 价格）计算成本
- 但实际成交价格可能更好（如果对冲单是限价单，可能以 bid 价格成交）
- Order 结构没有实际成交价格字段（`FilledPrice` 或 `AveragePrice`）

**影响**:
- 无法准确计算实际盈亏
- 如果对冲单以更好价格成交，实际盈亏可能不同

### 3. 策略逻辑假设

**策略假设**:
- Hedge 是限价单，实际成交价格可能比 ask 价格更好
- 如果市场价格下跌，对冲单可能以更好价格成交
- 通过价格波动赚钱，不是通过套利

**现实**:
- 如果对冲单以 ask 价格成交，总成本 > $1.00，导致亏损
- 只有在对冲单以更好价格成交时，才能盈利

## 💡 解决方案

### 方案 1: 获取实际成交价格（推荐）

**问题**: Order 结构没有实际成交价格字段

**解决**:
1. 从交易所 API 获取订单的实际成交价格
2. 在 Order 结构中添加 `FilledPrice` 或 `AveragePrice` 字段
3. 使用实际成交价格计算成本

**优点**:
- ✅ 准确计算实际盈亏
- ✅ 了解真实交易成本

**缺点**:
- ⚠️ 需要修改 Order 结构和相关代码
- ⚠️ 需要从交易所 API 获取数据

### 方案 2: 确保 Entry + Hedge 价格总和 <= 100c

**问题**: 订单簿价差导致总成本 > $1.00

**解决**:
1. 在下单前检查 Entry + Hedge 的 ask 价格总和
2. 如果总和 > 100c，拒绝下单或调整价格

**优点**:
- ✅ 简单直接
- ✅ 避免亏损交易

**缺点**:
- ⚠️ 可能错过交易机会
- ⚠️ 不符合策略逻辑（策略是赚波动的钱的）

### 方案 3: 使用 bid 价格计算对冲单成本

**问题**: 对冲单是限价单，可能以 bid 价格成交

**解决**:
1. 使用 bid 价格（而不是 ask 价格）计算对冲单成本
2. 假设对冲单以 bid 价格成交

**优点**:
- ✅ 更接近实际成本
- ✅ 不需要修改 Order 结构

**缺点**:
- ⚠️ 仍然不准确（实际成交价格可能介于 bid 和 ask 之间）
- ⚠️ 如果对冲单以 ask 价格成交，仍然会亏损

## 📋 建议

### 短期（立即）

1. **检查实际成交价格**: 查看交易所 API 或订单详情，确认对冲单的实际成交价格
2. **如果实际成交价格 < ask 价格**: 说明策略逻辑正确，只是盈亏计算不准确
3. **如果实际成交价格 = ask 价格**: 说明总成本确实 > $1.00，需要调整策略

### 中期（1-2周）

1. **添加实际成交价格字段**: 在 Order 结构中添加 `FilledPrice` 或 `AveragePrice`
2. **从交易所获取数据**: 修改代码以获取订单的实际成交价格
3. **使用实际价格计算**: 修改盈亏计算逻辑，使用实际成交价格

### 长期（1个月+）

1. **优化策略逻辑**: 如果总成本确实 > $1.00，考虑调整策略
2. **价格保护机制**: 在下单前检查总成本，如果 > $1.00，拒绝下单或调整价格
3. **监控和告警**: 添加监控，当总成本 > $1.00 时发出告警

## 🎯 下一步行动

1. **立即检查**: 查看交易所订单详情，确认对冲单的实际成交价格
2. **如果实际价格 < ask 价格**: 修复盈亏计算逻辑，使用实际成交价格
3. **如果实际价格 = ask 价格**: 调整策略，确保总成本 <= $1.00

