# 实际成交价格修复总结

## ✅ 已完成的修复

### 1. 添加 FilledPrice 字段

**文件**: `internal/domain/order.go`

在 `Order` 结构中添加了 `FilledPrice` 字段：
```go
FilledPrice  *Price          // 实际成交价格（从 Trade 消息获取，可选）
```

### 2. 在 OrderEngine 中更新实际成交价格

**文件**: `internal/services/order_engine.go`

在处理 Trade 消息时，更新订单的实际成交价格：
- 第一次成交：直接使用 Trade 价格
- 部分成交：计算加权平均价格
- 完全成交：使用最后一次成交价格

### 3. 修改盈亏计算逻辑

**文件**: `internal/strategies/velocityfollow/strategy.go`

修改盈亏计算逻辑，优先使用实际成交价格：
- Entry 订单：优先使用 `entryOrderResult.FilledPrice`，如果没有则使用下单价格
- Hedge 订单：优先使用 `order.FilledPrice`，如果没有则使用下单价格
- 添加日志，记录实际成交价格和下单价格的对比

### 4. 添加日志

添加了详细的日志：
- Entry 使用实际成交价格时的日志
- Hedge 使用实际成交价格时的日志
- 价格差异警告（如果实际价格与下单价格不同）

## 📊 预期效果

### 修复前
- 使用下单时的 ask 价格计算成本
- 如果 Entry + Hedge 的 ask 价格总和 > 100c，无论哪边 win 都会亏损
- 无法反映实际成交价格的优势

### 修复后
- 使用 Trade 消息的实际成交价格计算成本
- 如果对冲单是限价单，实际成交价格可能更好（更接近 bid 价格）
- 盈亏计算更准确，可能发现实际盈亏比预期更好

## 🔍 关键改进

1. **实际成交价格获取**:
   - 从 WebSocket User Channel 的 Trade Message 获取
   - Trade Message 包含 `price` 字段（实际成交价格）

2. **加权平均价格**:
   - 对于部分成交，计算加权平均价格
   - 确保价格计算的准确性

3. **价格对比日志**:
   - 记录下单价格和实际成交价格
   - 如果价格差异较大，会记录警告

## 📋 下一步

1. **测试**: 运行实际交易，验证盈亏计算是否正确
2. **监控**: 观察日志中的价格差异，确认实际成交价格是否更好
3. **优化**: 根据实际数据，可能需要进一步优化策略

## ⚠️ 注意事项

1. **Trade Message 延迟**: Trade Message 可能有延迟，盈亏计算可能不是实时的
2. **部分成交**: 对于部分成交，使用加权平均价格，可能不完全准确
3. **防御性检查**: 如果实际成交价格未获取，会回退到使用下单价格

