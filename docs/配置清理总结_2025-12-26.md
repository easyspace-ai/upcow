# 配置清理总结

**清理时间**: 2025-12-26  
**清理内容**: 移除已废弃的 `oncePerCycle` 参数，整理和优化配置文件

---

## ✅ 完成的清理工作

### 1. 配置文件清理

#### `yml/velocityfollow.yaml`
- ❌ **删除**: `oncePerCycle: true`
- ✅ **替换为**: `maxTradesPerCycle: 1`（明确指定每周期只交易一次）

#### `config.yaml`
- ✅ **确认**: 原本就没有 `oncePerCycle` 配置
- ✅ **优化**: 添加了清晰的分组注释和参数说明
- ✅ **整理**: 统一了配置格式和注释风格

### 2. 代码清理

#### `internal/strategies/velocityfollow/strategy.go`
- ❌ **删除**: `oncePerCycle` 的检查逻辑（第622-626行）
- ✅ **保留**: `maxTradesPerCycle` 的检查逻辑（统一使用新参数）

**修改前**:
```go
// 5.1 兼容旧逻辑：OncePerCycle
if s.OncePerCycle && s.tradedThisCycle {
    s.mu.Unlock()
    return nil
}
// 5.2 新逻辑：MaxTradesPerCycle 控制（0=不设限）
if s.MaxTradesPerCycle > 0 && s.tradesCountThisCycle >= s.MaxTradesPerCycle {
    ...
}
```

**修改后**:
```go
// 5. 交易限制检查：MaxTradesPerCycle 控制（0=不设限）
if s.MaxTradesPerCycle > 0 && s.tradesCountThisCycle >= s.MaxTradesPerCycle {
    ...
}
```

#### `internal/strategies/velocityfollow/config.go`
- ✅ **保留**: `OncePerCycle` 字段定义（向后兼容）
- ✅ **更新**: 添加了废弃标记和警告日志
- ✅ **优化**: 如果旧配置使用了 `oncePerCycle`，会自动转换并警告

**修改后**:
```go
OncePerCycle bool `yaml:"oncePerCycle" json:"oncePerCycle"` // [已废弃] 每周期最多触发一次，请使用 maxTradesPerCycle

// 验证逻辑中添加了警告
if c.OncePerCycle && c.MaxTradesPerCycle == 0 {
    c.MaxTradesPerCycle = 1
    logrus.Warnf("[velocityfollow] oncePerCycle 已废弃，已自动设置 maxTradesPerCycle=1，建议直接使用 maxTradesPerCycle")
}
```

---

## 📋 配置优化详情

### `config.yaml` 优化内容

1. **添加了清晰的分组注释**
   - `====== 订单参数 ======`
   - `====== 速度触发参数 ======`
   - `====== 交易频率控制 ======`
   - `====== 价格和滑点保护 ======`
   - `====== 市场质量门控（提升胜率） ======`
   - `====== 价格优先选择 ======`
   - `====== 订单执行模式 ======`
   - `====== 周期保护 ======`
   - `====== 对冲单管理 ======`
   - `====== 出场（平仓）参数 ======`
   - `====== 分批止盈（提升盈亏比） ======`
   - `====== 追踪止盈（trailing） ======`
   - `====== Binance 底层确认（可选） ======`
   - `====== 库存偏斜保护 ======`

2. **统一了注释格式**
   - 每个参数都有清晰的说明
   - 添加了单位说明（分、秒、毫秒、USDC等）
   - 添加了取值范围和建议值

3. **改进了可读性**
   - 使用空行分隔不同的配置组
   - 统一了缩进和格式
   - 添加了参数的作用说明

---

## 🔄 向后兼容性

### 保留的兼容机制

1. **配置字段保留**
   - `OncePerCycle` 字段仍然存在于代码中
   - 旧配置文件如果使用了 `oncePerCycle`，仍然可以正常加载

2. **自动转换**
   - 如果 `oncePerCycle=true` 且 `maxTradesPerCycle=0`（未设置）
   - 会自动设置 `maxTradesPerCycle=1`
   - 并输出警告日志，提示使用新参数

3. **检查逻辑移除**
   - 虽然字段保留，但实际的检查逻辑已移除
   - 统一使用 `maxTradesPerCycle` 进行限制

---

## 📊 配置对比

### 清理前 vs 清理后

| 项目 | 清理前 | 清理后 |
|------|--------|--------|
| `oncePerCycle` | ✅ 存在（已废弃） | ❌ 已删除 |
| `maxTradesPerCycle` | ✅ 存在 | ✅ 存在（统一使用） |
| 代码检查逻辑 | 两套逻辑（旧+新） | 一套逻辑（新） |
| 配置注释 | 部分注释 | ✅ 完整注释 |
| 配置分组 | 无分组 | ✅ 清晰分组 |

---

## 🎯 使用建议

### 推荐配置方式

**✅ 推荐**（新配置）:
```yaml
velocityfollow:
  maxTradesPerCycle: 3  # 每周期最多交易3次（0=不设限）
```

**⚠️ 不推荐**（旧配置，但仍兼容）:
```yaml
velocityfollow:
  oncePerCycle: true    # [已废弃] 会自动转换为 maxTradesPerCycle: 1
```

### 配置值建议

- **保守策略**: `maxTradesPerCycle: 1`（每周期只交易一次）
- **平衡策略**: `maxTradesPerCycle: 2-3`（每周期交易2-3次）
- **激进策略**: `maxTradesPerCycle: 0`（不设限，但仍受 `cooldownMs` 限制）

---

## ✅ 验证结果

### 清理验证

1. ✅ `yml/velocityfollow.yaml` 中已删除 `oncePerCycle`
2. ✅ `config.yaml` 中确认没有 `oncePerCycle`
3. ✅ 代码中已移除 `oncePerCycle` 的检查逻辑
4. ✅ 保留了向后兼容机制
5. ✅ 配置文件已优化整理

### 代码检查

- ✅ 语法检查通过
- ✅ 向后兼容性保持
- ✅ 警告日志已添加

---

## 📝 后续建议

1. **更新其他配置文件**
   - 检查 `config-back.yaml`、`yml/config.yaml` 等其他配置文件
   - 如有 `oncePerCycle`，建议更新为 `maxTradesPerCycle`

2. **文档更新**
   - 更新策略文档，移除 `oncePerCycle` 的说明
   - 统一使用 `maxTradesPerCycle` 的文档

3. **测试验证**
   - 运行策略测试，确认配置加载正常
   - 验证 `maxTradesPerCycle` 的限制逻辑正常工作

---

**清理完成时间**: 2025-12-26  
**清理人员**: AI Assistant  
**状态**: ✅ 完成

