# 最小金额约束处理说明

## 📋 问题背景

### 交易所硬性要求

Polymarket 交易所要求：**每笔订单的金额必须 ≥ 1.0 USDC**

配置中我们通常设置为 `min_order_size: 1.1` (留一点余量)

### 实际场景

当价格很低时，会出现问题：

```
例如：价格 = 0.05 (5分)
策略想买入：1.5 shares
实际金额：1.5 × 0.05 = 0.075 USDC < 1.1 USDC ❌

交易所会拒绝这笔订单！
```

**需要调整数量：**
```
最小需要：1.1 / 0.05 = 22 shares
调整倍数：22 / 1.5 = 14.67x
```

---

## ✅ 解决方案

### 1. 自动调整数量

策略会自动计算并调整数量以满足最小金额要求：

```python
if order_amount < min_order_size:
    # 计算所需数量
    required_size = min_order_size / price
    adjusted_size = required_size
    
    # 检查调整倍数
    adjust_ratio = required_size / original_size
    if adjust_ratio > max_size_adjust_ratio:
        # 调整倍数太大，跳过订单
        skip_order()
    else:
        # 使用调整后的数量下单
        place_order(adjusted_size)
```

### 2. 调整倍数限制

为了防止在极低价时过度放大仓位，设置了最大调整倍数限制：

```yaml
max_size_adjust_ratio: 5.0  # 最大允许调整5倍
```

**示例：**

| 原始数量 | 价格 | 原始金额 | 需要数量 | 调整倍数 | 是否下单 |
|---------|------|---------|---------|---------|---------|
| 1.5 | 0.50 | 0.75 | 2.2 | 1.47x | ✅ 下单 2.2 |
| 1.5 | 0.20 | 0.30 | 5.5 | 3.67x | ✅ 下单 5.5 |
| 1.5 | 0.10 | 0.15 | 11.0 | 7.33x | ❌ 跳过（>5x） |
| 1.5 | 0.05 | 0.075 | 22.0 | 14.67x | ❌ 跳过（>5x） |

### 3. 配置选项

```yaml
paired_trading:
  # 最小金额要求
  min_order_size: 1.1           # 交易所要求 ≥ 1.0 USDC
  
  # 自动调整开关
  auto_adjust_size: true         # 是否自动调整（推荐开启）
  
  # 调整倍数限制
  max_size_adjust_ratio: 5.0     # 最大允许调整倍数
```

---

## 📊 实际执行示例

### 场景1: 小幅调整（常见）

```
═══════════════════════════════════════════════════════
价格: UP = 0.55
策略决策: 买入 1.5 shares
═══════════════════════════════════════════════════════

计算:
  原始金额: 1.5 × 0.55 = 0.825 USDC < 1.1 USDC ❌
  需要数量: 1.1 / 0.55 = 2.0 shares
  调整倍数: 2.0 / 1.5 = 1.33x ✓

执行:
  ⚠️ 自动调整数量以满足最小金额：
     1.5 → 2.0 shares (1.33x)
     原金额=0.825 → 新金额=1.100 USDC (价格=0.55)

结果:
  ✅ 订单成交: UP 2.0 shares @ 0.55 = 1.10 USDC
```

### 场景2: 中等调整

```
═══════════════════════════════════════════════════════
价格: DOWN = 0.25
策略决策: 买入 1.5 shares (保险单)
═══════════════════════════════════════════════════════

计算:
  原始金额: 1.5 × 0.25 = 0.375 USDC < 1.1 USDC ❌
  需要数量: 1.1 / 0.25 = 4.4 shares
  调整倍数: 4.4 / 1.5 = 2.93x ✓

执行:
  ⚠️ 自动调整数量以满足最小金额：
     1.5 → 4.4 shares (2.93x)
     原金额=0.375 → 新金额=1.100 USDC (价格=0.25)

结果:
  ✅ 订单成交: DOWN 4.4 shares @ 0.25 = 1.10 USDC
  
影响:
  - 保险单数量增加了
  - 但由于价格低，实际成本只有 1.10 USDC
  - 对整体策略影响可控
```

### 场景3: 调整过大，跳过订单

```
═══════════════════════════════════════════════════════
价格: DOWN = 0.08 (极低价！)
策略决策: 买入 1.5 shares (保险单)
═══════════════════════════════════════════════════════

计算:
  原始金额: 1.5 × 0.08 = 0.12 USDC < 1.1 USDC ❌
  需要数量: 1.1 / 0.08 = 13.75 shares
  调整倍数: 13.75 / 1.5 = 9.17x ❌ (> 5.0x)

执行:
  ⚠️ 所需调整倍数 9.17 > 最大允许 5.0，跳过下单
     原数量=1.5, 需要数量=13.75, 价格=0.08

结果:
  ⚠️ 订单跳过（未下单）
  
原因:
  - 调整倍数太大（9.17x）
  - 如果强行下单会大幅增加仓位（13.75 shares）
  - 可能破坏策略的风险控制
```

---

## 🎯 策略影响分析

### 1. 对建仓阶段的影响

**正常情况（价格 > 0.30）：**
- 调整倍数通常 < 2x
- 对策略影响很小
- 仓位控制仍然有效

**低价情况（0.15 < 价格 < 0.30）：**
- 调整倍数 2-5x
- 仓位会略微放大
- 但由于价格低，成本增加有限

**极低价（价格 < 0.15）：**
- 调整倍数 > 5x
- 订单会被跳过
- 避免过度放大仓位

### 2. 对锁定阶段的影响

**优势：**
```
极低价时的保险单：
- 原计划买入 1.5 shares @ 0.10 = 0.15 USDC (会被拒绝)
- 实际买入 11 shares @ 0.10 = 1.10 USDC (满足最小金额)
- 虽然数量增加了，但：
  1. 成本只有 1.10 USDC
  2. 大幅增强了反向保护
  3. 可能带来更好的锁定效果
```

**风险：**
```
如果频繁触发自动调整：
- 可能导致仓位失衡
- 需要更多的平衡操作
```

### 3. 对放大阶段的影响

**建议：**
- 放大阶段通常价格较高（> 0.70）
- 很少会触发最小金额约束
- 即使触发，调整倍数也很小（< 2x）

---

## ⚙️ 配置建议

### 保守配置（推荐）

```yaml
min_order_size: 1.1          # 交易所最小要求
auto_adjust_size: true       # 开启自动调整
max_size_adjust_ratio: 3.0   # 最多调整3倍（更保守）
```

适用场景：
- 小资金量（< 50 USDC）
- 希望严格控制仓位
- 可以接受偶尔跳过订单

### 标准配置

```yaml
min_order_size: 1.1
auto_adjust_size: true
max_size_adjust_ratio: 5.0   # 默认值
```

适用场景：
- 中等资金量（50-200 USDC）
- 平衡仓位控制和交易机会
- 大多数场景推荐

### 激进配置

```yaml
min_order_size: 1.1
auto_adjust_size: true
max_size_adjust_ratio: 10.0  # 允许更大调整
```

适用场景：
- 大资金量（> 200 USDC）
- 愿意接受仓位波动
- 不想错过任何交易机会

### 关闭自动调整

```yaml
min_order_size: 1.1
auto_adjust_size: false      # 关闭自动调整
max_size_adjust_ratio: 5.0   # 无效（已关闭）
```

行为：
- 金额不足时直接跳过订单
- 不会自动调整数量
- 更严格的仓位控制
- 但可能错过一些机会

---

## 📈 实时监控

### 日志输出

**正常下单：**
```
成对交易策略: [建仓阶段] 买入UP - 数量=3.0, 价格=0.55
订单已创建: ID=xxx, 数量=3.00, 价格=0.5500
```

**自动调整：**
```
成对交易策略: build_up - ⚠️ 自动调整数量以满足最小金额：
  1.5 → 2.2 shares (1.47x)
  原金额=0.825 → 新金额=1.210 USDC (价格=0.55)
订单已创建: ID=xxx, 数量=2.20, 价格=0.5500
```

**跳过订单：**
```
成对交易策略: lock_extreme_down - 所需调整倍数 9.17 > 最大允许 5.0，
  跳过下单（原数量=1.5, 需要数量=13.75, 价格=0.08）
订单跳过: 金额不足
```

### 统计建议

建议记录以下指标：
- 自动调整次数
- 平均调整倍数
- 跳过订单次数
- 调整后的平均成本

---

## 💡 最佳实践

### 1. 合理设置 build_lot_size

```yaml
# 小资金量
build_lot_size: 2.0-3.0

# 中等资金量
build_lot_size: 5.0-10.0

# 大资金量
build_lot_size: 20.0-50.0
```

原因：
- build_lot_size 越大，触发最小金额约束的概率越低
- 但也要考虑整体资金量

### 2. 监控调整频率

如果频繁触发自动调整：
```
✓ 可能需要增加 build_lot_size
✓ 或者降低 max_size_adjust_ratio（更严格）
✓ 或者调整策略的触发阈值
```

### 3. 极端价格处理

当价格 < 0.15 时：
```
策略会自动跳过小额订单（调整倍数 > 5x）
这是正常的保护机制
```

### 4. 成本控制

即使数量被放大，由于价格低：
```
价格 0.10, 调整 1.5 → 11 shares
成本增加: 0.15 → 1.10 USDC (+0.95 USDC)

但获得的保护价值可能更高：
- 11 shares @ 0.10
- 如果这个方向胜利：11 × 1.0 = 11 USDC
- 相比只有 1.5 shares，收益增加 9.5 USDC
```

---

## 🎯 总结

### 核心逻辑

```
1. 检查订单金额是否满足最小要求
2. 如果不满足：
   a. 计算所需数量
   b. 检查调整倍数
   c. 如果倍数在限制内，调整数量
   d. 如果倍数过大，跳过订单
3. 下单并记录日志
```

### 优势

✅ 自动处理交易所最小金额限制  
✅ 防止在极低价时过度放大仓位  
✅ 保持策略的风险控制  
✅ 灵活配置，适应不同场景  

### 注意事项

⚠️ 自动调整会增加仓位，需要监控  
⚠️ 极低价时可能跳过订单  
⚠️ 调整倍数设置需要根据资金量调整  
⚠️ 建议定期检查调整频率和影响

这就是成对交易策略对最小金额约束的完整处理方案！🎉
