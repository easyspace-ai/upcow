# 四个订单的下单顺序分析

## 📋 订单概览

根据日志分析，本次交易共下了 **4 个订单**，但只有 **2 个订单成交**，还有 **2 个挂单未及时取消**。

## 🔍 四个订单的详细分析

### 订单时间线

| 序号 | OrderID (前20字符) | 下单时间 | AssetID | 类型 | 状态 | 数量 |
|------|-------------------|---------|---------|------|------|------|
| **1** | `0xa3fd8459...` | 06:02:38 | UP Asset | **Entry (UP)** | ✅ **filled** | 11 shares |
| **2** | `0xe1e09c00...` | 06:02:39 | UP Asset | **重复 Entry?** | ❌ **failed** | 11 shares |
| **3** | `0xc32a5dc6...` | 06:02:40 | UP Asset | **重复 Entry?** | ❌ **canceled** | 11 shares |
| **4** | `0x910de405...` | 06:02:40 | DOWN Asset | **Hedge (DOWN)** | ✅ **filled** | 11 shares |

### 订单详情

#### 订单1: Entry 订单 (UP @ 64¢) ✅
- **OrderID**: `0xa3fd8459e68b7092ee669a7ca718b90bd57cf1a7351c928d3b98b0b7eb1f549b`
- **AssetID**: `104299859903721549039131367077715723770035365029446591632104934464740593704474` (UP)
- **下单时间**: 2025-12-25 06:02:38
- **价格**: 64¢
- **数量**: 11 shares
- **状态**: ✅ **filled** (已成交)
- **类型**: Entry (FAK 订单)

#### 订单2: 重复 Entry 订单? ❌
- **OrderID**: `0xe1e09c008c0cd6e1329953f92b2f4d72f1fffbee75c1e54068358dc3aa840689`
- **AssetID**: `104299859903721549039131367077715723770035365029446591632104934464740593704474` (UP)
- **下单时间**: 2025-12-25 06:02:39 (订单1 后 1 秒)
- **价格**: 未知
- **数量**: 11 shares
- **状态**: ❌ **failed** (对账告警显示不在交易所 open 列表)
- **类型**: 可能是重复的 Entry 订单

#### 订单3: 重复 Entry 订单? ❌
- **OrderID**: `0xc32a5dc605ea8551f0ee0da3e0e07453a160641b9369119d8cccc5b2e1e78bd5`
- **AssetID**: `104299859903721549039131367077715723770035365029446591632104934464740593704474` (UP)
- **下单时间**: 2025-12-25 06:02:40 (订单1 后 2 秒)
- **价格**: 33¢ (从取消日志看)
- **数量**: 11 shares
- **状态**: ❌ **canceled** (用户手动取消，06:03:28)
- **类型**: 可能是重复的 Entry 订单或错误的 Hedge 订单

#### 订单4: Hedge 订单 (DOWN @ 33¢) ✅
- **OrderID**: `0x910de4050248e4b555340d47371aa3f02418bc3c7b10ee5f2285d5c368c337fa`
- **AssetID**: `24054276575154719324614603670823282087656563436312221171284136207867107152181` (DOWN)
- **下单时间**: 2025-12-25 06:02:40
- **价格**: 33¢
- **数量**: 11 shares
- **状态**: ✅ **filled** (已成交)
- **类型**: Hedge (GTC 限价单)

## ⚠️ 问题分析

### 1. 为什么有多个 Entry 订单？

**可能原因**:
1. **Entry 订单失败后重试**: 从日志看，有 2 个 Entry 订单失败（FAK 订单，市场流动性不足）
2. **系统重试逻辑**: 当 Entry 订单失败时，系统可能自动重试
3. **并发问题**: 多个 goroutine 同时触发下单

**证据**:
- 日志显示有 2 个 Entry 订单失败：`order_1766613757697093000` 和 `order_1766613759121459000`
- 这些失败订单可能导致系统重试

### 2. 为什么挂单没有及时取消？

**问题**: 订单2 和 订单3 都是失败的订单，但系统没有及时取消它们。

**可能原因**:
1. **velocityfollow 策略没有取消逻辑**: 从代码看，策略只负责下单，不负责取消旧订单
2. **失败订单处理**: 当 Entry 订单失败时，系统可能没有取消对应的 Hedge 订单
3. **对账延迟**: 系统通过对账发现订单不在交易所，但已经过了很长时间

**证据**:
- 对账告警显示订单2 和 订单3 都不在交易所的 open 列表中
- 订单3 直到 06:03:28 才被用户手动取消（距离下单 48 秒）

### 3. 订单3 为什么是 UP Asset 但价格是 33¢？

**异常**: 订单3 的 AssetID 是 UP Asset，但取消日志显示价格是 33¢（应该是 Hedge 价格）。

**可能原因**:
- 日志解析错误
- 或者订单3 实际上是 Hedge 订单，但 AssetID 记录错误

## 🔧 解决方案建议

### 1. 添加订单取消逻辑

**问题**: velocityfollow 策略没有取消旧订单的逻辑。

**建议**: 在下单前，取消同方向的旧订单：

```go
// 在下单前，取消同方向的旧订单
if s.lastEntryOrderID != "" {
    // 取消旧的 Entry 订单
    _ = s.TradingService.CancelOrder(ctx, s.lastEntryOrderID)
}
if s.lastHedgeOrderID != "" {
    // 取消旧的 Hedge 订单
    _ = s.TradingService.CancelOrder(ctx, s.lastHedgeOrderID)
}
```

### 2. Entry 订单失败时取消 Hedge 订单

**问题**: 当 Entry 订单失败时，Hedge 订单仍然挂单。

**建议**: 在订单失败回调中，取消对应的 Hedge 订单：

```go
func (s *Strategy) OnOrderUpdate(ctx context.Context, order *domain.Order) error {
    if order.Status == domain.OrderStatusFailed {
        // Entry 订单失败，取消对应的 Hedge 订单
        if order.IsEntryOrder && order.HedgeOrderID != nil {
            _ = s.TradingService.CancelOrder(ctx, *order.HedgeOrderID)
        }
    }
    return nil
}
```

### 3. 添加订单去重逻辑

**问题**: 系统可能重复下单。

**建议**: 在下单前检查是否已有相同方向的订单：

```go
// 检查是否已有相同方向的订单
activeOrders := s.TradingService.GetActiveOrders()
for _, o := range activeOrders {
    if o.TokenType == winner && o.Status == domain.OrderStatusOpen {
        // 已有相同方向的订单，跳过
        return nil
    }
}
```

## 📊 下单顺序总结

### 正常流程（应该是）

1. **06:02:38** - 下单 Entry (UP @ 64¢) ✅
2. **06:02:38** - 下单 Hedge (DOWN @ 33¢) ✅
3. **06:02:39** - Entry 订单成交 ✅
4. **06:02:40** - Hedge 订单成交 ✅

### 实际流程（发生了）

1. **06:02:38** - 下单 Entry (UP @ 64¢) ✅
2. **06:02:39** - Entry 订单失败，系统重试？❌
3. **06:02:39** - 下单另一个 Entry 订单（订单2）❌
4. **06:02:40** - 下单另一个 Entry 订单（订单3）❌
5. **06:02:40** - 下单 Hedge (DOWN @ 33¢) ✅
6. **06:02:39** - Entry 订单1 成交 ✅
7. **06:02:40** - Hedge 订单成交 ✅
8. **06:03:28** - 用户手动取消订单3 ❌

## 🎯 关键发现

1. **Entry 订单失败导致重复下单**: 系统在 Entry 订单失败后可能重试，导致多个 Entry 订单
2. **没有取消逻辑**: velocityfollow 策略没有取消旧订单的逻辑
3. **失败订单未及时处理**: 失败的订单没有及时取消，导致挂单

## 💡 建议

1. **添加订单取消逻辑**: 在下单前取消同方向的旧订单
2. **Entry 失败时取消 Hedge**: 当 Entry 订单失败时，自动取消对应的 Hedge 订单
3. **添加订单去重**: 防止重复下单
4. **改进错误处理**: 当订单失败时，及时清理相关订单

---

**报告生成时间**: 2025-12-25  
**问题**: 多个 Entry 订单，挂单未及时取消  
**建议**: 添加订单取消和去重逻辑

