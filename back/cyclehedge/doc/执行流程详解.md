# CycleHedge ç­–ç•¥æ‰§è¡Œæµç¨‹è¯¦è§£

## ç›®å½•

1. [ç­–ç•¥æ¦‚è¿°](#ç­–ç•¥æ¦‚è¿°)
2. [ç­–ç•¥åˆå§‹åŒ–](#ç­–ç•¥åˆå§‹åŒ–)
3. [å‘¨æœŸé‡ç½®æµç¨‹](#å‘¨æœŸé‡ç½®æµç¨‹)
4. [ä¸»å¾ªç¯æ‰§è¡Œæµç¨‹](#ä¸»å¾ªç¯æ‰§è¡Œæµç¨‹)
5. [å…³é”®å†³ç­–é€»è¾‘](#å…³é”®å†³ç­–é€»è¾‘)
6. [å®Œæ•´æ¨¡æ‹Ÿç¤ºä¾‹](#å®Œæ•´æ¨¡æ‹Ÿç¤ºä¾‹)
7. [é£é™©æ§åˆ¶æœºåˆ¶](#é£é™©æ§åˆ¶æœºåˆ¶)
8. [å‘¨æœŸæŠ¥è¡¨](#å‘¨æœŸæŠ¥è¡¨)

---

## ç­–ç•¥æ¦‚è¿°

### æ ¸å¿ƒæ€æƒ³

CycleHedge æ˜¯ä¸€ä¸ªåŸºäº **complete-set** çš„å¸‚åœºä¸­æ€§é”åˆ©ç­–ç•¥ã€‚æ ¸å¿ƒåŸç†æ˜¯ï¼š

- åœ¨åŒä¸€å¸‚åœºå‘¨æœŸå†…ï¼ŒåŒæ—¶ä¹°å…¥ç­‰é‡çš„ YES å’Œ NO ä»£å¸ï¼ˆä¸¤è…¿ï¼‰
- æŒæœ‰åˆ°ç»“ç®—æ—¶ï¼Œæ¯å¥— complete-set å¯ä»¥è·å¾— $1.00
- åªè¦ä¸¤è…¿çš„å»ºä»“æ€»æˆæœ¬ â‰¤ $1.00 - profitï¼Œå°±èƒ½é”å®šç¡®å®šæ”¶ç›Š

### ç­–ç•¥ç›®æ ‡

- **é”åˆ©èŒƒå›´**ï¼šæ¯ä¸ª 15 åˆ†é’Ÿå‘¨æœŸé”å®š 1~5 åˆ†ï¼ˆcentsï¼‰çš„ç¡®å®šæ”¶ç›Š
- **æ‰§è¡Œæ–¹å¼**ï¼šä»¥ makerï¼ˆæŒ‚å•ï¼‰ä¸ºä¸»ï¼Œé¿å…é«˜é¢‘åƒå•
- **èµ„é‡‘ç®¡ç†**ï¼šæŒ‰ä½™é¢æ»šåŠ¨æ”¾å¤§ï¼Œå®ç°å¤åˆ©å¢é•¿

### å…³é”®ç‰¹æ€§

1. **Maker ä¼˜å…ˆ**ï¼šä¼˜å…ˆä½¿ç”¨ GTC æŒ‚å•ï¼Œé™ä½äº¤æ˜“æˆæœ¬
2. **è‡ªåŠ¨è¡¥é½**ï¼šå‡ºç°å•è…¿æˆäº¤æ—¶ï¼Œè‡ªåŠ¨è¡¥é½æˆ–å›å¹³ï¼Œé¿å…è£¸éœ²é£é™©
3. **åŠ¨æ€è°ƒæ•´**ï¼šæ ¹æ®å‰©ä½™æ—¶é—´å’Œå¸‚åœºæƒ…å†µåŠ¨æ€è°ƒæ•´æŠ¥ä»·å’Œé£é™©å‚æ•°
4. **æ»šåŠ¨å¤åˆ©**ï¼šæ¯å‘¨æœŸæŒ‰ä½™é¢æ¯”ä¾‹è‡ªåŠ¨æ”¾å¤§ç›®æ ‡è§„æ¨¡

---

## ç­–ç•¥åˆå§‹åŒ–

### Initialize() æ–¹æ³•

ä½ç½®ï¼š`strategy.go:94-126`

åˆå§‹åŒ–æ­¥éª¤ï¼š

1. **åˆ›å»ºé€šé“**ï¼š
   - `signalC`ï¼šç”¨äºè§¦å‘ step æ‰§è¡Œï¼ˆå®¹é‡ 1ï¼‰
   - `orderC`ï¼šç”¨äºæ¥æ”¶è®¢å•æ›´æ–°ï¼ˆå®¹é‡ 256ï¼‰

2. **åˆå§‹åŒ–çŠ¶æ€**ï¼š
   - `latest`ï¼šå­˜å‚¨æœ€æ–°çš„ä»·æ ¼äº‹ä»¶ï¼ˆæŒ‰ TokenType ç´¢å¼•ï¼‰
   - `stats.ProfitChoice`ï¼šç»Ÿè®¡ profit é€‰æ‹©åˆ†å¸ƒ

3. **å¸‚åœºè¿‡æ»¤è®¾ç½®**ï¼š
   - ä»å…¨å±€é…ç½®è¯»å– `Market.SlugPrefix`
   - è®¾ç½® `marketSlugPrefix`ï¼Œç”¨äºåç»­å¸‚åœºè¿‡æ»¤
   - **å®‰å…¨æœºåˆ¶**ï¼šå¦‚æœé…ç½®æœªåŠ è½½æˆ– marketSlugPrefix ä¸ºç©ºï¼Œæ‹’ç»å¯åŠ¨ï¼ˆé¿å…è¯¯äº¤æ˜“ï¼‰

```go
// å…³é”®ä»£ç ç‰‡æ®µ
if s.marketSlugPrefix == "" {
    return fmt.Errorf("[%s] marketSlugPrefix ä¸ºç©ºï¼šæ‹’ç»å¯åŠ¨ï¼ˆé¿å…è¯¯äº¤æ˜“ï¼‰", ID)
}
```

### Subscribe() æ–¹æ³•

ä½ç½®ï¼š`strategy.go:128-132`

è®¢é˜…äº‹ä»¶ï¼š

- `OnPriceChanged`ï¼šä»·æ ¼å˜åŒ–äº‹ä»¶
- `OnOrderUpdate`ï¼šè®¢å•çŠ¶æ€æ›´æ–°äº‹ä»¶

è¿™äº›äº‹ä»¶ä¼šè§¦å‘ `signalC`ï¼Œä»è€Œå”¤é†’ä¸»å¾ªç¯æ‰§è¡Œ `step()`ã€‚

### Run() æ–¹æ³•

ä½ç½®ï¼š`strategy.go:134-141`

å¯åŠ¨ä¸»å¾ªç¯ï¼š

- åŸºç¡€ tick é—´éš”ï¼š`baseLoopTickMs()` è¿”å›çš„æœ€å°å€¼ï¼ˆé»˜è®¤ 200msï¼‰
- ä½¿ç”¨ `common.StartLoopOnce` ç¡®ä¿åªå¯åŠ¨ä¸€æ¬¡
- å¾ªç¯åœ¨ `ctx.Done()` æ—¶é€€å‡º

```go
tick := time.Duration(s.baseLoopTickMs()) * time.Millisecond
common.StartLoopOnce(ctx, &s.loopOnce, func(cancel context.CancelFunc) { 
    s.loopCancel = cancel 
}, tick, s.loop)
```

---

## å‘¨æœŸé‡ç½®æµç¨‹

### OnCycle() å›è°ƒ

ä½ç½®ï¼š`strategy.go:143-154`

è§¦å‘æ—¶æœºï¼šå½“æ£€æµ‹åˆ°æ–°çš„å¸‚åœºå‘¨æœŸæ—¶ï¼ˆç”±å¤–éƒ¨å‘¨æœŸç®¡ç†å™¨è°ƒç”¨ï¼‰

æ‰§è¡Œæ­¥éª¤ï¼š

1. **å‘¨æœŸç»“æŸå¤„ç†**ï¼š
   - å¦‚æœ `oldMarket != nil`ï¼Œè°ƒç”¨ `finalizeAndReport()` ç”Ÿæˆæ—§å‘¨æœŸæŠ¥è¡¨

2. **å‘¨æœŸé‡ç½®**ï¼š
   - è°ƒç”¨ `resetCycle()` é‡ç½®çŠ¶æ€å¹¶åˆå§‹åŒ–æ–°å‘¨æœŸ

### resetCycle() æ–¹æ³•

ä½ç½®ï¼š`strategy.go:979-1050`

è¯¦ç»†æ‰§è¡Œæµç¨‹ï¼š

#### 1. æ¸…ç†æ—§å‘¨æœŸçŠ¶æ€

```go
s.currentMarketSlug = m.Slug
s.cycleStartUnix = m.Timestamp
s.targetNotional = 0
s.targetProfitCents = 0
s.targetShares = 0
s.yesOrderID, s.noOrderID = "", ""
s.firstFillAt = time.Time{}
s.lastLogAt = time.Time{}
s.lastCancelAt = time.Time{}
s.lastQuoteAt = time.Time{}
s.closeoutActive = false
s.lastSupplementAt = time.Time{}
```

#### 2. é‡ç½®ç»Ÿè®¡ä¿¡æ¯

```go
s.stats = cycleStats{
    MarketSlug: m.Slug,
    CycleStartUnix: m.Timestamp,
    TargetNotionalUSDC: 0,
    TargetShares: 0,
    ProfitChoice: make(map[int]int64),
}
```

#### 3. æ’¤æ‰æ—§æŒ‚å•

è°ƒç”¨ `cancelMarketOrdersThrottled()` æ¸…ç†æœ¬å‘¨æœŸæ—§æŒ‚å•ï¼ˆä¿é™©æªæ–½ï¼‰ã€‚

#### 4. åˆ·æ–°ä½™é¢

```go
refreshCtx, cancel := context.WithTimeout(ctx, 10*time.Second)
_ = s.TradingService.RefreshBalance(refreshCtx)
cancel()
bal, _ := s.TradingService.GetBalanceUSDC()
```

#### 5. è®¡ç®—ç›®æ ‡ Notional

**å›ºå®šæ¨¡å¼**ï¼ˆ`FixedNotionalUSDC > 0`ï¼‰ï¼š
```go
tn = s.FixedNotionalUSDC
// å®‰å…¨æŠ¤æ ï¼šä¸è¶…è¿‡å¯ç”¨ä½™é¢
cap := bal * s.BalanceAllocationPct
if tn > cap {
    tn = cap
}
```

**æ»šåŠ¨æ¨¡å¼**ï¼ˆ`FixedNotionalUSDC == 0`ï¼‰ï¼š
```go
tn = math.Max(s.MinNotionalUSDC, bal * s.BalanceAllocationPct)
tn = math.Min(tn, s.MaxNotionalUSDC)
tn = math.Max(tn, s.MinNotionalUSDC)
```

**ç¤ºä¾‹**ï¼š
- ä½™é¢ï¼š1000 USDC
- `BalanceAllocationPct`ï¼š0.8
- `MinNotionalUSDC`ï¼š30
- `MaxNotionalUSDC`ï¼š3000
- è®¡ç®—ç»“æœï¼š`tn = max(30, 1000*0.8) = 800`ï¼Œç„¶å `min(800, 3000) = 800`

#### 6. è®°å½•ç›®æ ‡

```go
s.targetNotional = tn
s.stats.TargetNotionalUSDC = tn
```

---

## ä¸»å¾ªç¯æ‰§è¡Œæµç¨‹

### loop() æ–¹æ³•

ä½ç½®ï¼š`strategy.go:183-194`

ä¸»å¾ªç¯ç»“æ„ï¼š

```go
for {
    select {
    case <-loopCtx.Done():
        return
    case <-s.signalC:  // ä»·æ ¼/è®¢å•äº‹ä»¶è§¦å‘
        s.step(loopCtx, time.Now())
    case <-tickC:     // å®šæ—¶tickè§¦å‘
        s.step(loopCtx, time.Now())
    }
}
```

### step() æ–¹æ³•è¯¦è§£

ä½ç½®ï¼š`strategy.go:196-831`

è¿™æ˜¯ç­–ç•¥çš„æ ¸å¿ƒæ‰§è¡Œå‡½æ•°ï¼Œæ¯ä¸ª tick éƒ½ä¼šæ‰§è¡Œã€‚ä¸‹é¢è¯¦ç»†è¯´æ˜æ¯ä¸ªæ­¥éª¤ï¼š

#### æ­¥éª¤ 1ï¼šåˆå¹¶ä»·æ ¼äº‹ä»¶

ä½ç½®ï¼š`strategy.go:201-206`

```go
s.priceMu.Lock()
evUp := s.latest[domain.TokenTypeUp]
evDown := s.latest[domain.TokenTypeDown]
s.latest = make(map[domain.TokenType]*events.PriceChangedEvent)  // æ¸…ç©º
s.priceMu.Unlock()
```

**ç›®çš„**ï¼šåˆå¹¶åŒä¸€ tick å†…çš„å¤šä¸ªä»·æ ¼æ›´æ–°äº‹ä»¶ï¼Œå–æœ€æ–°çš„ market ä¿¡æ¯ã€‚

#### æ­¥éª¤ 2ï¼šè·å–å¸‚åœºå¯¹è±¡

ä½ç½®ï¼š`strategy.go:208-219`

ä¼˜å…ˆä½¿ç”¨ `evUp.Market`ï¼Œå¦‚æœä¸ºç©ºåˆ™ä½¿ç”¨ `evDown.Market`ã€‚å¦‚æœéƒ½æ²¡æœ‰ï¼Œåˆ™æ¶ˆè´¹è®¢å•æ›´æ–°åè¿”å›ã€‚

#### æ­¥éª¤ 3ï¼šå¸‚åœºè¿‡æ»¤

ä½ç½®ï¼š`strategy.go:221-225`

```go
if !strings.HasPrefix(strings.ToLower(m.Slug), s.marketSlugPrefix) {
    s.drainOrders()
    return
}
```

**ç›®çš„**ï¼šåªå¤„ç†åŒ¹é… `marketSlugPrefix` çš„å¸‚åœºï¼Œé¿å…è¯¯äº¤æ˜“å…¶ä»–å¸‚åœºã€‚

#### æ­¥éª¤ 4ï¼šå‘¨æœŸæ£€æµ‹

ä½ç½®ï¼š`strategy.go:227-235`

```go
if m.Timestamp > 0 {
    needReset := s.cycleStartUnix == 0 || 
                 s.cycleStartUnix != m.Timestamp || 
                 s.currentMarketSlug != m.Slug
    if needReset {
        s.resetCycle(ctx, now, m)
    }
}
```

**ç›®çš„**ï¼šæ£€æµ‹æ˜¯å¦è¿›å…¥æ–°å‘¨æœŸï¼Œå¦‚æœæ˜¯åˆ™é‡ç½®çŠ¶æ€ã€‚

#### æ­¥éª¤ 5ï¼šCloseout çª—å£å¤„ç†

ä½ç½®ï¼š`strategy.go:237-257`

**Closeout å®šä¹‰**ï¼šå‘¨æœŸç»“æŸå‰ `EntryCutoffSeconds` ç§’ï¼ˆé»˜è®¤ 25 ç§’ï¼‰ä¸å†æ–°å¢å»ºä»“ã€‚

```go
inCloseout := s.EntryCutoffSeconds > 0 && s.withinEntryCutoff(m)
```

**å¤„ç†é€»è¾‘**ï¼š

- **è¿›å…¥ closeout**ï¼š
  - è®¾ç½® `closeoutActive = true`ï¼ˆæ¯å‘¨æœŸåªè®¾ç½®ä¸€æ¬¡ï¼‰
  - æ‰§è¡Œä¸€æ¬¡æ’¤å•æ¸…åœºï¼ˆé¿å…åç»­è¡¥é½æŒ‚å•è¢«é‡å¤æ’¤æ‰ï¼‰

- **ç¦»å¼€ closeout**ï¼š
  - é‡ç½® `closeoutActive = false`

#### æ­¥éª¤ 6ï¼šè®¡ç®—å‰©ä½™æ—¶é—´

ä½ç½®ï¼š`strategy.go:259-260`

```go
remainingSeconds := s.remainingSeconds(now, m)
```

**ç”¨é€”**ï¼šç”¨äºå°¾ç›˜åŠ¨æ€å‚æ•°è°ƒæ•´ï¼ˆrequote é¢‘ç‡ã€è¶…æ—¶æ—¶é—´ã€é¢„ç®—ç­‰ï¼‰ã€‚

#### æ­¥éª¤ 7ï¼šç›˜å£è´¨é‡æ£€æŸ¥

ä½ç½®ï¼š`strategy.go:262-283`

```go
mq, err := s.TradingService.GetMarketQuality(orderCtx, m, &services.MarketQualityOptions{
    MaxBookAge:     time.Duration(s.MarketQualityMaxBookAgeMs) * time.Millisecond,
    MaxSpreadPips: s.MarketQualityMaxSpreadCents * 100,
    PreferWS:       true,
    FallbackToREST: true,
    AllowPartialWS: true,
})
```

**è´¨é‡ Gate**ï¼ˆå¦‚æœå¯ç”¨ï¼‰ï¼š
- å¦‚æœ `mq == nil` æˆ– `mq.Score < MarketQualityMinScore`ï¼Œç›´æ¥è¿”å›
- **ç›®çš„**ï¼šé¿å…åœ¨ stale/wide spread/è„é•œåƒçš„ç›˜å£ä¸Šäº¤æ˜“

#### æ­¥éª¤ 8ï¼šè¯»å– Top-of-Book

ä½ç½®ï¼š`strategy.go:285-296`

```go
yesBid, yesAsk, noBid, noAsk, source, err := s.TradingService.GetTopOfBook(orderCtx, m)
yesBidC, yesAskC := yesBid.ToCents(), yesAsk.ToCents()
noBidC, noAskC := noBid.ToCents(), noAsk.ToCents()
```

**ç›®çš„**ï¼šè·å–å½“å‰ç›˜å£æœ€ä¼˜ä¹°å–ä»·ï¼Œç”¨äºåç»­æŠ¥ä»·è®¡ç®—ã€‚

#### æ­¥éª¤ 9ï¼šè¯»å–å½“å‰æŒä»“

ä½ç½®ï¼š`strategy.go:298-302`

```go
upShares, downShares := s.currentShares(m.Slug)
minShares := math.Min(upShares, downShares)
maxShares := math.Max(upShares, downShares)
unhedged := maxShares - minShares
```

**å…³é”®å˜é‡**ï¼š
- `minShares`ï¼šå·²é”å®šçš„ complete-set æ•°é‡
- `unhedged`ï¼šå•è…¿è£¸éœ²æ•°é‡

#### æ­¥éª¤ 10ï¼šCloseout çª—å£æ£€æŸ¥ï¼ˆæ— è£¸éœ²æ—¶åœæ­¢ï¼‰

ä½ç½®ï¼š`strategy.go:304-308`

```go
if inCloseout && unhedged < s.MinUnhedgedShares {
    return  // æ²¡æœ‰è£¸éœ²ï¼Œåœæ­¢æ–°å¢
}
```

**ç›®çš„**ï¼šåœ¨ closeout çª—å£å†…ï¼Œå¦‚æœæ²¡æœ‰è£¸éœ²é£é™©ï¼Œå°±ä¸å†æ–°å¢å»ºä»“ï¼ŒåªæŒæœ‰åˆ°ç»“ç®—ã€‚

#### æ­¥éª¤ 11ï¼šæœ€å¤§å•å‘æŒä»“æ£€æŸ¥

ä½ç½®ï¼š`strategy.go:310-325`

```go
if s.MaxSingleSideShares > 0 && maxShares >= s.MaxSingleSideShares {
    if unhedged < s.MinUnhedgedShares {
        _ = s.cancelMarketOrdersThrottled(ctx, now, m, false)
        return  // æ²¡æœ‰è£¸éœ²ï¼Œåœæ­¢æ–°å¢
    }
    // è‹¥æœ‰è£¸éœ²ï¼Œç»§ç»­èµ°ä¸‹æ–¹è¡¥é½/å›å¹³é€»è¾‘
}
```

**ç›®çš„**ï¼šé™åˆ¶å•è¾¹æŒä»“è§„æ¨¡ï¼Œé¿å…é£é™©ç´¯ç§¯ã€‚

#### æ­¥éª¤ 12ï¼šç›®æ ‡è¾¾æˆæ£€æŸ¥

ä½ç½®ï¼š`strategy.go:327-338`

```go
if targetShares > 0 && minShares >= targetShares {
    s.cancelMarketOrdersThrottled(ctx, now, m, false)
    s.maybeLog(now, m, fmt.Sprintf("locked: profit=%dc ..."))
    return  // å·²è¾¾æˆç›®æ ‡ï¼Œæ’¤å•æŒæœ‰åˆ°ç»“ç®—
}
```

**ç›®çš„**ï¼šå¦‚æœå·²é”å®šè¶³å¤Ÿçš„ complete-setï¼Œæ’¤æ‰æŒ‚å•ï¼ŒæŒæœ‰åˆ°ç»“ç®—ã€‚

#### æ­¥éª¤ 13ï¼šå•è…¿è£¸éœ²å¤„ç†ï¼ˆæ ¸å¿ƒé£é™©æ§åˆ¶ï¼‰

ä½ç½®ï¼š`strategy.go:340-655`

è¿™æ˜¯ç­–ç•¥æœ€å¤æ‚çš„éƒ¨åˆ†ï¼ŒåŒ…å«å¤šä¸ªé˜¶æ®µï¼š

##### 13.1 è®°å½•é¦–æ¬¡æˆäº¤æ—¶é—´

```go
if firstFillAt.IsZero() {
    s.firstFillAt = now
}
age := now.Sub(firstFillAt)
```

##### 13.2 è®¡ç®—åŠ¨æ€è¶…æ—¶å’Œé¢„ç®—

```go
timeoutSec := s.dynamicUnhedgedTimeoutSeconds(remainingSeconds)
budget := s.dynamicUnhedgedBudgetShares(remainingSeconds)
force := (budget > 0 && unhedged >= budget)
```

**åŠ¨æ€è¶…æ—¶**ï¼š
- é»˜è®¤ï¼š`UnhedgedTimeoutSeconds`ï¼ˆå¦‚ 10 ç§’ï¼‰
- Closeout çª—å£å†…ï¼šç¼©çŸ­åˆ° 2 ç§’
- ç»“ç®—å‰ 5 åˆ†é’Ÿï¼šç¼©çŸ­åˆ° 5 ç§’

**åŠ¨æ€é¢„ç®—**ï¼š
- é»˜è®¤ï¼š`MaxUnhedgedSharesBudget`
- ç»“ç®—å‰ 3 åˆ†é’Ÿï¼šç¼©å°åˆ° 25%
- ç»“ç®—å‰ 5 åˆ†é’Ÿï¼šç¼©å°åˆ° 50%

##### 13.3 æ’¤æ‰å¤šä½™è…¿çš„æŒ‚å•

```go
if upShares > downShares {
    excessTok = domain.TokenTypeUp
    excessOrderID = s.yesOrderID
} else {
    excessTok = domain.TokenTypeDown
    excessOrderID = s.noOrderID
}
if excessOrderID != "" {
    _ = s.TradingService.CancelOrder(cancelCtx, excessOrderID)
}
```

**ç›®çš„**ï¼šé¿å…ç»§ç»­è¢«åŠ¨æˆäº¤æ‰©å¤§è£¸éœ²ã€‚

##### 13.4 Maker è¡¥é½ï¼ˆä¸‰é˜¶æ®µç­–ç•¥ï¼‰

**é˜¶æ®µ A**ï¼ˆ`age < window`ï¼‰ï¼šåœ¨ç¼ºè…¿ bestBid æŒ‚å•

**é˜¶æ®µ B**ï¼ˆ`window <= age < timeout`ï¼‰ï¼šæ›´æ¿€è¿›ï¼ˆbid + bumpï¼‰ï¼Œä½†ä»ä¿æŒ maker

**é˜¶æ®µ C**ï¼ˆ`age >= timeout` æˆ– `force` æˆ– `closeout`ï¼‰ï¼šè¿›å…¥ taker/flatten å…œåº•

```go
if s.EnableMakerSupplement && !force && age < time.Duration(timeoutSec)*time.Second {
    windowSec := s.dynamicMakerSupplementWindowSeconds(remainingSeconds, timeoutSec)
    bumpC := 0
    if age >= time.Duration(windowSec)*time.Second {
        bumpC = s.dynamicMakerSupplementBumpCents(remainingSeconds)
    }
    
    // è®¡ç®—æŒ‚å•ä»·æ ¼
    priceC := missingBidC + bumpC
    
    // å¯é€‰ï¼šè´´åˆ° ask-1ï¼ˆæœ€æ¿€è¿›ä½†ä»ä¿æŒ makerï¼‰
    if s.shouldSnapMakerSupplementToAskMinusOne(...) {
        priceC = missingAskC - 1
    }
    
    // ä¸‹ maker è¡¥é½å•
    ord, _ := s.TradingService.PlaceOrder(placeCtx, &domain.Order{
        TokenType: missingTok,
        Side: types.SideBuy,
        Price: domain.Price{Pips: priceC * 100},
        Size: size,
        OrderType: types.OrderTypeGTC,
    })
}
```

**è¿½ä»·é€»è¾‘**ï¼šå¦‚æœå·²æœ‰ç¼ºè…¿æŒ‚å•ï¼Œä¸”ä»·æ ¼éœ€è¦è°ƒæ•´ï¼Œå…ˆæ’¤å•å†é‡æ–°æŒ‚å•ï¼ˆèŠ‚æµæ§åˆ¶ï¼‰ã€‚

##### 13.5 Taker è¡¥é½æˆ–å›å¹³ï¼ˆè¶…æ—¶å…œåº•ï¼‰

**å†³ç­–é€»è¾‘**ï¼šæ¯”è¾ƒ"è¡¥é½"å’Œ"å›å¹³"çš„ç¡®å®šæ€§æ”¶ç›Šï¼Œé€‰æ‹©æ›´ä¼˜æ–¹æ¡ˆã€‚

```go
// è¡¥é½æ”¶ç›Šï¼šä¹°å…¥ missingAskï¼Œç»“ç®—å¾—åˆ° $1/ä»½
completeProfitPerSetC := 100 - excessAvgC - missingAskC
completeProfitC := float64(completeProfitPerSetC) * size

// å›å¹³æ”¶ç›Šï¼šç«‹å³å–å‡º excessBid
flattenProfitC := float64(excessBidC - excessAvgC) * size

// é€‰æ‹©æ›´ä¼˜æ–¹æ¡ˆ
if allowComplete && allowFlatten {
    doComplete = completeProfitC >= flattenProfitC
} else if allowComplete {
    doComplete = true
} else {
    doComplete = false  // åªèƒ½å›å¹³
}
```

**æ‰§è¡Œ**ï¼š
- **è¡¥é½**ï¼šä½¿ç”¨ FAK è®¢å•ï¼Œä»¥ `missingAsk` ä»·æ ¼ä¹°å…¥
- **å›å¹³**ï¼šä½¿ç”¨ FAK è®¢å•ï¼Œä»¥ `excessBid` ä»·æ ¼å–å‡º

#### æ­¥éª¤ 14ï¼šåŠ¨æ€ Requoteï¼ˆæ­£å¸¸å»ºä»“è·¯å¾„ï¼‰

ä½ç½®ï¼š`strategy.go:657-670`

```go
if !inCloseout {
    requoteMs := s.dynamicRequoteMs(remainingSeconds)
    if requoteMs > 0 {
        if now.Sub(s.lastQuoteAt) < time.Duration(requoteMs)*time.Millisecond {
            return  // èŠ‚æµï¼šæœªåˆ° requote æ—¶é—´
        }
        s.lastQuoteAt = now
    }
}
```

**åŠ¨æ€ Requote**ï¼š
- é»˜è®¤ï¼š`RequoteMs`ï¼ˆå¦‚ 800msï¼‰
- ç»“ç®—å‰ 3 åˆ†é’Ÿï¼šåŠ é€Ÿåˆ° `baseLoopTickMs`ï¼ˆ200msï¼‰
- ç»“ç®—å‰ 5 åˆ†é’Ÿï¼šå‡åŠï¼ˆ400msï¼‰

#### æ­¥éª¤ 15ï¼šåŠ¨æ€ Profit é€‰æ‹©

ä½ç½®ï¼š`strategy.go:672-677`

```go
chosenProfit, chYesBidC, chNoBidC := s.chooseDynamicProfit(
    yesBidC, yesAskC, noBidC, noAskC, remainingSeconds)
if chosenProfit == 0 {
    return  // å½“å‰ç›˜å£æ— æ³•ç”¨ maker é”åˆ©
}
```

è¯¦è§ [å…³é”®å†³ç­–é€»è¾‘](#å…³é”®å†³ç­–é€»è¾‘) ç« èŠ‚ã€‚

#### æ­¥éª¤ 16ï¼šè®¡ç®—ç›®æ ‡ Shares

ä½ç½®ï¼š`strategy.go:679-694`

```go
costCents := 100 - chosenProfit
shares := targetNotional * 100.0 / float64(costCents)
```

**ç¤ºä¾‹**ï¼š
- `targetNotional = 800 USDC`
- `chosenProfit = 3 cents`
- `costCents = 100 - 3 = 97 cents`
- `shares = 800 * 100 / 97 â‰ˆ 824.74 shares`

#### æ­¥éª¤ 17ï¼šè®¡ç®—å‰©ä½™éœ€è¦æŒ‚å•çš„ Shares

ä½ç½®ï¼š`strategy.go:696-732`

```go
needUp := math.Max(0, shares - upShares)
needDown := math.Max(0, shares - downShares)
```

**å…³é”®ä¿®å¤**ï¼šç¡®ä¿åŒæ—¶ä¸‹ä¸¤è…¿ï¼Œé¿å…åªä¸‹ä¸€è…¿å¯¼è‡´è£¸éœ²é£é™©ã€‚

```go
// å¦‚æœå·²æœ‰è£¸éœ²ï¼Œåªå…è®¸è¡¥é½åˆ°å¯¹ä¾§ï¼Œä¸å†æ‰©å¤§æ€»è§„æ¨¡
if unhedged >= s.MinUnhedgedShares {
    if upShares > downShares {
        needUp = 0
    } else {
        needDown = 0
    }
} else {
    // å¦‚æœæ²¡æœ‰è£¸éœ²ï¼Œå¿…é¡»ç¡®ä¿åŒæ—¶ä¸‹ä¸¤è…¿
    if needUp > 0 && needDown == 0 {
        needDown = math.Max(s.MinUnhedgedShares, shares*0.1)
    } else if needDown > 0 && needUp == 0 {
        needUp = math.Max(s.MinUnhedgedShares, shares*0.1)
    }
}
```

#### æ­¥éª¤ 18ï¼šæ’¤æ‰æ—§æŒ‚å•

ä½ç½®ï¼š`strategy.go:750-757`

```go
if (needUp >= s.MinUnhedgedShares || needDown >= s.MinUnhedgedShares) && 
   (s.yesOrderID != "" || s.noOrderID != "") {
    if s.cancelMarketOrdersThrottled(ctx, now, m, false) {
        s.yesOrderID, s.noOrderID = "", ""
    }
}
```

**ç›®çš„**ï¼šé¿å…å¤šå•å †å ã€‚

#### æ­¥éª¤ 19ï¼šä¸‹ä¸¤è…¿ Maker è®¢å•

ä½ç½®ï¼š`strategy.go:759-822`

```go
yesPrice := domain.Price{Pips: chYesBidC * 100}
noPrice := domain.Price{Pips: chNoBidC * 100}

// å¹¶å‘ä¸‹å•ï¼Œé™ä½"å…ˆæˆäº¤ä¸€è…¿ã€å¦ä¸€è…¿æ¥ä¸åŠæŒ‚å‡º"çš„æ—¶é—´çª—
if needUpOK && needDownOK {
    var wg sync.WaitGroup
    wg.Add(2)
    go func() { defer wg.Done(); placeYes() }()
    go func() { defer wg.Done(); placeNo() }()
    wg.Wait()
}
```

**è®¢å•å‚æ•°**ï¼š
- `Side`: `SideBuy`ï¼ˆä¹°å…¥ï¼‰
- `OrderType`: `OrderTypeGTC`ï¼ˆGood Till Cancelï¼‰
- `Price`: åŠ¨æ€è®¡ç®—çš„ maker ä¹°ä»·
- `Size`: è®¡ç®—å‡ºçš„éœ€è¦æ•°é‡

---

## å…³é”®å†³ç­–é€»è¾‘

### 1. åŠ¨æ€ Profit é€‰æ‹©ç®—æ³•

ä½ç½®ï¼š`strategy.go:1344-1385`

**ç›®æ ‡**ï¼šåœ¨ `[ProfitMinCents, ProfitMaxCents]` èŒƒå›´å†…é€‰æ‹©æœ€ä¼˜ profitã€‚

**è¯„åˆ†å…¬å¼**ï¼š
```
score = profit - (distancePenaltyBps / 100) * maxDistanceCents
```

**å‚æ•°**ï¼š
- `profit`ï¼šé”åˆ©æ”¶ç›Šï¼ˆcentsï¼‰
- `distancePenaltyBps`ï¼šè·ç¦»æƒ©ç½šï¼ˆbasis pointsï¼Œé»˜è®¤ 30ï¼‰
- `maxDistanceCents`ï¼šä¸¤è…¿ä¸­ç¦» bestBid æ›´è¿œçš„ä¸€è…¿çš„è·ç¦»

**å°¾ç›˜è°ƒæ•´**ï¼š
- ç»“ç®—å‰ 3 åˆ†é’Ÿï¼š`penaltyPerCent *= 3.0`
- ç»“ç®—å‰ 5 åˆ†é’Ÿï¼š`penaltyPerCent *= 2.0`

**ç¤ºä¾‹**ï¼š
- `yesBidC = 45, yesAskC = 47`
- `noBidC = 52, noAskC = 54`
- å°è¯• `profit = 3`ï¼š
  - `targetSum = 100 - 3 = 97`
  - `chosenYesBidC = 45, chosenNoBidC = 52`
  - `maxDistance = 0`ï¼ˆéƒ½è´´ç€ bestBidï¼‰
  - `score = 3 - 0 = 3`
- å°è¯• `profit = 5`ï¼š
  - `targetSum = 95`
  - `chosenYesBidC = 45, chosenNoBidC = 50`
  - `maxDistance = 2`ï¼ˆNO è…¿ç¦» bestBid 2 centsï¼‰
  - `score = 5 - 0.3*2 = 4.4`
- **é€‰æ‹©**ï¼š`profit = 5`ï¼ˆscore æ›´é«˜ï¼‰

### 2. Maker è¡¥é½ä¸‰é˜¶æ®µç­–ç•¥

#### é˜¶æ®µ Aï¼šBestBid æŒ‚å•

**æ—¶é—´çª—å£**ï¼š`age < windowSec`ï¼ˆé»˜è®¤ 3 ç§’ï¼‰

**ä»·æ ¼**ï¼š`priceC = missingBidC`

**ç›®çš„**ï¼šä¼˜å…ˆç”¨ maker ä»·æ ¼è¡¥é½ï¼Œé¿å…åƒå•æˆæœ¬ã€‚

#### é˜¶æ®µ Bï¼šBump è¿½ä»·

**æ—¶é—´çª—å£**ï¼š`windowSec <= age < timeoutSec`

**ä»·æ ¼**ï¼š`priceC = missingBidC + bumpC`

**åŠ¨æ€è°ƒæ•´**ï¼š
- é»˜è®¤ï¼š`MakerSupplementBumpCents`ï¼ˆå¦‚ 1 centï¼‰
- ç»“ç®—å‰ 3 åˆ†é’Ÿï¼šè‡³å°‘ 2 cents
- æ¥è¿‘é¢„ç®—é˜ˆå€¼ï¼šè‡³å°‘ 1 cent

**çº¦æŸ**ï¼š`priceC < missingAskC`ï¼ˆä¿æŒ makerï¼‰

#### é˜¶æ®µ Cï¼šSnap to Ask-1

**è§¦å‘æ¡ä»¶**ï¼ˆä»»ä¸€æ»¡è¶³ï¼‰ï¼š
- Closeout çª—å£å†…ï¼ˆ`remainingSeconds <= 180`ï¼‰
- è·ç¦»è¶…æ—¶å¾ˆè¿‘ï¼ˆ`remain <= 1s`ï¼‰
- æ¥è¿‘é¢„ç®—ä¸Šé™ï¼ˆ`unhedged >= budget*0.9`ï¼‰

**ä»·æ ¼**ï¼š`priceC = missingAskC - 1`

**ç›®çš„**ï¼šæœ€æ¿€è¿›ä½†ä»ä¿æŒ makerï¼Œæé«˜æˆäº¤æ¦‚ç‡ã€‚

### 3. è¡¥é½ vs å›å¹³å†³ç­–

ä½ç½®ï¼š`strategy.go:594-615`

**è¡¥é½æ”¶ç›Š**ï¼š
```
completeProfitPerSetC = 100 - excessAvgC - missingAskC
completeProfitC = completeProfitPerSetC * size
```

**å›å¹³æ”¶ç›Š**ï¼š
```
flattenProfitC = (excessBidC - excessAvgC) * size
```

**å†³ç­–è§„åˆ™**ï¼š
1. å¦‚æœ `completeProfitPerSetC >= minProfit` æˆ– `force && completeProfitC >= flattenProfitC`ï¼Œå…è®¸è¡¥é½
2. å¦‚æœ `allowComplete && allowFlatten`ï¼Œé€‰æ‹©æ”¶ç›Šæ›´é«˜çš„æ–¹æ¡ˆ
3. å¦‚æœåªå…è®¸ä¸€ç§ï¼Œåˆ™æ‰§è¡Œè¯¥æ–¹æ¡ˆ

**ç¤ºä¾‹**ï¼š
- `excessAvgC = 45`ï¼ˆUP è…¿å¹³å‡æˆæœ¬ï¼‰
- `missingAskC = 53`ï¼ˆNO è…¿å–ä¸€ä»·ï¼‰
- `excessBidC = 47`ï¼ˆUP è…¿ä¹°ä¸€ä»·ï¼‰
- `size = 10 shares`
- `minProfit = 1 cent`

**è®¡ç®—**ï¼š
- `completeProfitPerSetC = 100 - 45 - 53 = 2 cents` âœ…
- `completeProfitC = 2 * 10 = 20 cents`
- `flattenProfitC = (47 - 45) * 10 = 20 cents`

**å†³ç­–**ï¼šä¸¤è€…æ”¶ç›Šç›¸åŒï¼Œä½†è¡¥é½èƒ½æ¶ˆé™¤æ–¹å‘é£é™©ï¼Œé€‰æ‹©è¡¥é½ã€‚

### 4. å°¾ç›˜åŠ¨æ€å‚æ•°è°ƒæ•´

#### Requote é¢‘ç‡

```go
if remainingSeconds <= 180 {
    ms = baseLoopTickMs()  // 200ms
} else if remainingSeconds <= 300 {
    ms = RequoteMs / 2     // 400ms
}
```

#### è¶…æ—¶æ—¶é—´

```go
if remainingSeconds <= EntryCutoffSeconds {
    timeout = 2  // Closeout çª—å£å†…ï¼š2 ç§’
} else if remainingSeconds <= 300 {
    timeout = 5  // ç»“ç®—å‰ 5 åˆ†é’Ÿï¼š5 ç§’
}
```

#### è£¸éœ²é¢„ç®—

```go
if remainingSeconds <= 180 {
    f = 0.25  // ç¼©å°åˆ° 25%
} else if remainingSeconds <= 300 {
    f = 0.5   // ç¼©å°åˆ° 50%
}
budget = MaxUnhedgedSharesBudget * f
```

---

## å®Œæ•´æ¨¡æ‹Ÿç¤ºä¾‹

### åœºæ™¯è®¾ç½®

- **å¸‚åœº**ï¼š`btc-updown-15m-1766684700`
- **å‘¨æœŸæ—¶é•¿**ï¼š900 ç§’ï¼ˆ15 åˆ†é’Ÿï¼‰
- **ä½™é¢**ï¼š1000 USDC
- **é…ç½®å‚æ•°**ï¼š
  - `BalanceAllocationPct = 0.8`
  - `ProfitMinCents = 1`
  - `ProfitMaxCents = 5`
  - `UnhedgedTimeoutSeconds = 10`
  - `EntryCutoffSeconds = 25`
  - `MaxSingleSideShares = 1000`
  - `MinUnhedgedShares = 1`

### æ—¶é—´çº¿æ¨¡æ‹Ÿ

#### T=0sï¼šå‘¨æœŸå¼€å§‹

**äº‹ä»¶**ï¼š`OnCycle()` å›è°ƒè§¦å‘

**æ‰§è¡Œ**ï¼š`resetCycle()`

**æ“ä½œ**ï¼š
1. æ¸…ç†æ—§çŠ¶æ€ï¼š`targetNotional = 0`, `yesOrderID = ""`, `noOrderID = ""`
2. åˆ·æ–°ä½™é¢ï¼š`bal = 1000 USDC`
3. è®¡ç®—ç›®æ ‡ï¼š`tn = max(30, 1000*0.8) = 800 USDC`
4. è®°å½•ï¼š`targetNotional = 800`, `cycleStartUnix = 1766684700`

**æ—¥å¿—**ï¼š
```
ğŸ”„ [cyclehedge] å‘¨æœŸé‡ç½®: market=btc-updown-15m-1766684700 start=1766684700 balance=1000.00 targetNotional=800.00 profitRange=[1,5]c
```

---

#### T=5sï¼šé¦–æ¬¡å»ºä»“

**äº‹ä»¶**ï¼šä»·æ ¼æ›´æ–°è§¦å‘ `step()`

**ç›˜å£çŠ¶æ€**ï¼š
- `yesBidC = 45, yesAskC = 47`
- `noBidC = 52, noAskC = 54`

**æ‰§è¡Œæµç¨‹**ï¼š

1. **åŠ¨æ€ Profit é€‰æ‹©**ï¼š
   - å°è¯• `profit = 1`ï¼š`targetSum = 99`, `chosenYesBidC = 45, chosenNoBidC = 54`ï¼ˆNO è…¿ç¦» bestBid 2 centsï¼‰
   - å°è¯• `profit = 2`ï¼š`targetSum = 98`, `chosenYesBidC = 45, chosenNoBidC = 53`ï¼ˆNO è…¿ç¦» bestBid 1 centï¼‰
   - å°è¯• `profit = 3`ï¼š`targetSum = 97`, `chosenYesBidC = 45, chosenNoBidC = 52`ï¼ˆéƒ½è´´ç€ bestBidï¼‰
   - **é€‰æ‹©**ï¼š`profit = 3`ï¼ˆscore æœ€é«˜ï¼‰

2. **è®¡ç®—ç›®æ ‡ Shares**ï¼š
   - `costCents = 100 - 3 = 97`
   - `shares = 800 * 100 / 97 â‰ˆ 824.74`

3. **è®¡ç®—éœ€è¦æ•°é‡**ï¼š
   - `upShares = 0, downShares = 0`
   - `needUp = 824.74, needDown = 824.74`

4. **ä¸‹ä¸¤è…¿è®¢å•**ï¼š
   - YESï¼š`Side=Buy, Price=45c, Size=824.74, Type=GTC`
   - NOï¼š`Side=Buy, Price=52c, Size=824.74, Type=GTC`

**è®°å½•**ï¼š
- `yesOrderID = "order_yes_001"`
- `noOrderID = "order_no_001"`
- `targetProfitCents = 3`
- `targetShares = 824.74`

**æ—¥å¿—**ï¼š
```
ğŸ“Œ [cyclehedge] quote: profit=3c cost=97c tn=800.00 shares=824.74 need(up=824.74 down=824.74) bids(yes=45c no=52c) ...
```

---

#### T=8sï¼šYES è…¿æˆäº¤

**äº‹ä»¶**ï¼š`OnOrderUpdate()` æ”¶åˆ°è®¢å•æ›´æ–°

**è®¢å•çŠ¶æ€**ï¼š
- YESï¼š`Status=Filled, FilledSize=824.74`
- NOï¼š`Status=Open, FilledSize=0`

**æŒä»“çŠ¶æ€**ï¼š
- `upShares = 824.74`
- `downShares = 0`
- `unhedged = 824.74`

**æ‰§è¡Œæµç¨‹**ï¼š

1. **æ£€æµ‹åˆ°è£¸éœ²**ï¼š`unhedged >= MinUnhedgedShares` âœ…
2. **è®°å½•é¦–æ¬¡æˆäº¤æ—¶é—´**ï¼š`firstFillAt = T=8s`
3. **æ’¤æ‰å¤šä½™è…¿æŒ‚å•**ï¼šå–æ¶ˆ NO è…¿è®¢å•ï¼ˆå¦‚æœè¿˜åœ¨æŒ‚å•ï¼‰
4. **è¿›å…¥ Maker è¡¥é½é˜¶æ®µ A**ï¼š
   - `age = 0s < windowSec(3s)` âœ…
   - `missingTok = TokenTypeDown`
   - `missingBidC = 52`
   - `priceC = 52`ï¼ˆbestBidï¼‰
   - `size = clampOrderSize(824.74) = 824.74`

5. **ä¸‹ Maker è¡¥é½å•**ï¼š
   - NOï¼š`Side=Buy, Price=52c, Size=824.74, Type=GTC`

**è®°å½•**ï¼š
- `noOrderID = "order_no_002"`
- `firstFillAt = T=8s`

**æ—¥å¿—**ï¼š
```
ğŸ“Œ [cyclehedge] unhedged->maker_supplement: missing=DOWN price=52c (bid=52c ask=54c bump=0c) size=824.74 age=0s rem=892s
```

---

#### T=10sï¼šMaker è¡¥é½é˜¶æ®µ A

**æŒä»“çŠ¶æ€**ï¼š
- `upShares = 824.74`
- `downShares = 0`
- `unhedged = 824.74`
- `age = 2s`

**æ‰§è¡Œ**ï¼š
- `age(2s) < windowSec(3s)` âœ…
- ç»§ç»­åœ¨ `missingBidC = 52c` æŒ‚å•
- æ— éœ€è°ƒæ•´ä»·æ ¼

---

#### T=13sï¼šMaker è¡¥é½é˜¶æ®µ Bï¼ˆè¿½ä»·ï¼‰

**æŒä»“çŠ¶æ€**ï¼š
- `upShares = 824.74`
- `downShares = 0`
- `unhedged = 824.74`
- `age = 5s`

**ç›˜å£å˜åŒ–**ï¼š
- `noBidC = 52, noAskC = 54`ï¼ˆæœªå˜ï¼‰

**æ‰§è¡Œæµç¨‹**ï¼š

1. **æ£€æµ‹é˜¶æ®µåˆ‡æ¢**ï¼š`age(5s) >= windowSec(3s)` âœ…
2. **è®¡ç®— Bump**ï¼š
   - `bumpC = MakerSupplementBumpCents = 1`
   - `priceC = 52 + 1 = 53`
3. **æ£€æŸ¥çº¦æŸ**ï¼š
   - `spreadC = 54 - 52 = 2`
   - `bumpCap = 2 - 1 = 1`
   - `bumpC <= bumpCap` âœ…
4. **è¿½ä»·**ï¼š
   - æ’¤æ‰æ—§å• `order_no_002`
   - ä¸‹æ–°å•ï¼š`Price=53c`ï¼ˆbid + 1ï¼‰

**è®°å½•**ï¼š
- `noOrderID = "order_no_003"`
- `lastSupplementAt = T=13s`

**æ—¥å¿—**ï¼š
```
ğŸ“Œ [cyclehedge] maker_supplement reprice: token=DOWN 52c->53c (bid=52c ask=54c bump=1c) orderID=order_no_003
```

---

#### T=18sï¼šè¶…æ—¶è§¦å‘ Taker è¡¥é½

**æŒä»“çŠ¶æ€**ï¼š
- `upShares = 824.74`
- `downShares = 0`
- `unhedged = 824.74`
- `age = 10s`

**ç›˜å£çŠ¶æ€**ï¼š
- `noBidC = 52, noAskC = 54`
- `yesBidC = 45`ï¼ˆUP è…¿ä¹°ä¸€ä»·ï¼‰

**æ‰§è¡Œæµç¨‹**ï¼š

1. **æ£€æµ‹è¶…æ—¶**ï¼š`age(10s) >= timeoutSec(10s)` âœ…
2. **è®¡ç®—å¹³å‡æˆæœ¬**ï¼š
   - `upAvgC = 45`ï¼ˆUP è…¿å¹³å‡æˆæœ¬ï¼‰
   - `downAvgC = 0`ï¼ˆNO è…¿æœªæŒä»“ï¼‰
3. **è®¡ç®—æ”¶ç›Š**ï¼š
   - `missingTok = TokenTypeDown`
   - `missingAskC = 54`
   - `excessAvgC = 45`
   - `completeProfitPerSetC = 100 - 45 - 54 = 1 cent` âœ…ï¼ˆæ»¡è¶³ `minProfit=1`ï¼‰
   - `completeProfitC = 1 * 824.74 = 824.74 cents`
4. **æ‰§è¡Œ Taker è¡¥é½**ï¼š
   - æ’¤æ‰ maker æŒ‚å• `order_no_003`
   - ä¸‹ FAK è®¢å•ï¼š`Side=Buy, Price=54c, Size=824.74, Type=FAK`

**ç»“æœ**ï¼š
- NO è…¿ç«‹å³æˆäº¤ï¼š`downShares = 824.74`
- ä¸¤è…¿å¹³è¡¡ï¼š`unhedged = 0`
- é”å®šæ”¶ç›Šï¼š`1 cent/share`

**è®°å½•**ï¼š
- `stats.TakerCompletes++`
- `firstFillAt` é‡ç½®ï¼ˆä¸‹æ¬¡è£¸éœ²æ—¶é‡æ–°è®¡æ—¶ï¼‰

**æ—¥å¿—**ï¼š
```
ğŸ“Œ [cyclehedge] unhedged->taker_complete(best): need=824.74 missing=DOWN ask=54c excessAvg=45c minProfit=1c estComplete=824.74c estFlatten=0c
```

---

#### T=20sï¼šä¸¤è…¿å¹³è¡¡ï¼Œç»§ç»­å»ºä»“

**æŒä»“çŠ¶æ€**ï¼š
- `upShares = 824.74`
- `downShares = 824.74`
- `minShares = 824.74`
- `unhedged = 0`

**ç›®æ ‡æ£€æŸ¥**ï¼š
- `targetShares = 824.74`
- `minShares(824.74) >= targetShares(824.74)` âœ…

**æ‰§è¡Œ**ï¼š
- æ’¤æ‰æ‰€æœ‰æŒ‚å•
- æŒæœ‰åˆ°ç»“ç®—

**æ—¥å¿—**ï¼š
```
ğŸ“Œ [cyclehedge] locked: profit=3c targetShares=824.74 got(up=824.74 down=824.74) src=ws
```

---

#### T=850sï¼šè¿›å…¥ Closeout çª—å£

**å‰©ä½™æ—¶é—´**ï¼š`remainingSeconds = 50s`

**æ‰§è¡Œæµç¨‹**ï¼š

1. **æ£€æµ‹ Closeout**ï¼š
   - `remainingSeconds(50s) <= EntryCutoffSeconds(25s)` âŒ
   - å®é™…ï¼š`remainingSeconds = 50s > 25s`ï¼Œè¿˜æœªè¿›å…¥ closeout
   - ç»§ç»­æ­£å¸¸äº¤æ˜“

2. **å‡è®¾ T=875s**ï¼ˆå‰©ä½™ 25 ç§’ï¼‰ï¼š
   - `inCloseout = true` âœ…
   - è®¾ç½® `closeoutActive = true`
   - æ‰§è¡Œä¸€æ¬¡æ’¤å•æ¸…åœº

**æ—¥å¿—**ï¼š
```
ğŸ“Œ [cyclehedge] closeout: cancel & pause entries
```

---

#### T=900sï¼šå‘¨æœŸç»“æŸ

**äº‹ä»¶**ï¼š`OnCycle()` å›è°ƒè§¦å‘ï¼ˆæ–°å‘¨æœŸå¼€å§‹ï¼‰

**æ‰§è¡Œæµç¨‹**ï¼š

1. **ç”Ÿæˆæ—§å‘¨æœŸæŠ¥è¡¨**ï¼š`finalizeAndReport()`

**æŠ¥è¡¨å†…å®¹**ï¼š
```json
{
  "strategy": "cyclehedge",
  "marketSlug": "btc-updown-15m-1766684700",
  "cycleStartUnix": 1766684700,
  "cycleEndUnix": 1766685600,
  "targetNotionalUSDC": 800.00,
  "targetShares": 824.74,
  "upShares": 824.74,
  "downShares": 824.74,
  "minShares": 824.74,
  "unhedgedShares": 0,
  "upAvgPrice": 0.45,
  "downAvgPrice": 0.54,
  "lockedProfitCentsPerShare": 1,
  "lockedProfitUSDC": 8.25,
  "quotes": 1,
  "ordersPlacedYes": 1,
  "ordersPlacedNo": 2,
  "cancels": 2,
  "takerCompletes": 1,
  "flattens": 0,
  "closeoutCancels": 1,
  "maxSingleSideStops": 0,
  "profitChoice": {"3c": 1},
  "lastChosenProfit": 3
}
```

2. **é‡ç½®æ–°å‘¨æœŸ**ï¼š`resetCycle()`

**ç»“ç®—æ”¶ç›Š**ï¼š
- æ¯å¥— complete-set ç»“ç®—å¾—åˆ° $1.00
- æ€»æˆæœ¬ï¼š`824.74 * (0.45 + 0.54) = 824.74 * 0.99 = 816.49 USDC`
- ç»“ç®—æ”¶å…¥ï¼š`824.74 * 1.00 = 824.74 USDC`
- **å‡€åˆ©æ¶¦**ï¼š`824.74 - 816.49 = 8.25 USDC`ï¼ˆçº¦ 1 cent/shareï¼‰

---

## é£é™©æ§åˆ¶æœºåˆ¶

### 1. æœ€å¤§å•å‘æŒä»“é™åˆ¶

**å‚æ•°**ï¼š`MaxSingleSideShares`

**æœºåˆ¶**ï¼š
- å½“ä»»ä¸€è¾¹æŒä»“ `>= MaxSingleSideShares` æ—¶ï¼š
  - åœæ­¢æ‰©å¤§ç›®æ ‡è§„æ¨¡
  - å¦‚æœæ²¡æœ‰è£¸éœ²ï¼Œæ’¤æ‰æŒ‚å•ï¼Œåœæ­¢æ–°å¢
  - å¦‚æœæœ‰è£¸éœ²ï¼Œç»§ç»­å…è®¸è¡¥é½/å›å¹³

**ç›®çš„**ï¼šé™åˆ¶å•è¾¹é£é™©ç´¯ç§¯ï¼Œé¿å…å¸‚åœºæç«¯æƒ…å†µä¸‹çš„è¿‡åº¦æš´éœ²ã€‚

### 2. è£¸éœ²è¶…æ—¶å’Œé¢„ç®—æ§åˆ¶

#### è¶…æ—¶æ§åˆ¶

**å‚æ•°**ï¼š`UnhedgedTimeoutSeconds`ï¼ˆé»˜è®¤ 10 ç§’ï¼‰

**åŠ¨æ€è°ƒæ•´**ï¼š
- Closeout çª—å£å†…ï¼šç¼©çŸ­åˆ° 2 ç§’
- ç»“ç®—å‰ 5 åˆ†é’Ÿï¼šç¼©çŸ­åˆ° 5 ç§’

**æœºåˆ¶**ï¼šè¶…è¿‡è¶…æ—¶æ—¶é—´ä»æœªè¡¥é½ï¼Œå¼ºåˆ¶å‡çº§åˆ° taker è¡¥é½æˆ–å›å¹³ã€‚

#### é¢„ç®—æ§åˆ¶

**å‚æ•°**ï¼š`MaxUnhedgedSharesBudget`

**åŠ¨æ€è°ƒæ•´**ï¼š
- ç»“ç®—å‰ 3 åˆ†é’Ÿï¼šç¼©å°åˆ° 25%
- ç»“ç®—å‰ 5 åˆ†é’Ÿï¼šç¼©å°åˆ° 50%

**æœºåˆ¶**ï¼šè¶…è¿‡é¢„ç®—æ—¶ï¼Œä¸ç­‰å¾…è¶…æ—¶ï¼Œç›´æ¥å‡çº§åˆ°æ›´æ¿€è¿›çš„è¡¥é½/å›å¹³è·¯å¾„ã€‚

### 3. Closeout çª—å£ä¿æŠ¤

**å‚æ•°**ï¼š`EntryCutoffSeconds`ï¼ˆé»˜è®¤ 25 ç§’ï¼‰

**æœºåˆ¶**ï¼š
- å‘¨æœŸç»“æŸå‰ `EntryCutoffSeconds` ç§’ï¼š
  - åœæ­¢æ–°å¢å»ºä»“/æŒ‚å•
  - æ’¤æ‰æœªæˆäº¤æŒ‚å•ï¼ˆåªæ‰§è¡Œä¸€æ¬¡ï¼‰
  - ä»å…è®¸è¡¥é½/å›å¹³è£¸éœ²ï¼ˆé¿å…ç»“ç®—é£é™©ï¼‰

**ç›®çš„**ï¼šç¬¦åˆ"å°¾ç›˜æ—¶é—´ä»·å€¼å˜åŒ–æ›´å¿«"çš„ç°å®ï¼Œé¿å…ç»§ç»­æ‰©å¼ é£é™©ã€‚

### 4. ç›˜å£è´¨é‡ Gate

**å‚æ•°**ï¼š
- `EnableMarketQualityGate`ï¼ˆé»˜è®¤ trueï¼‰
- `MarketQualityMinScore`ï¼ˆé»˜è®¤ 70ï¼‰
- `MarketQualityMaxSpreadCents`ï¼ˆé»˜è®¤ 5ï¼‰
- `MarketQualityMaxBookAgeMs`ï¼ˆé»˜è®¤ 3000ï¼‰

**æœºåˆ¶**ï¼š
- æ£€æŸ¥ç›˜å£è´¨é‡åˆ†æ•° `>= MarketQualityMinScore`
- æ£€æŸ¥ä»·å·® `<= MarketQualityMaxSpreadCents`
- æ£€æŸ¥è®¢å•ç°¿æ–°é²œåº¦ `<= MarketQualityMaxBookAgeMs`

**ç›®çš„**ï¼šé¿å…åœ¨ stale/wide spread/è„é•œåƒçš„ç›˜å£ä¸Šäº¤æ˜“ã€‚

### 5. è®¢å•å¤§å°é™åˆ¶

**å‚æ•°**ï¼š`MaxOrderSizeShares`ï¼ˆé»˜è®¤ 20ï¼‰

**æœºåˆ¶**ï¼šæ‰€æœ‰ä¸‹å•æ“ä½œï¼ˆå»ºä»“ã€è¡¥é½ã€å›å¹³ï¼‰éƒ½å—æ­¤é™åˆ¶ã€‚

**ç›®çš„**ï¼šé¿å…å•ç¬”è®¢å•è¿‡å¤§å¯¼è‡´çš„å¸‚åœºå†²å‡»ã€‚

### 6. èŠ‚æµæœºåˆ¶

#### æ’¤å•èŠ‚æµ

**æœ€å°é—´éš”**ï¼š2 ç§’

**ç›®çš„**ï¼šé¿å…é«˜é¢‘é‡å¤æ’¤å•å¯¼è‡´çŠ¶æ€ä¹±åº/åˆ·çˆ† APIã€‚

#### Requote èŠ‚æµ

**åŠ¨æ€é—´éš”**ï¼š
- é»˜è®¤ï¼š`RequoteMs`ï¼ˆå¦‚ 800msï¼‰
- ç»“ç®—å‰ 3 åˆ†é’Ÿï¼š200ms
- ç»“ç®—å‰ 5 åˆ†é’Ÿï¼š400ms

**ç›®çš„**ï¼šå°¾ç›˜åŠ é€ŸæŠ¥ä»·åˆ·æ–°ï¼Œæé«˜æˆäº¤æ¦‚ç‡ã€‚

#### è¡¥é½è¿½ä»·èŠ‚æµ

**åŠ¨æ€é—´éš”**ï¼š
- é»˜è®¤ï¼š700ms
- ç»“ç®—å‰ 3 åˆ†é’Ÿï¼š250ms
- ç»“ç®—å‰ 5 åˆ†é’Ÿï¼š400ms

**ç›®çš„**ï¼šé¿å… cancel+replace è¿‡äºé¢‘ç¹ã€‚

---

## å‘¨æœŸæŠ¥è¡¨

### finalizeAndReport() æ–¹æ³•

ä½ç½®ï¼š`report.go:50-120`

**è§¦å‘æ—¶æœº**ï¼šå‘¨æœŸç»“æŸæ—¶ï¼Œç”± `OnCycle()` è°ƒç”¨ã€‚

**æ‰§è¡Œæµç¨‹**ï¼š

1. **å¿«ç…§æŒä»“çŠ¶æ€**ï¼š
   ```go
   upPos, downPos := s.positionSnapshot(oldMarket.Slug)
   minShares := min(upPos.shares, downPos.shares)
   unhedged := abs(upPos.shares - downPos.shares)
   ```

2. **è®¡ç®—é”åˆ©ç»Ÿè®¡**ï¼š
   ```go
   if upPos.avg > 0 && downPos.avg > 0 && minShares > 0 {
       lockedProfitCents = 100 - int(upPos.avg*100+0.5) - int(downPos.avg*100+0.5)
       lockedProfitUSDC = minShares * float64(lockedProfitCents) / 100.0
   }
   ```

3. **æ„å»ºæŠ¥è¡¨å¯¹è±¡**ï¼š
   - å‘¨æœŸä¿¡æ¯ï¼š`MarketSlug`, `CycleStartUnix`, `CycleEndUnix`
   - ç›®æ ‡ä¿¡æ¯ï¼š`TargetNotionalUSDC`, `TargetShares`
   - æŒä»“å¿«ç…§ï¼š`UpShares`, `DownShares`, `MinShares`, `UnhedgedShares`
   - æˆæœ¬ä¿¡æ¯ï¼š`UpAvgPrice`, `DownAvgPrice`
   - é”åˆ©ç»Ÿè®¡ï¼š`LockedProfitCentsPerShare`, `LockedProfitUSDC`
   - æ“ä½œè®¡æ•°ï¼š`Quotes`, `OrdersPlacedYes`, `OrdersPlacedNo`, `Cancels`, `TakerCompletes`, `Flattens`, `CloseoutCancels`, `MaxSingleSideStops`
   - Profit é€‰æ‹©åˆ†å¸ƒï¼š`ProfitChoice`, `LastChosenProfit`

4. **å†™å…¥æ–‡ä»¶**ï¼š
   - **å•å‘¨æœŸ JSON**ï¼š`{ReportDir}/{MarketSlug}_{CycleStartUnix}.json`
   - **JSONL è¿½åŠ **ï¼š`{ReportDir}/report.jsonl`

### æŠ¥è¡¨ç¤ºä¾‹

```json
{
  "strategy": "cyclehedge",
  "marketSlug": "btc-updown-15m-1766684700",
  "cycleStartUnix": 1766684700,
  "cycleEndUnix": 1766685600,
  "generatedAtUnix": 1766685605,
  "targetNotionalUSDC": 800.00,
  "targetShares": 824.74,
  "upShares": 824.74,
  "downShares": 824.74,
  "minShares": 824.74,
  "unhedgedShares": 0,
  "upAvgPrice": 0.45,
  "downAvgPrice": 0.54,
  "lockedProfitCentsPerShare": 1,
  "lockedProfitUSDC": 8.25,
  "quotes": 1,
  "ordersPlacedYes": 1,
  "ordersPlacedNo": 2,
  "cancels": 2,
  "takerCompletes": 1,
  "flattens": 0,
  "closeoutCancels": 1,
  "maxSingleSideStops": 0,
  "profitChoice": {
    "3c": 1
  },
  "lastChosenProfit": 3
}
```

### æŠ¥è¡¨åˆ†æ

**å…³é”®æŒ‡æ ‡**ï¼š
- **é”åˆ©æ”¶ç›Š**ï¼š`lockedProfitUSDC = 8.25 USDC`ï¼ˆçº¦ 1.03% æ”¶ç›Šç‡ï¼‰
- **æ“ä½œæ•ˆç‡**ï¼š`quotes = 1`ï¼ˆ1 æ¬¡æŠ¥ä»·ï¼‰ï¼Œ`takerCompletes = 1`ï¼ˆ1 æ¬¡ taker è¡¥é½ï¼‰
- **é£é™©æ§åˆ¶**ï¼š`unhedgedShares = 0`ï¼ˆå‘¨æœŸç»“æŸæ—¶æ— è£¸éœ²ï¼‰ï¼Œ`maxSingleSideStops = 0`ï¼ˆæœªè§¦å‘å•è¾¹é™åˆ¶ï¼‰

---

## æ€»ç»“

CycleHedge ç­–ç•¥é€šè¿‡ä»¥ä¸‹æœºåˆ¶å®ç°ç¨³å®šé”åˆ©ï¼š

1. **Complete-Set åŸç†**ï¼šåŒæ—¶æŒæœ‰ç­‰é‡ YES/NOï¼Œé”å®šç¡®å®šæ”¶ç›Š
2. **Maker ä¼˜å…ˆ**ï¼šä¼˜å…ˆä½¿ç”¨æŒ‚å•ï¼Œé™ä½äº¤æ˜“æˆæœ¬
3. **è‡ªåŠ¨é£é™©æ§åˆ¶**ï¼šå•è…¿è£¸éœ²æ—¶è‡ªåŠ¨è¡¥é½æˆ–å›å¹³
4. **åŠ¨æ€è°ƒæ•´**ï¼šæ ¹æ®å‰©ä½™æ—¶é—´å’Œå¸‚åœºæƒ…å†µè°ƒæ•´å‚æ•°
5. **æ»šåŠ¨å¤åˆ©**ï¼šæŒ‰ä½™é¢æ¯”ä¾‹è‡ªåŠ¨æ”¾å¤§è§„æ¨¡

ç­–ç•¥çš„æ ¸å¿ƒä¼˜åŠ¿åœ¨äº**ç¡®å®šæ€§æ”¶ç›Š**å’Œ**è‡ªåŠ¨é£é™©æ§åˆ¶**ï¼Œé€‚åˆåœ¨æµåŠ¨æ€§è‰¯å¥½çš„å¸‚åœºä¸­ç¨³å®šè¿è¡Œã€‚
