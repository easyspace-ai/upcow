# CycleHedge 策略修复说明

## 🔧 修复内容

### 1. 增加signalC buffer大小

**问题**：
- signalC buffer太小（10），导致信号丢失
- 价格更新198,070次，但signalC只触发2次

**修复**：
```go
// strategy.go:115
// 修改前：
s.signalC = make(chan struct{}, 10)

// 修改后：
s.signalC = make(chan struct{}, 100)
```

**效果**：
- 减少信号丢失
- 提高step函数调用频率

---

### 2. 添加持仓更新日志

**问题**：
- Trade已创建，但持仓更新没有日志
- 无法确认持仓是否正常更新

**修复**：
```go
// order_engine.go:1103-1126
// 添加日志：
orderEngineLog.Infof("📈 [持仓更新] 买入: positionID=%s tokenType=%s oldSize=%.2f tradeSize=%.2f newSize=%.2f marketSlug=%s",
    positionID, tokenType, oldSize, trade.Size, position.Size, order.MarketSlug)
```

**效果**：
- 可以追踪持仓更新过程
- 确认持仓是否正常更新

---

### 3. 添加持仓查询日志

**问题**：
- currentShares()没有日志
- 无法确认持仓查询是否正常

**修复**：
```go
// strategy.go:1406-1420
// 添加详细日志：
log.Infof("🔍 [%s] currentShares: marketSlug=%s 查询到 %d 个持仓", ID, marketSlug, len(positions))
log.Infof("🔍 [%s] currentShares: 持仓 positionID=%s tokenType=%s size=%.2f marketSlug=%s", 
    ID, p.ID, p.TokenType, p.Size, p.MarketSlug)
log.Infof("🔍 [%s] currentShares: 结果 marketSlug=%s up=%.2f down=%.2f", ID, marketSlug, up, down)
```

**效果**：
- 可以追踪持仓查询过程
- 确认持仓查询是否正常
- 确认持仓值是否正确

---

### 4. 添加持仓ID生成日志

**问题**：
- positionID生成没有日志
- 无法确认positionID是否正确

**修复**：
```go
// order_engine.go:1137-1140
// 添加日志：
orderEngineLog.Debugf("🔍 [持仓ID] orderID=%s marketSlug=%s assetID=%s tokenType=%s positionID=%s",
    order.OrderID, order.MarketSlug, order.AssetID, order.TokenType, positionID)
```

**效果**：
- 可以追踪positionID生成过程
- 确认positionID是否正确

---

## 📋 预期效果

### 修复后应该看到：

1. **Step函数调用频率增加**：
   - signalC触发次数增加
   - step函数调用次数增加
   - 订单下单次数增加

2. **持仓更新日志**：
   - 买入/卖出时记录持仓更新日志
   - 可以看到持仓Size的变化
   - 可以确认持仓是否正常更新

3. **持仓查询日志**：
   - currentShares()调用时记录日志
   - 可以看到查询到的持仓数量
   - 可以看到每个持仓的详细信息
   - 可以看到最终的up/down值

4. **持仓值正常**：
   - Trade创建后，持仓应该更新
   - currentShares()应该能读取到持仓
   - 持仓值应该从0增长到目标值

---

## 🔍 下一步

1. **重新运行策略**：
   - 使用修复后的代码
   - 观察新的日志

2. **检查日志**：
   - 确认step函数调用频率
   - 确认持仓更新日志
   - 确认持仓查询日志

3. **验证修复**：
   - 确认持仓正常更新
   - 确认持仓正常查询
   - 确认订单数量增加

---

## 📝 注意事项

1. **日志量可能增加**：
   - 添加了更多日志
   - 可能需要调整日志级别

2. **性能影响**：
   - signalC buffer增加可能略微增加内存使用
   - 日志增加可能略微影响性能
   - 但影响应该很小

3. **继续观察**：
   - 修复后需要继续观察
   - 确认问题是否解决
   - 如果还有问题，继续调试
