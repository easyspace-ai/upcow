# 数据记录策略 - 数据未写入问题分析

## 问题描述

几期 CSV 文件都只有表头，没有数据行。文件内容如下：
```
timestamp,btc_target_price,btc_realtime_price,up_price,down_price
```

## 原因分析

根据代码逻辑，数据写入需要满足以下**所有条件**（`strategy.go:357-366`）：

1. ✅ **BTC 实时价格 > 0** (`btcRealtime > 0`)
2. ✅ **UP 价格 > 0** (`upPrice > 0`)
3. ✅ **DOWN 价格 > 0** (`downPrice > 0`)
4. ✅ **目标价已设置** (`btcTargetSet == true`)
5. ✅ **目标价 > 0** (`btcTarget > 0`)

如果任何一个条件不满足，数据就不会被记录。

## 可能的原因

### 1. 目标价获取失败（最可能）

**位置**：`strategy.go:317-327` 和 `target_price.go:37-70`

如果 `FetchTargetPrice` 失败，`btcTarget` 会被设置为 0，导致条件 5 不满足。

**可能的原因**：
- API 请求失败（网络问题、代理问题）
- Binance API 请求失败
- RTDS 连接失败（之前修复的问题）
- 所有备选方案都失败

**检查方法**：
查看日志中是否有以下警告：
```
获取目标价失败: ...
从 API 获取目标价失败: ...
从 Binance API 获取目标价失败: ...
从 RTDS 获取目标价失败: ...
```

### 2. BTC 实时价格未更新

**位置**：`strategy.go:152-180`

如果 RTDS 连接失败或订阅失败，`btcRealtimePrice` 可能一直是 0。

**可能的原因**：
- RTDS 连接失败（之前修复的问题）
- Chainlink 价格订阅失败
- 价格消息未收到

**检查方法**：
查看日志中是否有：
```
数据记录策略: RTDS 连接成功
数据记录策略: Chainlink BTC 价格订阅成功
💰 BTC 实时报价 (Chainlink): $...
```

### 3. UP/DOWN 价格未更新

**位置**：`strategy.go:339-344` 和 `event_loop.go:33-44`

如果价格事件没有正确触发，`upPrice` 或 `downPrice` 可能一直是 0。

**可能的原因**：
- 价格变化事件未触发
- 事件循环未启动
- 市场事件未正确订阅

**检查方法**：
查看日志中是否有价格变化事件。

### 4. 事件循环问题

**位置**：`event_loop.go:33-44`

在事件循环中，UP 和 DOWN 事件是分别处理的。如果只有一个事件到达，可能不会同时满足条件。

**注意**：这个逻辑本身是正确的，因为需要同时有 UP 和 DOWN 价格才能记录。

## 诊断步骤

### 1. 检查日志

查看日志文件，搜索以下关键词：
- `数据记录策略: 目标价未就绪`
- `数据记录策略: 价格未就绪`
- `获取目标价失败`
- `RTDS 连接`
- `Chainlink BTC 价格`

### 2. 检查价格状态

在代码中添加更详细的日志（已添加）：
- 将 `Debugf` 改为 `Warnf`，使日志更明显
- 记录所有价格状态，包括目标价设置状态

### 3. 检查目标价获取

查看 `target_price.go` 中的三个获取方法：
1. `fetchFromAPI` - Polymarket API
2. `fetchFromBinance` - Binance API
3. `fetchFromRTDS` - RTDS（目前不支持历史数据）

如果所有方法都失败，目标价会是 0。

## 解决方案

### 方案 1：改进错误处理和日志（已实施）

- ✅ 将关键日志从 `Debugf` 改为 `Warnf`
- ✅ 添加更详细的错误信息
- ✅ 记录所有价格状态

### 方案 2：添加降级策略

如果目标价获取失败，可以考虑：
- 使用上一个周期的目标价
- 使用当前 BTC 实时价格作为目标价（临时方案）
- 允许记录 0 值目标价（不推荐）

### 方案 3：改进目标价获取

- 增加重试机制
- 改进错误处理
- 添加更多备选数据源

### 方案 4：添加健康检查

定期检查价格状态，如果发现异常，记录警告日志。

## 建议的修复

1. **立即修复**：改进日志级别，使问题更容易发现
2. **短期修复**：添加目标价获取的重试机制
3. **长期修复**：实现目标价的降级策略，确保即使获取失败也能记录数据

## 验证方法

运行程序后，检查日志中是否有：
- ✅ `数据记录策略: 新周期已启动`
- ✅ `数据记录策略: 新周期 ...，目标价=... (已设置)`
- ✅ `💰 BTC 实时报价 (Chainlink): $...`
- ⚠️ `数据记录策略: 目标价未就绪` 或 `数据记录策略: 价格未就绪`

如果看到警告日志，说明某个条件不满足，需要进一步调查。

