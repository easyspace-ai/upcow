# 失败订单分析报告

## 问题描述
用户报告：开了一堆UP对冲单全没成交，损失惨重。

## 日志文件
- `logs/btc-updown-15m-1767117600.log` (8,854 行，1.7MB)
- 时间范围: 02:00:00 ~ 02:01:34

---

## 🔍 关键发现

### 1. 入场订单成功，但持仓不断累积

**入场订单（买DOWN）**：
- 02:00:25: 下单成功，买DOWN，价格59c，数量6.00
- 02:00:36: 下单成功，买DOWN，数量6.00
- 02:00:51: 下单成功，买DOWN，数量63.98
- 02:01:26: 下单成功，买DOWN，数量5.00

**持仓变化**：
- DOWN持仓: 6.00 → 12.31 → 18.31 → 82.29 → 284.29 → **289.29 shares**

**问题**：入场订单不断成交，持仓累积到289.29 shares，但**没有对应的对冲订单成交**。

---

### 2. 对冲订单创建失败（48次失败）

**失败原因分布**：
1. **Circuit Breaker 打开**: 大部分失败（从02:01:05开始）
2. **余额不足**: "not enough balance / allowance"（02:00:57 ~ 02:01:04）
3. **重复订单**: "duplicate in-flight"（02:00:53 ~ 02:00:55）

**时间线**：
- 02:00:36: 成功创建对冲订单 `0x149ea8b021055386e93743bc2afb5c508631b885c069b3408a1c0bf117691891` (买UP, 40c, 5.9999)
- 02:00:37: 成功创建对冲订单 `0x86fe0c87ac90600a08f4c21fa78ca06199e5fff9c425c7b757c995eda5879103` (买UP, 41c, 12.2926)
- 02:00:52: 成功创建对冲订单 `0x2ae5de7da6a7f2aa933f5bdb8ae541cd6909394c7d6b8ebaf52edfac893ac3f5` (买UP, 40c, 82.2749)
- 02:00:54: 成功创建对冲订单 `0x0a015b6d9030d6e753c7a6d11a72e9612594ca8b9c5328a377780d1a2cd4e9d8` (买UP, 40c, 82.2749)
- **02:00:53-02:00:55**: 重复订单错误（duplicate in-flight）
- **02:00:57-02:01:04**: 余额不足错误（not enough balance）
- **02:01:05开始**: Circuit Breaker 打开，所有对冲订单都无法创建

---

### 3. 关键问题分析

#### 问题1: 余额不足
```
02:00:57 ~ 02:01:04: "not enough balance / allowance"
```
- **原因**: 入场订单不断成交，消耗了USDC余额
- **影响**: 无法创建新的对冲订单
- **结果**: 持仓继续累积，风险增加

#### 问题2: Circuit Breaker 打开
```
02:01:05开始: "circuit breaker open"
```
- **原因**: 连续的错误（余额不足、重复订单等）触发了Circuit Breaker
- **影响**: 所有后续的对冲订单都无法创建
- **结果**: 289.29 shares DOWN持仓完全未对冲

#### 问题3: 重复订单
```
02:00:53 ~ 02:00:55: "duplicate in-flight"
```
- **原因**: 在已有对冲订单的情况下，又尝试创建新的对冲订单
- **影响**: 订单被拒绝，浪费了时间
- **结果**: 错过了最佳对冲时机

---

### 4. 订单状态分析

**成功的对冲订单**：
- `0x149ea8b021055386e93743bc2afb5c508631b885c069b3408a1c0bf117691891`: status=filled, filledSize=5.9999
- `0x1761dc93d4fc766d44b70e90a1caed640f9900c879a4b6b55d4e8d846b55b7a8`: status=filled, filledSize=5.0000

**失败的对冲订单**：
- `order_1767117660721579000`: status=failed, filledSize=0.0000
- `order_1767117664394031000`: status=failed, filledSize=0.0000

**问题**：
- 只有少量对冲订单成交（约11 shares）
- 但持仓累积到289.29 shares
- **对冲比例**: 11/289.29 = **3.8%**（严重不足）

---

## 🚨 根本原因

### 1. 入场订单成交太快，对冲订单跟不上
- 入场订单（FAK）立即成交
- 对冲订单（GTC限价单）需要等待成交
- 在等待期间，又有新的入场订单成交，持仓不断累积

### 2. 余额管理问题
- 入场订单消耗了USDC余额
- 没有预留足够的余额用于对冲订单
- 导致余额不足，无法创建对冲订单

### 3. Circuit Breaker 触发
- 连续的错误（余额不足、重复订单）触发了Circuit Breaker
- Circuit Breaker打开后，所有对冲订单都无法创建
- 导致大量未对冲持仓

### 4. 重复订单问题
- 在已有对冲订单的情况下，又尝试创建新的对冲订单
- 说明订单取消逻辑可能有问题，或者订单状态同步有问题

---

## 💡 解决方案

### 优先级1: 修复余额管理
1. **预留对冲余额**
   - 在创建入场订单前，检查是否有足够余额用于对冲
   - 或者限制入场订单数量，确保有余额用于对冲

2. **余额同步**
   - 实时更新余额，确保余额信息准确
   - 在余额不足时，停止创建新的入场订单

### 优先级2: 改进对冲订单逻辑
1. **立即对冲**
   - 入场订单成交后，立即尝试用FAK订单对冲（如果余额允许）
   - 而不是等待GTC限价单成交

2. **订单取消优化**
   - 确保在创建新对冲订单前，正确取消旧订单
   - 避免重复订单错误

### 优先级3: Circuit Breaker 优化
1. **余额不足不应触发Circuit Breaker**
   - 余额不足是业务逻辑问题，不是系统错误
   - 不应该计入错误计数

2. **重复订单不应触发Circuit Breaker**
   - 重复订单是预期的保护机制
   - 不应该计入错误计数

### 优先级4: 风险控制
1. **持仓限制**
   - 设置最大未对冲持仓限制
   - 超过限制时，停止创建新的入场订单

2. **强制平仓**
   - 当未对冲持仓过大时，考虑强制平仓
   - 避免损失进一步扩大

---

## 📊 损失估算

- **未对冲持仓**: 289.29 shares DOWN
- **对冲比例**: 约3.8%（11/289.29）
- **风险**: 如果DOWN价格下跌，将产生巨大损失

---

## 🎯 立即行动

1. **检查当前持仓**
   - 确认当前DOWN持仓数量
   - 检查是否有未成交的对冲订单

2. **手动对冲**
   - 如果可能，手动创建对冲订单
   - 或者手动平仓部分持仓

3. **修复代码**
   - 修复余额管理逻辑
   - 修复Circuit Breaker的错误分类
   - 改进对冲订单创建逻辑
