# 成对交易策略 (Paired Trading Strategy)

## 概述

成对交易策略是为 Polymarket 15分钟 BTC Up/Down 市场设计的新一代交易策略。与传统的网格策略不同，它不依赖固定的价格层级，而是基于**风险敞口实时计算**和**成对锁定机会识别**。

## 核心理念

### 1. 不再使用"网格"

**问题：**
- 网格策略依赖固定价格层级，过于被动
- 价格不到网格层级时策略无法执行
- 网格层级设置需要大量经验和调试

**新方法：**
- 实时监控 UP/DOWN 两个方向的利润状态
- 基于风险敞口动态决策
- 在任何价格下都能识别交易机会

### 2. 三阶段策略设计

#### 阶段1：快速建仓 (0-5分钟)
**目标：** 快速建立双边基础仓位
- 在价格较低时（< 0.60）快速买入
- 保持 UP/DOWN 持仓比例平衡（40%-60%）
- 避免单边过重

#### 阶段2：成对锁定 (5-10分钟)
**目标：** 识别并执行成对锁定交易，消除风险敞口
- **优先级1：** 消除负利润（风险对冲）
- **优先级2：** 利用极端价格锁定反向利润
- **优先级3：** 双边利润均衡
- **优先级4：** 提升利润到目标值

#### 阶段3：利润放大 (10-15分钟)
**目标：** 在已锁定基础上安全地放大利润
- **前提：** 必须已经完成锁定（两个方向利润都为正）
- 识别主方向（UP 或 DOWN）
- 在主方向加仓，同时买入少量反向保险

### 3. 关键优势

✅ **不依赖固定网格层级** - 可以在任何价格下识别机会  
✅ **风险驱动决策** - 关注风险敞口，而非价格位置  
✅ **清晰的三阶段目标** - 建仓 → 锁定 → 放大  
✅ **提前阶段切换** - 基于价格自动提前切换阶段  
✅ **保留成功经验** - 复用套利策略的利润计算和订单执行框架

## 配置说明

### 阶段控制参数

```yaml
paired_trading:
  # 阶段时间控制（秒）
  build_duration: 300       # 建仓阶段持续时间（5分钟）
  lock_start: 300           # 锁定阶段开始时间（5分钟）
  amplify_start: 600        # 放大阶段开始时间（10分钟）
  cycle_duration: 900       # 周期总时长（15分钟）
  
  # 提前切换阈值
  early_lock_price: 0.85    # 价格超过此值，提前进入锁定阶段
  early_amplify_price: 0.90 # 价格超过此值且已锁定，提前进入放大阶段
```

### 建仓参数（阶段1）

```yaml
  # 建仓参数
  base_target: 30.0         # 基础建仓目标（shares）
  build_lot_size: 3.0       # 单次建仓数量（shares）
  build_threshold: 0.60     # 建仓价格上限（只在价格低于此值时建仓）
  min_ratio: 0.40           # 最小持仓比例（避免单边过重）
  max_ratio: 0.60           # 最大持仓比例（避免单边过重）
```

**说明：**
- `base_target`: 每个方向的目标持仓量，适合40 USDC资金量
- `build_lot_size`: 单次下单量，避免一次性投入过多
- `build_threshold`: 只在价格较低时建仓，降低成本
- `min_ratio/max_ratio`: 保持双边平衡，避免单边风险

### 锁定参数（阶段2）

```yaml
  # 锁定参数
  lock_threshold: 5.0       # 触发锁定的风险阈值（USDC）
  lock_price_max: 0.70      # 锁定阶段最高买入价格
  extreme_high: 0.80        # 极端价格阈值
  target_profit_base: 2.0   # 目标利润（每个方向，USDC）
  insurance_size: 1.5       # 反向保险数量（shares）
```

**说明：**
- `lock_threshold`: 当某方向亏损超过5 USDC时，触发锁定
- `lock_price_max`: 锁定阶段不会在高价买入，避免成本过高
- `extreme_high`: 当价格超过0.80时，利用反向低价锁定
- `target_profit_base`: 每个方向目标利润2 USDC（适合40 USDC资金量，5%收益率）

### 放大参数（阶段3）

```yaml
  # 放大参数
  amplify_target: 5.0       # 放大目标利润（USDC）
  amplify_price_max: 0.85   # 放大阶段最高买入价格
  insurance_price_max: 0.20 # 反向保险最高价格
  direction_threshold: 0.70 # 主方向判定阈值
```

**说明：**
- `amplify_target`: 放大目标利润5 USDC（约12.5%收益率）
- `amplify_price_max`: 放大阶段可以接受更高价格
- `insurance_price_max`: 在极低价时买入反向保险
- `direction_threshold`: 价格超过0.70认为有明确方向

## 使用方法

### 1. 配置策略

编辑 `config.yaml`:

```yaml
strategies:
  enabled:
    - paired_trading
  
  paired_trading:
    # ... 参数配置 ...
```

### 2. 启动机器人

```bash
go run cmd/bot/main.go
```

### 3. 监控输出

策略会实时输出以下信息：

```
成对交易策略: 市场=btc-updown-15m-xxx, 阶段=Build, 锁定=✗ 未锁定, 已过时间=120s
  UP价格=0.5800, DOWN价格=0.4200
  QUp=15.0, QDown=14.5
  P_up=+1.20 USDC, P_down=-0.50 USDC

成对交易策略: [建仓阶段] 买入UP - 当前持仓=15.0 < 目标=30.0

成对交易策略: [锁定阶段] 检测到DOWN方向风险敞口（利润=-0.50），补充DOWN 2.5 shares

✅ 成对交易策略: 锁定完成！UP利润=+2.30 USDC, DOWN利润=+0.20 USDC

成对交易策略: [放大阶段] 放大UP利润（当前=2.30 → 目标=5.00）
```

## 关键指标说明

### 利润计算公式

```
P_up_win = Q_up × 1.0 - (C_up + C_down)     # UP胜利时的利润
P_down_win = Q_down × 1.0 - (C_up + C_down) # DOWN胜利时的利润
```

**理想状态：** `P_up_win > 0 AND P_down_win > 0` （完全锁定）

### 阶段判断

| 阶段 | 时间条件 | 价格条件（提前切换） | 目标 |
|------|---------|---------------------|------|
| **Build** | 0-5分钟 | - | 快速建仓 |
| **Lock** | 5-10分钟 | 价格 ≥ 0.85 | 成对锁定 |
| **Amplify** | 10-15分钟 | 价格 ≥ 0.90 且已锁定 | 利润放大 |

### 锁定状态

- **✗ 未锁定**: 至少有一个方向利润为负
- **✓ 已锁定**: 两个方向利润都为正

## 参数调优建议

### 小资金量（< 50 USDC）

```yaml
base_target: 30.0
build_lot_size: 3.0
target_profit_base: 2.0
amplify_target: 5.0
```

### 中等资金量（50-200 USDC）

```yaml
base_target: 100.0
build_lot_size: 10.0
target_profit_base: 5.0
amplify_target: 12.0
```

### 大资金量（> 200 USDC）

```yaml
base_target: 500.0
build_lot_size: 50.0
target_profit_base: 20.0
amplify_target: 50.0
```

## 风险提示

1. **锁定优先**: 阶段3必须在锁定完成后才执行放大，否则继续执行锁定
2. **价格保护**: 各阶段都有最高买入价格限制，避免在高价追单
3. **持仓平衡**: 始终保持 UP/DOWN 持仓比例平衡，避免单边风险
4. **滑点保护**: 设置 `max_buy_slippage_cents` 限制滑点损失

## 与其他策略的对比

| 特性 | 网格策略 | 套利策略 | **成对锁定策略** |
|------|---------|---------|-----------------|
| **核心思想** | 固定价格层级 | 时间分阶段 | **风险敞口驱动** |
| **触发机制** | 价格达到网格 | 时间+价格 | **实时风险计算** |
| **灵活性** | 低 | 中 | **高** |
| **锁定速度** | 慢 | 中 | **快** |
| **适应性** | 差 | 中 | **强** |
| **参数依赖** | 强 | 中 | **弱** |

## 总结

成对交易策略是一个**从"网格思维"转向"风险管理思维"**的新一代策略：

- ✅ 不是等价格来触发你
- ✅ 而是主动识别并抓住锁定机会
- ✅ 在安全（锁定）的基础上追求收益（放大）

这才是真正的"成对交易、对冲锁定"策略。
