# CycleHedge 策略日志分析报告
**分析时间**: 2025-12-30  
**日志文件**: btc-updown-15m-1767029400.log, btc-updown-15m-1767028500.log

## 📊 关键发现

### 1. 余额和targetNotional问题 ⚠️

**问题**：
- 配置的 `fixedNotionalUSDC: 50`
- 但实际 `targetNotional: 29.44`
- 实际余额：`29.44 USDC`

**原因**：
- 余额被限制到了29.44（可能是之前交易导致余额减少）
- 代码中的安全护栏：`if tn > cap { tn = cap }` 限制了targetNotional

**影响**：
- 目标shares从预期的52.08降到30.67
- 订单量无法达到配置的50 USDC

**解决方案**：
- ✅ 已修改纸交易模式初始余额为100 USDC
- ⚠️ 但当前日志显示余额仍是29.44，说明是之前运行的余额
- 💡 需要重新启动策略，使用新的100 USDC初始余额

---

### 2. Quote和订单执行情况 ✅

**最新周期 (1767029400)**：
- Quote次数：**1次**
- 需要继续下单：**3次**
- Requote节流：**0次** ✅（修复生效）

**Quote详情**：
```
tn=29.44 shares=30.67 needUp=10.00 needDown=10.00
```

**订单大小检查**：
- needUp=30.67 → clamp后=10.00 ✅
- needDown=30.67 → clamp后=10.00 ✅
- needUpOK=true ✅
- needDownOK=true ✅

**分析**：
- ✅ 订单大小检查修复生效（needUp > 0 就下单）
- ✅ Requote节流修复生效（没有requote节流阻止下单）
- ⚠️ 但只有1次quote，说明可能没有持续下单

---

### 3. 旧周期 (1767028500) 达成目标情况 ✅

**达成目标次数**：182次

**达成目标详情**：
```
locked: profit=4c targetShares=29.11 got(up=40.00 down=30.00)
```

**分析**：
- ✅ 旧周期成功达成目标
- ⚠️ 但持仓不平衡：up=40.00, down=30.00（有10 shares裸露）
- ⚠️ 目标shares=29.11，但实际up=40.00（超过目标）

---

### 4. 修复效果验证

#### ✅ 修复1：订单大小检查
- **修复前**：`needUp >= MinUnhedgedShares` 才下单
- **修复后**：`needUp > 0` 就下单
- **验证**：✅ 日志显示 `needUpOK=true` 当 `needUp=10.00`

#### ✅ 修复2：Requote节流
- **修复前**：requote节流在下单之前，阻止持续下单
- **修复后**：requote节流移到needUp/needDown计算之后，只在"不需要继续下单"时应用
- **验证**：✅ 日志显示 `需要继续下单` 3次，`requote节流` 0次

---

## 🔍 问题分析

### 问题1：余额不是100 USDC ⚠️

**现象**：
- 日志中没有找到余额初始化的信息
- 周期重置显示 `balance=29.44`

**可能原因**：
1. 日志文件不包含余额初始化信息（可能在更早的日志中）
2. 余额是之前交易后的余额（不是初始余额）
3. 策略没有重新启动，使用的是旧的余额

**解决方案**：
- 重新启动策略，确保使用新的100 USDC初始余额
- 检查日志中是否有 `📊 [余额初始化] 纸交易模式：设置初始余额为 100.00 USDC`

---

### 问题2：Quote次数太少 ⚠️

**现象**：
- 最新周期只有1次quote
- 但需要继续下单3次

**可能原因**：
1. 订单没有实际下单（可能被其他逻辑阻止）
2. 订单下单后没有触发新的quote（可能订单状态更新有问题）
3. step函数调用频率低（可能tick间隔太长）

**需要检查**：
- 是否有订单下单的日志
- 订单状态更新是否正常
- step函数调用频率

---

### 问题3：持仓不平衡 ⚠️

**现象**：
- 旧周期：`up=40.00 down=30.00`（有10 shares裸露）
- 目标：`targetShares=29.11`

**可能原因**：
1. 单腿成交导致不平衡
2. 补齐逻辑没有及时执行
3. 目标shares计算有问题

---

## 📋 建议

### 1. 立即行动
- ✅ 重新启动策略，使用新的100 USDC初始余额
- ✅ 观察日志中是否有 `📊 [余额初始化] 纸交易模式：设置初始余额为 100.00 USDC`
- ✅ 确认 `targetNotional=50.00`（而不是29.44）

### 2. 监控指标
- Quote次数：应该多次（每次下单后应该继续quote）
- 需要继续下单次数：应该持续增加直到达到目标
- Requote节流次数：应该为0（如果需要继续下单）
- 达成目标：应该显示 `minShares >= targetShares`

### 3. 进一步调试
- 检查订单下单日志（PlaceOrder相关）
- 检查订单状态更新（OnOrderUpdate相关）
- 检查step函数调用频率（tick间隔）

---

## 📊 统计摘要

| 指标 | 最新周期 (1767029400) | 旧周期 (1767028500) |
|------|---------------------|-------------------|
| targetNotional | 29.44 | 29.44 |
| targetShares | 30.67 | 29.11 |
| Quote次数 | 1 | 0 |
| 需要继续下单 | 3 | - |
| Requote节流 | 0 ✅ | - |
| 达成目标 | 0 | 182 ✅ |
| 持仓 (up/down) | - | 40.00/30.00 ⚠️ |

---

## 🎯 结论

### ✅ 修复生效
1. **订单大小检查修复**：✅ 生效（needUp > 0 就下单）
2. **Requote节流修复**：✅ 生效（没有requote节流阻止下单）

### ⚠️ 需要关注
1. **余额问题**：当前余额29.44，不是100（可能是旧余额）
2. **Quote次数少**：只有1次quote，可能需要检查订单执行逻辑
3. **持仓不平衡**：旧周期有10 shares裸露，需要检查补齐逻辑

### 💡 下一步
1. 重新启动策略，使用100 USDC初始余额
2. 观察新的日志，确认targetNotional=50
3. 监控Quote次数和订单执行情况
