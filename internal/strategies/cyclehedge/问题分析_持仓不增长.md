# CycleHedge 策略问题分析：持仓不增长

**分析时间**: 2025-12-30  
**日志文件**: btc-updown-15m-1767038400.log  
**问题**: 持仓一直停留在UP=20.00 DOWN=20.00，没有继续增长

## 📊 问题现象

### 持仓统计
- **持仓**: UP=20.00 DOWN=20.00（一直不变）
- **worstPnL**: 0.3000 USDC
- **targetWorst**: 90.0000 USDC
- **remainingSeconds**: 576s（不在closeout窗口）

### 订单统计
- **模拟下单**: 4次（都是filled）
- **Quote**: 1次
- **计算需要挂单**: 1次

### 目标检查
- **目标检查次数**: 1次（持仓为0时）
- **持仓为20.00时**: 没有目标检查日志

---

## 🔍 问题分析

### 问题1：目标检查缺失

**现象**：
- 持仓统计：39,286次
- 目标检查：只有1次（持仓为0时）
- 持仓为20.00时：没有目标检查日志

**分析**：
- 代码执行路径：持仓统计（line 543）→ closeout检查（line 548）→ maxSingleSide检查（line 551）→ 目标检查（line 601）
- 如果持仓统计之后没有目标检查，说明在line 544-600之间有提前返回

**可能原因**：
1. **closeout窗口提前返回**：
   - 如果`inCloseout=true`且`unhedged < MinUnhedgedShares(5)`
   - 代码会在line 548-551提前返回
   - 但remainingSeconds=576 > 180，不在closeout窗口

2. **maxSingleSideShares限制**：
   - 如果`maxShares >= MaxSingleSideShares(15)`
   - 代码会在line 551-565提前返回
   - 但持仓为20.00 > 15，可能触发限制

3. **其他条件**：
   - 可能有其他条件阻止目标检查

---

### 问题2：maxSingleSideShares限制

**配置**：
- `maxSingleSideShares: 15`

**持仓**：
- UP=20.00 DOWN=20.00
- maxShares = max(20.00, 20.00) = 20.00 > 15

**代码逻辑**（line 551-565）：
```go
if s.MaxSingleSideShares > 0 && maxShares >= s.MaxSingleSideShares {
    // 若没有裸露，撤掉挂单，避免继续被动成交扩大规模
    if unhedged < s.MinUnhedgedShares {
        _ = s.cancelMarketOrdersThrottled(ctx, now, m, false)
    }
    // 若没有裸露风险：直接停止本周期新增挂单/加仓（只持有到结算）
    if unhedged < s.MinUnhedgedShares {
        return  // ⚠️ 提前返回，不会执行到目标检查
    }
}
```

**分析**：
- maxShares=20.00 >= MaxSingleSideShares(15) ✅ 触发条件
- unhedged=0.00 < MinUnhedgedShares(5) ✅ 触发条件
- **代码会在line 562提前返回，不会执行到目标检查**

**这就是问题所在！**

---

## 💡 解决方案

### 方案1：调整maxSingleSideShares配置

**问题**：
- `maxSingleSideShares: 15` 太小
- 持仓为20.00时触发限制，停止下单

**解决**：
- 将`maxSingleSideShares`调整为更大的值（如100或更大）
- 或者根据`fixedNotionalUSDC=5000`计算合理的上限

**计算**：
- `fixedNotionalUSDC=5000`
- `targetShares=5208.33`（假设profit=4c，cost=96c）
- `maxSingleSideShares`应该 >= `targetShares`，建议设置为6000或更大

---

### 方案2：修改代码逻辑

**问题**：
- 当`maxShares >= MaxSingleSideShares`且`unhedged < MinUnhedgedShares`时，代码提前返回
- 但此时worstPnL可能还未达到targetWorst

**解决**：
- 修改代码逻辑，在提前返回前检查worstPnL是否达到targetWorst
- 如果未达到，继续执行目标检查

**代码修改**：
```go
if s.MaxSingleSideShares > 0 && maxShares >= s.MaxSingleSideShares {
    if unhedged < s.MinUnhedgedShares {
        _ = s.cancelMarketOrdersThrottled(ctx, now, m, false)
        // ⚠️ 修改：检查worstPnL是否达到targetWorst
        if worstCasePnLUSDC < targetWorst {
            // 未达到目标，继续执行目标检查
            // 不提前返回
        } else {
            // 已达到目标，可以提前返回
            return
        }
    }
}
```

---

## 📋 建议

### 立即修复

1. **调整配置**：
   - 将`maxSingleSideShares`从15调整为6000或更大
   - 确保不会因为持仓达到20.00就停止下单

2. **验证修复**：
   - 重新运行策略
   - 观察持仓是否继续增长
   - 观察目标检查日志是否正常

---

### 长期优化

1. **动态maxSingleSideShares**：
   - 根据`fixedNotionalUSDC`动态计算`maxSingleSideShares`
   - 确保不会因为配置限制导致提前停止

2. **改进代码逻辑**：
   - 在提前返回前检查worstPnL是否达到targetWorst
   - 如果未达到，继续执行目标检查

---

## 📝 总结

**根本原因**：
- `maxSingleSideShares: 15`配置太小
- 持仓为20.00时触发限制，代码在line 562提前返回
- 不会执行到目标检查，导致停止下单

**解决方案**：
- 将`maxSingleSideShares`调整为6000或更大
- 或者修改代码逻辑，在提前返回前检查worstPnL

**预期效果**：
- 持仓可以继续增长到目标shares（5208.33）
- 目标检查日志正常
- 订单继续下单
