# RTDS 连接稳定性说明

## 问题描述

RTDS WebSocket 连接可能出现不稳定的情况，表现为：
- 连接频繁断开和重连
- 连接状态显示"未连接"但仍在接收数据
- `readMessages panic recovered: repeated read on failed websocket connection`

## 原因分析

### 1. 读取超时设置过短（已修复）

**问题**：之前的代码将读取超时设置为 1 秒，导致频繁的超时检查。

**影响**：
- 每秒都会触发超时检查
- 频繁的超时可能导致连接状态检查出现问题
- 增加系统负载

**修复**：已将读取超时增加到 30 秒，减少频繁的超时检查。

### 2. WebSocket 连接特性

WebSocket 连接本身可能因为以下原因不稳定：
- **网络波动**：代理连接或网络延迟
- **服务器端限制**：RTDS 服务器可能有连接超时或限制
- **代理问题**：代理服务器可能不稳定或有限制

### 3. 连接状态检查时机

连接状态检查可能在以下时机出现问题：
- 读取超时时检查连接状态
- 重连过程中连接状态可能暂时显示为"未连接"
- 消息处理过程中连接断开

## 解决方案

### 已实施的改进

1. **增加读取超时时间**：从 1 秒增加到 30 秒
2. **改进超时处理**：超时时检查 context 和连接状态，但不立即断开
3. **自动重连机制**：连接断开后自动重连并重新订阅
4. **连接状态诊断**：添加详细的连接状态日志

### 建议的配置

```go
rtdsConfig := &rtds.ClientConfig{
    ReadTimeout:    60 * time.Second,  // 较长的读取超时
    PingInterval:   5 * time.Second,   // 定期发送 ping
    Reconnect:      true,               // 启用自动重连
    ReconnectDelay: 5 * time.Second,   // 重连延迟
    MaxReconnect:   10,                 // 最大重连次数
}
```

### 监控建议

1. **使用详细日志**：使用 `-verbose` 参数查看详细的连接状态
2. **监控重连频率**：如果重连过于频繁，可能需要检查网络或代理
3. **检查代理稳定性**：确保代理连接稳定

## 连接状态说明

### 正常情况

- 连接成功后会显示 "✅ RTDS 连接成功"
- 定期收到价格更新
- 连接状态检查显示"已连接"

### 异常情况

- **连接断开**：会显示 "RTDS 连接状态: 未连接"
- **自动重连**：会显示 "Attempting to reconnect (1/10)..."
- **重连成功**：会显示 "Reconnected successfully"

### 注意事项

- 连接状态检查是**定期检查**（每 30 秒），不是实时状态
- 即使显示"未连接"，如果正在重连，仍可能收到数据
- 自动重连机制会确保连接恢复

## 故障排查

如果连接持续不稳定：

1. **检查代理**：确保代理服务器正常运行
2. **检查网络**：测试网络连接是否稳定
3. **查看详细日志**：使用 `-verbose` 查看详细的连接和重连日志
4. **检查 RTDS 服务器状态**：可能是服务器端的问题

## 技术细节

### 读取超时机制

```go
// 设置 30 秒的读取超时
c.conn.SetReadDeadline(time.Now().Add(30 * time.Second))
_, data, err := c.conn.ReadMessage()

// 如果超时，检查 context 和连接状态
if netErr.Timeout() {
    // 检查 context 是否已取消
    // 检查连接状态
    // 如果一切正常，继续等待
    continue
}
```

### 自动重连机制

1. 检测到连接断开
2. 标记连接状态为"未连接"
3. 等待重连延迟（5 秒）
4. 尝试重新连接
5. 重新订阅所有活跃订阅
6. 重置重连计数

### Ping/Pong 机制

- 每 5 秒发送一次 Ping
- 用于保持连接活跃
- 如果 Ping 失败，触发重连

