# 日志分析报告 - 单边持仓严重问题

## 🔴 严重问题

### 问题描述
- **未对冲持仓**: `remaining=296.4117` shares（约 296 shares）
- **当前周期 Entry 订单**: 只有 1 个（6 shares）
- **持仓来源**: 被动成交（不是主动下单）

### 关键日志

1. **Entry 订单提交**（02:46:06）:
   ```
   Entry 订单已提交: orderID=0xb5511e85c724d581f06e9d848d8aa025cab929ce28f61182d271c80f4ed29213 
   side=down price=64c size=6.0000
   Entry 已成交并已挂 Hedge: filled=6.0000@64c hedgeID=0x64cd283118ffb9f8190023c71409d532738f15b5efdf501741275c43a8a5e737
   ```

2. **持仓被动增长**（02:46:24）:
   ```
   持仓更新 买入: tokenType=down oldSize=6.10 tradeSize=100.38 newSize=106.48
   持仓更新 买入: tokenType=down oldSize=106.48 tradeSize=202.00 newSize=308.48
   ```

3. **对冲订单失败**（02:46:26）:
   ```
   创建 hedge 订单失败: err=not enough balance / allowance
   price=33c size=296.4242
   ```

## 🔍 问题根源

### 1. **被动成交导致单边持仓累积**
- Entry 订单提交后，持仓通过被动成交（可能是其他交易者的订单）快速增长
- 从 6.10 → 106.48 → 308.48 shares
- 这些被动成交不是策略主动下单，但导致了单边持仓

### 2. **对冲订单因余额不足失败**
- 当系统尝试对冲 296 shares 时，余额不足
- 对冲订单创建失败：`not enough balance / allowance`
- 系统持续禁止开新单（正确行为），但无法完成对冲

### 3. **`manageExistingExposure` 检查时机问题**
- `manageExistingExposure` 在 Entry 订单提交前检查
- 但此时持仓可能还没有更新（Entry 订单刚提交，还未成交）
- 因此返回 `false`，允许开新单
- Entry 订单成交后，持仓才出现，但此时已无法阻止

## ✅ 已实施的修复

### 1. **容差阈值**
- 当 `remaining <= 0.1` shares 时，视为已基本对冲完成
- 避免因极小未对冲量而一直禁止开新单

### 2. **Entry 订单提交前检查未成交对冲订单**
- 在 Entry 订单提交前，检查是否有未成交的对冲订单
- 如果有，禁止开新单

### 3. **完全对冲检查**
- 检查持仓是否已对冲
- 检查是否有未成交的对冲订单
- 只有当持仓已对冲且所有对冲订单都已成交时，才允许开新单

## 🚨 当前问题

### 余额不足导致无法对冲
- 296 shares 的未对冲持仓需要约 `296 * 0.33 = 97.68 USDC` 来对冲
- 但账户余额不足，无法创建对冲订单
- 系统正确禁止开新单，但无法完成对冲

## 💡 建议

1. **增加余额检查**：
   - 在 Entry 订单提交前，检查余额是否足够同时提交 Entry 和 Hedge 订单
   - 如果余额不足，禁止开新单

2. **被动成交监控**：
   - 监控持仓变化，如果持仓被动增长，立即尝试对冲
   - 如果余额不足，考虑平仓部分持仓以释放资金

3. **持仓限制**：
   - 设置最大单边持仓限制
   - 超过限制时，强制平仓或禁止开新单
