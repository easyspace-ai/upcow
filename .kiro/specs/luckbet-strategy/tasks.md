# LuckBet 策略实施计划

## 实施说明

将 LuckBet 策略设计转换为一系列代码生成任务，每个任务都基于前面的任务构建，最终将所有组件整合在一起。专注于编写、修改或测试代码的任务。

- [x] 1. 建立项目结构和核心接口
  - 创建 `back/luckbet/` 目录结构，包含模型、服务、执行器和UI组件
  - 定义策略的核心接口，建立系统边界
  - 设置测试框架和基本的Go模块结构
  - _需求: 10.1_

- [x] 1.1 创建核心数据模型和类型定义
  - 编写 `types.go` 文件，定义 PriceSample、VelocityMetrics、TradingState 等核心数据结构
  - 实现配置结构体和验证函数
  - 定义错误类型和常量
  - _需求: 1.1, 2.1, 10.2_

- [x] 1.2 编写核心数据模型的属性测试
  - **属性 1: 速度计算一致性**
  - **验证需求: 1.1, 1.3**

- [x] 1.3 实现配置管理器
  - 编写 `config.go` 文件，实现配置加载、验证和默认值设置
  - 支持 YAML 配置文件解析和环境变量覆盖
  - 实现配置热重载机制
  - _需求: 10.2, 10.5_

- [ ] 1.4 编写配置管理器的单元测试
  - 测试配置验证逻辑
  - 测试默认值设置
  - 测试配置文件解析
  - _需求: 10.2_

- [ ] 2. 实现速度引擎核心逻辑
- [ ] 2.1 创建 VelocityEngine 结构体和基础方法
  - 编写 `velocity_engine.go` 文件，实现价格样本存储和管理
  - 实现 AddPriceSample 方法，支持线程安全的样本添加
  - 实现 PruneSamples 方法，自动清理过期样本
  - _需求: 1.1, 1.4_

- [ ] 2.2 编写样本管理的属性测试
  - **属性 3: 样本管理效率**
  - **验证需求: 1.4**

- [ ] 2.3 实现速度计算算法
  - 编写 CalculateVelocity 方法，使用线性回归或时间加权平均
  - 实现 CheckTriggerConditions 方法，检查速度阈值触发条件
  - 添加速度计算的数学验证和边界检查
  - _需求: 1.2, 1.3_

- [ ] 2.4 编写速度计算的属性测试
  - **属性 2: 阈值触发准确性**
  - **验证需求: 1.2**

- [ ] 2.5 集成外部数据源支持
  - 实现 Binance 数据集成，支持开盘蜡烛偏差过滤
  - 添加底层资产移动确认逻辑
  - 实现数据源故障时的优雅降级
  - _需求: 9.1, 9.2, 9.3_

- [ ] 2.6 编写外部数据集成的属性测试
  - **属性 12: 外部数据集成**
  - **验证需求: 9.1, 9.3, 9.4**

- [ ] 3. 实现订单执行器
- [ ] 3.1 创建 OrderExecutor 基础结构
  - 编写 `order_executor.go` 文件，定义执行模式和配置
  - 实现基础的订单创建和提交逻辑
  - 添加订单状态跟踪和回调处理
  - _需求: 2.1, 2.2, 5.1_

- [ ] 3.2 实现顺序执行模式
  - 编写 executeSequential 方法，先下 Entry 订单等待确认后再下 Hedge 订单
  - 实现订单状态轮询和超时处理
  - 添加 Entry 订单失败时的 Hedge 订单取消逻辑
  - _需求: 5.1, 5.3_

- [ ] 3.3 实现并行执行模式
  - 编写 executeParallel 方法，同时提交 Entry 和 Hedge 订单
  - 实现并发订单监控和状态同步
  - 添加订单关联和错误处理逻辑
  - _需求: 5.2_

- [ ] 3.4 编写订单执行的属性测试
  - **属性 4: 订单执行完整性**
  - **验证需求: 2.1, 2.2, 5.1, 5.2**

- [ ] 3.5 实现订单重试和超时机制
  - 编写对冲订单超时重下逻辑
  - 实现指数退避重试机制
  - 添加订单执行失败的错误分类和处理
  - _需求: 5.4, 5.5_

- [ ] 3.6 编写错误处理的属性测试
  - **属性 6: 错误处理鲁棒性**
  - **验证需求: 2.5, 5.3**

- [ ] 4. 实现风险控制器
- [ ] 4.1 创建 RiskController 核心逻辑
  - 编写 `risk_controller.go` 文件，实现交易限制和库存跟踪
  - 实现 CheckTradeAllowed 方法，验证交易是否被允许
  - 添加周期状态管理和重置逻辑
  - _需求: 4.1, 4.2_

- [ ] 4.2 实现市场质量过滤
  - 编写 CheckMarketQuality 方法，评估订单簿质量
  - 实现价差检查和数据新鲜度验证
  - 添加市场质量评分算法
  - _需求: 8.1, 8.2, 8.3_

- [ ] 4.3 编写风险控制的属性测试
  - **属性 8: 风险控制有效性**
  - **验证需求: 4.1, 4.2, 4.3, 8.1, 8.2**

- [ ] 4.4 实现时间保护机制
  - 编写周期结束保护逻辑，在周期结束前停止开新头寸
  - 实现库存平衡检查和自动补齐机制
  - 添加时间相关的风险控制
  - _需求: 4.4_

- [ ]* 4.5 编写时间保护的属性测试
  - **属性 9: 时间保护机制**
  - **验证需求: 4.4, 6.3**

- [ ] 5. 实现头寸管理器
- [ ] 5.1 创建 PositionManager 基础功能
  - 编写 `position_manager.go` 文件，实现头寸跟踪和状态管理
  - 实现 UpdatePositions 方法，同步头寸信息
  - 添加盈亏计算和统计功能
  - _需求: 6.1, 6.2_

- [ ] 5.2 实现退出策略逻辑
  - 编写 CheckExitConditions 方法，检查止盈、止损和时间止损条件
  - 实现 ExecuteExit 方法，执行头寸退出订单
  - 添加分批止盈和追踪止盈功能
  - _需求: 6.1, 6.2, 6.3, 6.5_

- [ ]* 5.3 编写退出策略的属性测试
  - **属性 10: 退出策略执行**
  - **验证需求: 6.1, 6.2, 6.4, 6.5**

- [ ] 5.4 实现价格计算和验证
  - 编写对冲价格计算逻辑，确保最小利润边际
  - 实现价格精度调整和订单簿验证
  - 添加结构性亏损防护机制
  - _需求: 2.3_

- [ ]* 5.5 编写价格计算的属性测试
  - **属性 5: 价格计算正确性**
  - **验证需求: 2.3**

- [ ] 6. 实现终端UI界面
- [ ] 6.1 创建 Bubbletea 基础模型
  - 编写 `terminal_ui.go` 文件，定义 dashboardModel 结构体
  - 实现 Init、Update、View 方法的基础框架
  - 添加键盘交互和窗口大小处理
  - _需求: 3.1, 3.5_

- [ ] 6.2 实现数据显示组件
  - 编写周期信息显示，包含市场名称和剩余时间倒计时
  - 实现价格和速度指标的实时显示
  - 添加头寸信息和库存平衡显示
  - _需求: 3.1, 3.2, 3.3_

- [ ] 6.3 实现盈亏计算和显示
  - 编写盈亏预测计算逻辑，显示 UP/DOWN 获胜情况
  - 实现实时成本和收益统计
  - 添加颜色编码和样式美化
  - _需求: 3.4_

- [ ]* 6.4 编写UI数据同步的属性测试
  - **属性 7: UI 数据同步性**
  - **验证需求: 3.2, 3.3, 3.4**

- [ ] 6.5 实现UI配置和性能优化
  - 添加UI启用/禁用配置支持
  - 实现数据更新频率控制和资源管理
  - 添加UI错误处理和优雅降级
  - _需求: 3.5_

- [ ] 7. 实现主策略协调器
- [ ] 7.1 创建主策略结构体
  - 编写 `strategy.go` 文件，定义 Strategy 主结构体
  - 实现 Initialize、Subscribe、Run 方法
  - 添加组件初始化和依赖注入逻辑
  - _需求: 10.1_

- [ ] 7.2 实现价格事件处理
  - 编写 OnPriceChanged 方法，处理价格变化事件
  - 集成速度引擎和风险控制器
  - 添加交易信号生成和执行逻辑
  - _需求: 1.1, 1.2, 2.1_

- [ ] 7.3 实现订单状态回调
  - 编写 OnOrderUpdate 方法，处理订单状态变化
  - 实现配对交易状态跟踪
  - 添加未对冲头寸检测和处理
  - _需求: 2.4, 2.5_

- [ ] 7.4 实现周期管理
  - 编写 OnCycle 方法，处理周期切换事件
  - 实现状态重置和统计更新
  - 添加周期性能指标计算
  - _需求: 7.4, 7.5_

- [ ]* 7.5 编写日志记录的属性测试
  - **属性 11: 日志记录完整性**
  - **验证需求: 7.1, 7.3, 7.4**

- [ ] 8. 集成测试和验证
- [ ] 8.1 创建集成测试套件
  - 编写端到端测试，验证完整的交易流程
  - 实现模拟市场数据和订单执行
  - 添加性能基准测试
  - _需求: 10.4_

- [ ] 8.2 实现配置文件和示例
  - 创建 `yml/luckbet.yaml` 配置文件模板
  - 编写配置文档和参数说明
  - 添加不同场景的配置示例
  - _需求: 10.2_

- [ ] 8.3 添加策略注册和启动逻辑
  - 在 `init()` 函数中注册策略到 bbgo 框架
  - 实现策略工厂和依赖注入
  - 添加启动诊断和健康检查
  - _需求: 10.1_

- [ ] 9. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

- [ ] 10. 文档和部署准备
- [ ] 10.1 创建用户文档
  - 编写 `README.md` 文件，包含策略说明和使用指南
  - 创建配置参数详细文档
  - 添加故障排除和常见问题解答
  - _需求: 10.5_

- [ ] 10.2 实现监控和日志
  - 添加结构化日志输出和性能指标收集
  - 实现日志限流和错误分类
  - 添加健康检查和状态报告端点
  - _需求: 7.1, 7.2, 7.3_

- [ ] 10.3 性能优化和最终验证
  - 进行内存使用和并发性能优化
  - 验证所有正确性属性和边界条件
  - 执行压力测试和稳定性验证
  - _需求: 10.1_

- [ ] 11. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户